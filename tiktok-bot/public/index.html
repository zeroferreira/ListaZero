<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero FM Bot Dashboard</title>
    <style>
        :root {
            --bg: #0f0f13;
            --card: #1a1a23;
            --primary: #ff0050; /* TikTok color */
            --text: #ffffff;
            --text-secondary: #a0a0a0;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        h1 { margin-bottom: 5px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 30px; }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input:focus { border-color: var(--primary); outline: none; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .toggle-row:last-child { border-bottom: none; }
        
        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .status {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .inline-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }
        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: #111;
            border: 1px solid #333;
        }
        .pill.ok { border-color: rgba(0, 200, 120, 0.6); color: rgba(0, 220, 140, 1); }
        .pill.bad { border-color: rgba(255, 60, 80, 0.6); color: rgba(255, 90, 110, 1); }
        .result-box {
            margin-top: 12px;
            background: #0b0b10;
            border: 1px solid #2b2b35;
            border-radius: 10px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.35;
            white-space: pre-wrap;
            word-break: break-word;
            color: #d7d7df;
            min-height: 54px;
        }
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .tab-btn {
            appearance: none;
            border: 1px solid #333;
            background: #111;
            color: #fff;
            padding: 10px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }
        .tab-btn.active {
            border-color: rgba(255, 0, 80, 0.75);
            box-shadow: 0 0 0 2px rgba(255, 0, 80, 0.12);
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 520px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéõÔ∏è Zero FM Bot Control</h1>
        <div class="subtitle">Configura tu bot de pedidos en tiempo real</div>

        <div class="tabs" role="tablist" aria-label="Secciones">
            <button class="tab-btn active" type="button" data-tab="general" role="tab" aria-selected="true">General</button>
            <button class="tab-btn" type="button" data-tab="permisos" role="tab" aria-selected="false">Permisos</button>
            <button class="tab-btn" type="button" data-tab="vip" role="tab" aria-selected="false">VIP (Regalos)</button>
            <button class="tab-btn" type="button" data-tab="prueba" role="tab" aria-selected="false">üß™ Prueba</button>
        </div>

        <div class="tab-panel active" data-panel="general" role="tabpanel">
            <div class="card">
                <div class="form-group">
                    <label>Usuario de TikTok (Live)</label>
                    <input type="text" id="tiktokUsername" placeholder="@usuario">
                </div>
                <div class="inline-status">
                    <div id="ciderPill" class="pill">Cider: ...</div>
                    <div id="tiktokPill" class="pill">TikTok: ...</div>
                </div>
            </div>
        </div>

        <div class="tab-panel" data-panel="permisos" role="tabpanel">
            <div class="card">
                <h3>Permisos de Pedido</h3>
                <div class="toggle-row">
                    <span>Requerir Monedas/Donaciones (!sr)</span>
                    <label class="switch">
                        <input type="checkbox" id="requireVipForSr" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="inline-status" style="margin-top: 5px;">
                    <small>Si est√° activado, solo los usuarios que hayan donado (VIP) podr√°n pedir canciones.</small>
                </div>

                <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                    <label>Comandos Personalizados (separados por coma)</label>
                    <input type="text" id="commandAliases" placeholder="!sr, !pedir, !cancion">
                    <small style="color: #666; display: block; margin-top: 5px;">Ejemplo: !sr, !p, !musica. Deja vac√≠o para usar los predeterminados.</small>
                </div>
                
                <h4 style="margin-top: 20px;">Excepciones (siempre permitidos)</h4>
                <div class="toggle-row">
                    <span>Permitir Suscriptores</span>
                    <label class="switch">
                        <input type="checkbox" id="allowSubscribers">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Permitir Moderadores</span>
                    <label class="switch">
                        <input type="checkbox" id="allowModerators">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Permitir Super Fans (Nivel > 0)</span>
                    <label class="switch">
                        <input type="checkbox" id="allowSuperFans">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="tab-panel" data-panel="vip" role="tabpanel">
            <div class="card">
                <h3>Regalos VIP</h3>
                <div class="form-group">
                    <label>Monedas m√≠nimas para VIP (Sesi√≥n completa)</label>
                    <input type="number" id="minCoinsForVip" value="30">
                    <small style="color: #666; display: block; margin-top: 5px;">Cualquier regalo con este valor o superior otorgar√° permisos VIP hasta reiniciar el bot.</small>
                </div>
            </div>
        </div>

        <div class="tab-panel" data-panel="prueba" role="tabpanel">
            <div class="card">
                <h3>üß™ Prueba Offline</h3>
                <div class="toggle-row" style="border-bottom:none; padding-bottom: 0;">
                    <span>Modo</span>
                </div>
                <div class="toggle-row" style="border-bottom:none; padding-top: 8px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="radio" name="testMode" id="testModeManual" checked>
                        <span>Manual (respeta artista/canci√≥n)</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="radio" name="testMode" id="testModeSearch">
                        <span>B√∫squeda (!sr / iTunes)</span>
                    </label>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Usuario</label>
                        <input type="text" id="testUser" value="Prueba" placeholder="Nombre">
                    </div>
                    <div class="form-group">
                        <label>Apple Music ID (opcional)</label>
                        <input type="text" id="testAppleMusicId" placeholder="Ej: 1647492502">
                    </div>
                </div>

                <div id="testManualFields" class="grid-2">
                    <div class="form-group">
                        <label>Artista</label>
                        <input type="text" id="testArtist" placeholder="Ej: Bad Bunny">
                    </div>
                    <div class="form-group">
                        <label>Canci√≥n</label>
                        <input type="text" id="testSong" placeholder="Ej: MONACO">
                    </div>
                </div>

                <div id="testSearchFields" style="display:none;">
                    <div class="form-group">
                        <label>Mensaje o b√∫squeda</label>
                        <input type="text" id="testMessage" placeholder="Ej: !sr bad bunny titi me pregunto">
                    </div>
                </div>

                <div class="toggle-row">
                    <span>Enviar a Cider</span>
                    <label class="switch">
                        <input type="checkbox" id="testSendToCider" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Guardar en Cola (Firestore)</span>
                    <label class="switch">
                        <input type="checkbox" id="testSendToQueue">
                        <span class="slider"></span>
                    </label>
                </div>

                <button class="btn" style="margin-top: 16px;" onclick="sendOfflineTest()">üöÄ Enviar Prueba</button>
                <div id="testResult" class="result-box"></div>

                <div style="margin-top: 18px; border-top: 1px solid #333; padding-top: 16px;">
                    <h3>üß™ Mock Cider (Offline)</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Cider URL</label>
                            <input type="text" id="ciderUrl" placeholder="http://localhost:10767">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <div class="inline-status" style="margin-top: 0;">
                                <div id="mockCiderPill" class="pill">Mock: ...</div>
                                <div id="mockQueuePill" class="pill">Cola: ...</div>
                            </div>
                        </div>
                    </div>

                    <div class="toggle-row">
                        <span>Iniciar/Detener Mock Cider</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn" type="button" onclick="startMockCider()" style="width:auto; padding: 10px 14px;">Iniciar</button>
                            <button class="btn" type="button" onclick="stopMockCider()" style="width:auto; padding: 10px 14px; background:#222; border:1px solid #333;">Detener</button>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top: 10px;">
                        <div class="form-group">
                            <label>Usuario (requester)</label>
                            <input type="text" id="mockRequester" placeholder="Ej: Zero">
                        </div>
                        <div class="form-group">
                            <label>Apple Music ID (opcional)</label>
                            <input type="text" id="mockAppleMusicId" placeholder="Ej: 1647492502">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Artista</label>
                            <input type="text" id="mockArtist" placeholder="Ej: Bad Bunny">
                        </div>
                        <div class="form-group">
                            <label>Canci√≥n</label>
                            <input type="text" id="mockSong" placeholder="Ej: MONACO">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn" type="button" onclick="emitMockNowPlaying()" style="width:auto; padding: 12px 14px;">üéµ Emitir Now Playing</button>
                        <button class="btn" type="button" onclick="playMockNext()" style="width:auto; padding: 12px 14px; background:#222; border:1px solid #333;">‚è≠Ô∏è Play Next (de la cola)</button>
                        <button class="btn" type="button" onclick="clearMockQueue()" style="width:auto; padding: 12px 14px; background:#222; border:1px solid #333;">üßπ Limpiar</button>
                    </div>

                    <div id="mockResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <button class="btn" onclick="saveConfig()">üíæ Guardar Cambios</button>
        <div id="status" class="status">‚úÖ Configuraci√≥n guardada correctamente</div>
    </div>

    <script>
        (function initTabs(){
            const tabs = Array.from(document.querySelectorAll('.tab-btn'));
            const panels = Array.from(document.querySelectorAll('.tab-panel'));
            function activate(tabName) {
                tabs.forEach(t => {
                    const isActive = t.getAttribute('data-tab') === tabName;
                    t.classList.toggle('active', isActive);
                    t.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });
                panels.forEach(p => {
                    p.classList.toggle('active', p.getAttribute('data-panel') === tabName);
                });
            }
            tabs.forEach(t => t.addEventListener('click', () => activate(t.getAttribute('data-tab'))));
            activate('general');
        })();

        (function initTestMode(){
            const manual = document.getElementById('testModeManual');
            const search = document.getElementById('testModeSearch');
            const manualFields = document.getElementById('testManualFields');
            const searchFields = document.getElementById('testSearchFields');
            function update() {
                const isManual = !!(manual && manual.checked);
                if (manualFields) manualFields.style.display = isManual ? '' : 'none';
                if (searchFields) searchFields.style.display = isManual ? 'none' : '';
            }
            if (manual) manual.addEventListener('change', update);
            if (search) search.addEventListener('change', update);
            update();
        })();

        // Cargar configuraci√≥n al iniciar
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                document.getElementById('tiktokUsername').value = data.tiktokUsername;
                document.getElementById('minCoinsForVip').value = data.minCoinsForVip;
                document.getElementById('requireVipForSr').checked = data.requireVipForSr !== false;
                document.getElementById('ciderUrl').value = data.ciderUrl || 'http://localhost:10767';
                document.getElementById('allowSubscribers').checked = data.allowSubscribers;
                document.getElementById('allowModerators').checked = data.allowModerators;
                document.getElementById('allowSuperFans').checked = data.allowSuperFans;
                
                // Comandos
                const cmds = Array.isArray(data.commandAliases) ? data.commandAliases.join(', ') : '';
                document.getElementById('commandAliases').value = cmds || '!sr, !pedir, !cancion';
            });

        async function refreshStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const ciderPill = document.getElementById('ciderPill');
                const tiktokPill = document.getElementById('tiktokPill');
                const mockCiderPill = document.getElementById('mockCiderPill');
                const mockQueuePill = document.getElementById('mockQueuePill');

                const ciderOk = !!data.ciderConnected;
                ciderPill.textContent = `Cider: ${ciderOk ? 'Conectado' : 'No conectado'}`;
                ciderPill.className = `pill ${ciderOk ? 'ok' : 'bad'}`;

                const tkState = data.tiktokState || 'unknown';
                const connecting = !!data.isConnecting;
                tiktokPill.textContent = `TikTok: ${connecting ? 'Conectando...' : tkState}`;
                tiktokPill.className = `pill ${tkState === 'connected' ? 'ok' : ''}`;

                if (mockCiderPill) {
                    const mockOk = !!data.mockCiderActive;
                    mockCiderPill.textContent = `Mock: ${mockOk ? ('Activo :' + (data.mockCiderPort || '')) : 'Inactivo'}`;
                    mockCiderPill.className = `pill ${mockOk ? 'ok' : 'bad'}`;
                }
                if (mockQueuePill) {
                    try {
                        const r2 = await fetch('/api/mockcider/status');
                        const d2 = await r2.json();
                        const n = Number(d2.queueLength || 0) || 0;
                        mockQueuePill.textContent = `Cola: ${n}`;
                    } catch (_) {
                        mockQueuePill.textContent = `Cola: ?`;
                    }
                }
            } catch (_) {}
        }

        setInterval(refreshStatus, 1500);
        refreshStatus();

        function saveConfig() {
            const cmdVal = document.getElementById('commandAliases').value;
            const commandAliases = cmdVal.split(',').map(s => s.trim()).filter(Boolean);

            const config = {
                tiktokUsername: document.getElementById('tiktokUsername').value,
                minCoinsForVip: parseInt(document.getElementById('minCoinsForVip').value),
                requireVipForSr: document.getElementById('requireVipForSr').checked,
                allowSubscribers: document.getElementById('allowSubscribers').checked,
                allowModerators: document.getElementById('allowModerators').checked,
                allowSuperFans: document.getElementById('allowSuperFans').checked,
                ciderUrl: document.getElementById('ciderUrl')?.value || "http://localhost:10767",
                commandAliases: commandAliases.length > 0 ? commandAliases : ["!sr", "!pedir", "!cancion"]
            };

            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById('status');
                status.style.opacity = '1';
                setTimeout(() => status.style.opacity = '0', 3000);
            })
            .catch(err => alert('Error al guardar'));
        }

        async function sendOfflineTest() {
            const resultEl = document.getElementById('testResult');
            resultEl.textContent = 'Enviando...';
            try {
                const isManual = !!document.getElementById('testModeManual')?.checked;
                const payload = {
                    user: document.getElementById('testUser').value,
                    message: isManual ? '' : (document.getElementById('testMessage')?.value || ''),
                    appleMusicId: document.getElementById('testAppleMusicId').value,
                    songName: isManual ? (document.getElementById('testSong')?.value || '') : '',
                    artistName: isManual ? (document.getElementById('testArtist')?.value || '') : '',
                    sendToCider: document.getElementById('testSendToCider').checked,
                    sendToQueue: document.getElementById('testSendToQueue').checked
                };
                const res = await fetch('/api/test/sr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    resultEl.textContent = `Error: ${data.error || 'No se pudo ejecutar la prueba'}`;
                    return;
                }
                const r = data.result || {};
                const lines = [];
                lines.push(`OK: ${r.ok ? 's√≠' : 'no'}`);
                if (r.track) {
                    lines.push(`Track: ${r.track.songName || ''}${r.track.artistName ? ' ‚Äî ' + r.track.artistName : ''}`);
                    if (r.track.appleMusicId) lines.push(`AppleMusicId: ${r.track.appleMusicId}`);
                }
                lines.push(`Cider conectado: ${r.ciderConnected ? 's√≠' : 'no'}`);
                lines.push(`Cider enviado: ${r.ciderSent ? 's√≠' : 'no'}`);
                lines.push(`Guardar en cola: ${r.sendToQueue ? 's√≠' : 'no'}`);
                if (r.queueSaved) lines.push(`Cola guardada: s√≠${r.queueDocId ? ' (doc ' + r.queueDocId + ')' : ''}`);
                resultEl.textContent = lines.join('\n');
            } catch (e) {
                resultEl.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }

        async function startMockCider() {
            const out = document.getElementById('mockResult');
            if (out) out.textContent = 'Iniciando Mock Cider...';
            try {
                const res = await fetch('/api/mockcider/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    if (out) out.textContent = `Error: ${data.error || 'No se pudo iniciar'}`;
                    return;
                }
                if (out) out.textContent = `OK: Mock Cider iniciado en puerto ${data.port}`;
            } catch (e) {
                if (out) out.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }

        async function stopMockCider() {
            const out = document.getElementById('mockResult');
            if (out) out.textContent = 'Deteniendo Mock Cider...';
            try {
                const res = await fetch('/api/mockcider/stop', { method: 'POST' });
                const data = await res.json();
                if (out) out.textContent = data && data.ok ? 'OK: Mock detenido' : 'Error al detener';
            } catch (e) {
                if (out) out.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }

        function getOrFallback(id, fallbackId) {
            const v = document.getElementById(id)?.value;
            if (v && String(v).trim()) return String(v).trim();
            const f = document.getElementById(fallbackId)?.value;
            if (f && String(f).trim()) return String(f).trim();
            return '';
        }

        async function emitMockNowPlaying() {
            const out = document.getElementById('mockResult');
            if (out) out.textContent = 'Emitiendo Now Playing...';
            try {
                const payload = {
                    requester: getOrFallback('mockRequester', 'testUser'),
                    artistName: getOrFallback('mockArtist', 'testArtist'),
                    songName: getOrFallback('mockSong', 'testSong'),
                    appleMusicId: getOrFallback('mockAppleMusicId', 'testAppleMusicId')
                };
                const res = await fetch('/api/mockcider/emit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    if (out) out.textContent = `Error: ${data.error || 'No se pudo emitir'}`;
                    return;
                }
                if (out) out.textContent = `OK: Now Playing emitido\n${payload.songName} ‚Äî ${payload.artistName}\nRequester: ${payload.requester || 'N/D'}`;
            } catch (e) {
                if (out) out.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }

        async function playMockNext() {
            const out = document.getElementById('mockResult');
            if (out) out.textContent = 'Reproduciendo next...';
            try {
                const res = await fetch('/api/mockcider/play-next', { method: 'POST' });
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    if (out) out.textContent = `Error: ${data.error || 'No hay next'}`;
                    return;
                }
                const p = data.played || {};
                if (out) out.textContent = `OK: Reproduciendo\n${p.name || ''} ‚Äî ${p.artistName || ''}\nRequester: ${p.requester || 'N/D'}`;
            } catch (e) {
                if (out) out.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }

        async function clearMockQueue() {
            const out = document.getElementById('mockResult');
            if (out) out.textContent = 'Limpiando...';
            try {
                const res = await fetch('/api/mockcider/clear', { method: 'POST' });
                const data = await res.json();
                if (out) out.textContent = data && data.ok ? 'OK: Cola limpiada' : 'Error al limpiar';
            } catch (e) {
                if (out) out.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
            } finally {
                refreshStatus();
            }
        }
    </script>
</body>
</html>
