<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Overlay Pedidos - Zero FM</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');

    :root {
      --card-width: 400px;
      --card-bg-color: rgba(0, 0, 0, 0.85);
      --accent-color: #ff0055;
      --icon-bg-color: rgba(255, 255, 255, 0.2);
      --icon-content: '';
      --icon-circle-size: 50px;
      --icon-font-size: 25px;
      --text-color: #ffffff;
      --font-family: 'Montserrat', sans-serif;
      --font-size-base: 16px;
      --font-size-header: 14px;
      --font-size-song: 24px;
      --font-size-artist: 16px;
      --font-size-user: 12px;
      --card-min-height: 100px;
      --card-border-radius: 8px;
      --sep-color: rgba(255,255,255,0.1);
      --sep-width: 1px;
      --sep-style: solid;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: transparent; /* Importante para OBS */
      overflow: hidden;
      font-family: var(--font-family);
      height: 100vh;
      display: flex;
      align-items: center; /* Centrado vertical */
      justify-content: center; /* Centrado horizontal */
    }

    #notification-container {
      margin: 0;
      width: var(--card-width);
      perspective: 1000px;
    }

    .card {
      background: var(--card-bg-color);
      border-left: 6px solid var(--accent-color);
      border-radius: var(--card-border-radius);
      min-height: var(--card-min-height);
      padding: 20px;
      color: var(--text-color);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transform-origin: left center;
      opacity: 0;
      transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden; /* Para el fondo de car谩tula */
    }

    /* Album Art Styles */
    .album-art-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(20px) brightness(0.4);
      z-index: 0;
      opacity: 0;
      transition: opacity 1s ease;
    }
    .card-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 100%;
    }
    
    /* Layout: Row (Apple Style) */
    .layout-row .card-content {
      flex-direction: row;
      align-items: center;
      gap: 20px;
      text-align: left;
    }
    .layout-row .text-container {
      flex: 1;
    }
    .layout-row .album-art-img {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      display: none; /* Se muestra si hay imagen */
    }
    .layout-row .header {
       justify-content: flex-start;
       margin-bottom: 4px;
    }

    /* Ajustes para layout row */
    .layout-row .song-title { margin-bottom: 2px; }
    .layout-row .artist { margin-bottom: 8px; }
    
    /* Panel de Presets */
    #presets-btn {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 1000;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      cursor: grab;
      font-size: 20px;
      transition: background 0.3s ease, transform 0.3s ease;
      
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }
    #presets-btn:active { cursor: grabbing; }
    #presets-btn:hover { background: rgba(0,0,0,0.8); transform: scale(1.1); }

    #presets-panel {
      position: fixed;
      top: 130px;
      left: 20px;
      width: 250px;
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      z-index: 1001;
      color: white;
      display: none;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    #presets-panel.open { display: block; animation: menu-pop 0.3s ease; }
    
    .preset-item {
      padding: 10px;
      background: #333;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .preset-item:hover { background: #444; }
    .preset-name { font-weight: bold; font-size: 14px; }
    .preset-delete { color: #ff4444; font-size: 12px; padding: 4px 8px; cursor: pointer; }
    .preset-delete:hover { background: rgba(255,0,0,0.2); border-radius: 4px; }

    /* Animaciones de Entrada (controladas por clase en el contenedor o tarjeta) */
    /* Default: Flip In */
    .anim-flip .card { transform: translateX(-50px) rotateY(90deg); }
    .anim-flip .card.show { opacity: 1; transform: translateX(0) rotateY(0); }

    /* Slide Up */
    .anim-slide-up .card { transform: translateY(50px); }
    .anim-slide-up .card.show { opacity: 1; transform: translateY(0); }

    /* Zoom In */
    .anim-zoom .card { transform: scale(0.5); }
    .anim-zoom .card.show { opacity: 1; transform: scale(1); }

    /* Bounce In */
    .anim-bounce .card { transform: scale(0.8) translateY(20px); }
    .anim-bounce .card.show { opacity: 1; transform: scale(1) translateY(0); animation: bounceEffect 0.8s; }

    @keyframes bounceEffect {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-20px);}
      60% {transform: translateY(-10px);}
    }


    .header {
      font-size: var(--font-size-header);
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent-color);
      font-weight: 900;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header.no-icon::before {
      display: none;
    }

    .header::before {
      content: var(--icon-content);
      font-size: var(--icon-font-size);
      background: var(--icon-bg-color);
      width: var(--icon-circle-size);
      height: var(--icon-circle-size);
      min-width: var(--icon-circle-size); /* Asegurar que no se aplaste */
      min-height: var(--icon-circle-size);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      animation: icon-pulse 2s infinite ease-in-out;
      box-shadow: 0 0 15px var(--accent-color-glow);
      border: 2px solid var(--accent-color);
    }

    @keyframes icon-pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 var(--accent-color-bg); }
      50% { transform: scale(1.1); box-shadow: 0 0 20px 0 var(--accent-color-glow); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 var(--accent-color-bg); }
    }

    /* Text Animations */
    .text-anim-fade .song-title, .text-anim-fade .artist {
       animation: text-fade 1s ease-out forwards;
    }
    @keyframes text-fade { from { opacity: 0; } to { opacity: 1; } }

    .text-anim-slide .song-title { animation: text-slide 0.8s ease-out forwards; }
    .text-anim-slide .artist { animation: text-slide 1s ease-out forwards; }
    @keyframes text-slide { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    .text-anim-scale .song-title, .text-anim-scale .artist { animation: text-scale 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes text-scale { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

    .song-title {
      font-size: var(--font-size-song);
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      /* Truncar si es muy largo */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .artist {
      font-size: var(--font-size-artist);
      color: rgba(255,255,255,0.9); /* Usar opacidad para adaptarse */
      margin-bottom: 12px;
      font-weight: 400;
    }

    .requested-by {
      font-size: var(--font-size-user);
      color: rgba(255,255,255,0.7);
      border-top: var(--sep-width) var(--sep-style) var(--sep-color);
      padding-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .user-badge {
      background: #333;
      padding: 2px 8px;
      border-radius: 4px;
      color: #fff;
      font-weight: 700;
    }

    /* Animaci贸n de entrada */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4); } /* Deber铆a usar accent color din谩mico, pero keyframes son dif铆ciles de inyectar var() en colores complejos si necesitamos opacidad. 
      Pero podemos usar currentColor si seteamos color en el elemento, o simplemente simplificar */
      /* Usaremos una variable para el color de sombra o lo dejamos fijo por simplicidad, o mejor: */
      0% { box-shadow: 0 0 0 0 var(--accent-color); }
      70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } /* Fade out to transparent */
      100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    }
    
    .card.show {
      /* Re-habilitamos animaci贸n simple, nota: rgba din谩mico en keyframes es complejo sin pre-c谩lculo */
      /* Por ahora desactivamos el pulse de color espec铆fico o lo hacemos blanco sutil */
      animation: none; /* Simplificar para evitar problemas con variables en keyframes complejos */
      /* Opcional: Reemplazar con algo gen茅rico */
    }

    /* Panel de Configuraci贸n */
    #settings-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      cursor: grab;
      font-size: 20px;
      transition: background 0.3s ease, transform 0.3s ease;
      
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }
    #settings-btn:active {
      cursor: grabbing;
    }
    #settings-btn:hover {
      background: rgba(0,0,0,0.8);
      transform: rotate(90deg);
    }

    #settings-panel {
      position: fixed;
      top: 70px;
      left: 20px;
      transform: none;
      transform-origin: top left;
      width: 90%;
      max-width: 400px;
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      z-index: 1001;
      color: white;
      display: none;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      max-height: 80vh;
      overflow-y: auto;
    }
    #settings-panel.open { 
      display: block; 
      animation: menu-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes menu-pop {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .settings-group { margin-bottom: 15px; }
    .settings-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #ccc; }
    .settings-group input[type="text"],
    .settings-group input[type="number"], 
    .settings-group select {
      width: 100%;
      padding: 8px;
      background: #333;
      border: 1px solid #444;
      color: white;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .settings-group input[type="color"] {
      width: 100%;
      height: 40px;
      border: none;
      background: none;
      cursor: pointer;
    }
    .settings-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-save { background: #ff0055; color: #fff; }
    .btn-reset { background: #444; color: #fff; }

    /* Estilos para controles de depuraci贸n */
    #debug-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      opacity: 0.2; /* Discreto por defecto */
      transition: opacity 0.3s;
    }
    #debug-controls:hover {
      opacity: 1;
    }
    #debug-controls button {
      padding: 10px 20px;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #debug-controls button:hover {
      background: #eee;
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <div id="notification-container">
    <div id="card" class="card">
      <div id="album-art-bg" class="album-art-bg"></div>
      <div class="card-content">
          <!-- Para modo Row -->
          <div id="album-art-img" class="album-art-img"></div>
          
          <div class="text-container">
              <div class="header">Nueva Solicitud</div>
              <div class="song-title" id="song">Canci贸n</div>
              <div class="artist" id="artist">Artista</div>
              <div class="requested-by">
                Pedida por: <span class="user-badge" id="user">Usuario</span>
              </div>
          </div>
      </div>
    </div>
  </div>

  <!-- Bot贸n de Configuraci贸n -->
  <button id="settings-btn" title="Configurar Overlay">锔</button>
  
  <!-- Bot贸n de Presets -->
  <button id="presets-btn" title="Presets"></button>

  <!-- Panel de Presets -->
  <div id="presets-panel">
    <h3 style="margin-top:0; border-bottom: 1px solid #333; padding-bottom: 10px;">Presets</h3>
    <div id="presets-list"></div>
    <button class="btn btn-reset" onclick="togglePresets()" style="margin-top:10px;">Cerrar</button>
  </div>

  <!-- Panel de Configuraci贸n -->
  <div id="settings-panel">
    <h3 style="margin-top:0; border-bottom: 1px solid #333; padding-bottom: 10px;">Configuraci贸n</h3>
    
    <div class="settings-group">
      <label>Ancho de Tarjeta (px)</label>
      <input type="number" id="inp-width" value="400" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Alto M铆nimo (px)</label>
      <input type="number" id="inp-minHeight" value="100" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Radio de Borde (px)</label>
      <input type="number" id="inp-borderRadius" value="8" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Animaci贸n de Entrada</label>
      <select id="inp-animType" onchange="previewSettings()">
        <option value="anim-flip">Flip In (Default)</option>
        <option value="anim-slide-up">Slide Up</option>
        <option value="anim-zoom">Zoom In</option>
        <option value="anim-bounce">Bounce In</option>
      </select>
    </div>

    <div class="settings-group">
      <label>Animaci贸n de Texto</label>
      <select id="inp-textAnim" onchange="previewSettings()">
        <option value="text-anim-none">Ninguna</option>
        <option value="text-anim-fade">Fade In</option>
        <option value="text-anim-slide">Slide In</option>
        <option value="text-anim-scale">Scale Up</option>
      </select>
    </div>


    <div class="settings-group">
      <label>Fuente</label>
      <select id="inp-font" onchange="previewSettings()">
        <option value="'Montserrat', sans-serif">Montserrat</option>
        <option value="'Roboto', sans-serif">Roboto</option>
        <option value="'Open Sans', sans-serif">Open Sans</option>
        <option value="'Lato', sans-serif">Lato</option>
        <option value="sans-serif">System Default</option>
      </select>
    </div>

    <div class="settings-group">
      <label>Tama帽o T铆tulo (px)</label>
      <input type="number" id="inp-fontSizeSong" value="42" oninput="previewSettings()">
    </div>
    
    <div class="settings-group">
      <label>Tama帽o Artista (px)</label>
      <input type="number" id="inp-fontSizeArtist" value="28" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Tama帽o Usuario / Pedido por (px)</label>
      <input type="number" id="inp-fontSizeUser" value="21" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Tama帽o Cabecera (px)</label>
      <input type="number" id="inp-fontSizeHeader" value="24" oninput="previewSettings()">
    </div>

    <!-- Deprecated Base Font Size hidden or removed -->
    <!-- <div class="settings-group">
      <label>Tama帽o de Fuente Base (px)</label>
      <input type="number" id="inp-fontSize" value="16">
    </div> -->

    <div class="settings-group">
      <label>Color de Acento</label>
      <input type="color" id="inp-accent" value="#ff0055" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Icono</label>
      <select id="inp-icon" onchange="previewSettings()">
        <option value=""> Nota Musical</option>
        <option value=""> Auriculares</option>
        <option value=""> CD</option>
        <option value=""> Radio</option>
        <option value=""> Guitarra</option>
        <option value=""> Piano</option>
        <option value=""> Micr贸fono</option>
        <option value=""> Altavoz</option>
        <option value=""> Partitura</option>
        <option value=""> Notas</option>
        <option value=""> Tambor</option>

      </select>
    </div>

    <div class="settings-group">
      <label>Tama帽o C铆rculo (px)</label>
      <input type="number" id="inp-iconCircleSize" value="50" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Tama帽o Icono (Fuente px)</label>
      <input type="number" id="inp-iconFontSize" value="25" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Color C铆rculo Icono</label>
      <input type="color" id="inp-iconBg" value="#ffffff" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Opacidad C铆rculo (0-100%)</label>
      <input type="range" id="inp-iconOpacity" min="0" max="100" value="20" oninput="document.getElementById('icon-opacity-val').innerText = this.value + '%'; previewSettings()">
      <span id="icon-opacity-val" style="float: right; margin-top: -30px; margin-right: 10px; font-size: 12px; color: #aaa;">20%</span>
    </div>

    <div class="settings-group">
      <label>Color de Fondo</label>
      <input type="color" id="inp-bg" value="#000000" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Opacidad Fondo (0-100%)</label>
      <input type="range" id="inp-opacity" min="0" max="100" value="85" oninput="document.getElementById('bg-opacity-val').innerText = this.value + '%'; previewSettings()">
      <span id="bg-opacity-val" style="float: right; margin-top: -30px; margin-right: 10px; font-size: 12px; color: #aaa;">85%</span>
    </div>

    <div class="settings-group">
      <label>Color de Texto</label>
      <input type="color" id="inp-text" value="#ffffff" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Duraci贸n en Pantalla (segundos)</label>
      <input type="number" id="inp-duration" value="10" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Separador: Color</label>
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
        <input type="checkbox" id="inp-sepUseAccent" onchange="previewSettings()" style="width:auto; margin:0;">
        <span style="font-size:12px; color:#aaa;">Usar Color de Acento</span>
      </div>
      <input type="color" id="inp-sepColor" value="#ffffff" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Separador: Opacidad (%)</label>
      <input type="range" id="inp-sepOpacity" min="0" max="100" value="10" oninput="document.getElementById('sep-opacity-val').innerText = this.value + '%'; previewSettings()">
      <span id="sep-opacity-val" style="float: right; margin-top: -30px; margin-right: 10px; font-size: 12px; color: #aaa;">10%</span>
    </div>

    <div class="settings-group">
      <label>Separador: Grosor (px)</label>
      <input type="number" id="inp-sepWidth" value="1" oninput="previewSettings()">
    </div>

    <div class="settings-group">
      <label>Separador: Estilo</label>
      <select id="inp-sepStyle" onchange="previewSettings()">
        <option value="solid">S贸lido</option>
        <option value="dashed">Discontinuo (Dashed)</option>
        <option value="dotted">Puntos (Dotted)</option>
        <option value="double">Doble</option>
      </select>
    </div>

    <div class="settings-group">
       <label>Simulaci贸n</label>
       <button class="btn" style="background: #333;" onclick="simulateRequest()"> Simular Pedido</button>
    </div>

    <div class="settings-group">
      <label>Disposici贸n (Layout)</label>
      <select id="inp-layoutMode" onchange="previewSettings()">
        <option value="default">Est谩ndar (Columna)</option>
        <option value="row">Horizontal (Apple Style)</option>
      </select>
    </div>

    <div class="settings-group">
      <label>Car谩tula de lbum (Album Art)</label>
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="checkbox" id="inp-useAlbumArt" onchange="previewSettings()" style="width:auto; margin:0;">
        <span style="font-size:12px; color:#aaa;">Buscar y mostrar car谩tula</span>
      </div>
    </div>
    
    <div class="settings-group">
      <label>Guardar como Preset</label>
      <div style="display:flex; gap:10px;">
        <input type="text" id="inp-newPresetName" placeholder="Nombre del Preset">
        <button class="btn btn-save" onclick="saveAsPreset()" style="padding: 5px 10px; font-size:12px;">Guardar</button>
      </div>
    </div>

    <div class="settings-actions">
      <button class="btn btn-reset" onclick="resetSettings()">Reset</button>
      <button class="btn btn-save" onclick="saveSettings()">Guardar</button>
    </div>
  </div>

  <!-- Controles de Depuraci贸n -->
  <div id="debug-controls">
    <button onclick="simulateRequest()"> Simular Pedido</button>
  </div>

  <script>
    // --- Configuraci贸n / Settings Logic ---
    const defaultSettings = {
      width: 800, // Ajustado para 1080p
      minHeight: 200,
      borderRadius: 20,
      animType: 'anim-flip',
      textAnim: 'text-anim-fade',
      font: "'Montserrat', sans-serif",
      // Default font sizes optimized for 1080p vertical
      fontSizeSong: 42,
      fontSizeArtist: 28,
      fontSizeUser: 21,
      fontSizeHeader: 24,
      accent: "#ff0055",
      icon: "",
      iconCircleSize: 50,
      iconFontSize: 25,
      iconBg: "#ffffff",
      iconOpacity: 20,
      bg: "#000000",
      opacity: 85,
      text: "#ffffff",
      duration: 10,
      sepColor: "#ffffff",
      sepUseAccent: true,
      sepOpacity: 10,
      sepWidth: 1,
      sepStyle: "solid",
      layoutMode: 'default',
      useAlbumArt: false
    };

    let displayDuration = 10000;

    function loadSettings() {
      const saved = localStorage.getItem('overlay_settings');
      // Merge saved with default to ensure new keys exist
      const settings = saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
      
      // Migration check: 
      // 1. Old fontSize -> specific sizes
      if(saved) {
         const parsed = JSON.parse(saved);
         if(!parsed.fontSizeSong && parsed.fontSize) {
            settings.fontSizeSong = Math.round(parsed.fontSize * 1.5);
            settings.fontSizeArtist = parsed.fontSize;
            settings.fontSizeUser = Math.round(parsed.fontSize * 0.75);
            settings.fontSizeHeader = Math.round(parsed.fontSize * 0.875);
         }
         // 2. Old iconSize -> iconCircleSize + iconFontSize
         if (parsed.iconSize && !parsed.iconCircleSize) {
            settings.iconCircleSize = parsed.iconSize;
            settings.iconFontSize = Math.round(parsed.iconSize * 0.5);
         }
      }

      applySettings(settings);
      
      // Update Inputs
      document.getElementById('inp-width').value = settings.width;
      document.getElementById('inp-minHeight').value = settings.minHeight;
      document.getElementById('inp-borderRadius').value = settings.borderRadius;
      document.getElementById('inp-animType').value = settings.animType;
      document.getElementById('inp-textAnim').value = settings.textAnim || 'text-anim-fade';
      
      document.getElementById('inp-font').value = settings.font;
      
      document.getElementById('inp-fontSizeSong').value = settings.fontSizeSong;
      document.getElementById('inp-fontSizeArtist').value = settings.fontSizeArtist;
      document.getElementById('inp-fontSizeUser').value = settings.fontSizeUser;
      document.getElementById('inp-fontSizeHeader').value = settings.fontSizeHeader;

      document.getElementById('inp-accent').value = settings.accent;
      document.getElementById('inp-icon').value = settings.icon || '';
      document.getElementById('inp-iconCircleSize').value = settings.iconCircleSize || 50;
      document.getElementById('inp-iconFontSize').value = settings.iconFontSize || 25;
      document.getElementById('inp-iconBg').value = settings.iconBg || '#ffffff';
      
      const iconOpVal = settings.iconOpacity !== undefined ? settings.iconOpacity : 20;
      document.getElementById('inp-iconOpacity').value = iconOpVal;
      document.getElementById('icon-opacity-val').innerText = iconOpVal + '%';

      document.getElementById('inp-bg').value = settings.bg;
      
      const opVal = settings.opacity !== undefined ? settings.opacity : 85;
      document.getElementById('inp-opacity').value = opVal;
      document.getElementById('bg-opacity-val').innerText = opVal + '%';

      document.getElementById('inp-text').value = settings.text;
      document.getElementById('inp-duration').value = settings.duration !== undefined ? settings.duration : 10;
      
      document.getElementById('inp-sepColor').value = settings.sepColor || '#ffffff';
      document.getElementById('inp-sepUseAccent').checked = settings.sepUseAccent !== undefined ? settings.sepUseAccent : true;
      toggleSepColorInput(); 

      const sepOpVal = settings.sepOpacity !== undefined ? settings.sepOpacity : 10;
      document.getElementById('inp-sepOpacity').value = sepOpVal;
      document.getElementById('sep-opacity-val').innerText = sepOpVal + '%';

      document.getElementById('inp-sepWidth').value = settings.sepWidth !== undefined ? settings.sepWidth : 1;
      document.getElementById('inp-sepStyle').value = settings.sepStyle || 'solid';
      
      if(document.getElementById('inp-layoutMode')) {
         document.getElementById('inp-layoutMode').value = settings.layoutMode || 'default';
      }
      if(document.getElementById('inp-useAlbumArt')) {
         document.getElementById('inp-useAlbumArt').checked = settings.useAlbumArt || false;
      }
    }

    function applySettings(s) {
      const root = document.documentElement;
      root.style.setProperty('--card-width', s.width + 'px');
      root.style.setProperty('--card-min-height', s.minHeight + 'px');
      root.style.setProperty('--card-border-radius', s.borderRadius + 'px');
      
      // Apply Animation Class to Container or Card Wrapper
      const container = document.getElementById('notification-container');
      // Reset animation classes
      container.className = '';
      container.classList.add(s.animType);
      if (s.textAnim) container.classList.add(s.textAnim);

      root.style.setProperty('--font-family', s.font);
      
      // Apply specific font sizes
      root.style.setProperty('--font-size-song', s.fontSizeSong + 'px');
      root.style.setProperty('--font-size-artist', s.fontSizeArtist + 'px');
      root.style.setProperty('--font-size-user', s.fontSizeUser + 'px');
      root.style.setProperty('--font-size-header', s.fontSizeHeader + 'px');

      root.style.setProperty('--accent-color', s.accent);
      root.style.setProperty('--text-color', s.text);
      
      // Icon Content & Size
      const iconChar = s.icon || '';
      root.style.setProperty('--icon-content', `"${iconChar}"`);
      const iconSize = s.iconCircleSize !== undefined ? s.iconCircleSize : 50;
      root.style.setProperty('--icon-circle-size', iconSize + 'px');
      root.style.setProperty('--icon-font-size', (s.iconFontSize || 25) + 'px');
      
      const headerEl = document.querySelector('.header');
      if(headerEl) {
         if(iconSize <= 0) headerEl.classList.add('no-icon');
         else headerEl.classList.remove('no-icon');
      }

      // Icon Background Color
      const ir = parseInt((s.iconBg || '#ffffff').substr(1,2), 16);
      const ig = parseInt((s.iconBg || '#ffffff').substr(3,2), 16);
      const ib = parseInt((s.iconBg || '#ffffff').substr(5,2), 16);
      let iOp = s.iconOpacity;
      if (iOp === undefined || iOp === null || iOp === "") iOp = 20;
      root.style.setProperty('--icon-bg-color', `rgba(${ir},${ig},${ib},${parseFloat(iOp)/100})`);
      
      const r = parseInt(s.bg.substr(1,2), 16);
      const g = parseInt(s.bg.substr(3,2), 16);
      const b = parseInt(s.bg.substr(5,2), 16);
      
      // Asegurarse que opacity sea un n煤mero entre 0 y 1
      let rawOpacity = s.opacity;
      if (rawOpacity === undefined || rawOpacity === null || rawOpacity === "") {
        rawOpacity = 85;
      }
      const opacity = parseFloat(rawOpacity) / 100;
      
      root.style.setProperty('--card-bg-color', `rgba(${r},${g},${b},${opacity})`);

      // Calculate accent color rgba variants
      const ar = parseInt(s.accent.substr(1,2), 16);
      const ag = parseInt(s.accent.substr(3,2), 16);
      const ab = parseInt(s.accent.substr(5,2), 16);
      root.style.setProperty('--accent-color-bg', `rgba(${ar},${ag},${ab},0.2)`);
      root.style.setProperty('--accent-color-glow', `rgba(${ar},${ag},${ab},0.4)`);
      
      // Separator
      let finalSepColor = s.sepColor || '#ffffff';
      if (s.sepUseAccent) {
         finalSepColor = s.accent;
      }

      const sr = parseInt(finalSepColor.substr(1,2), 16);
      const sg = parseInt(finalSepColor.substr(3,2), 16);
      const sb = parseInt(finalSepColor.substr(5,2), 16);
      const sepOp = (s.sepOpacity !== undefined ? s.sepOpacity : 10) / 100;
      
      root.style.setProperty('--sep-color', `rgba(${sr},${sg},${sb},${sepOp})`);
      root.style.setProperty('--sep-width', (s.sepWidth || 1) + 'px');
      root.style.setProperty('--sep-style', s.sepStyle || 'solid');
      
      // UI Update for disabled state
      toggleSepColorInput();

      displayDuration = (s.duration !== undefined ? s.duration : 10) * 1000;
      
      // Layout Mode
      const card = document.getElementById('card');
      if(s.layoutMode === 'row') {
        card.classList.add('layout-row');
      } else {
        card.classList.remove('layout-row');
      }
      
      // Album Art Visibility (global toggle, but specific visibility depends on song)
      // Here we just set a state or we can hide it if disabled
      if(!s.useAlbumArt) {
         const artBg = document.getElementById('album-art-bg');
         const artImg = document.getElementById('album-art-img');
         if(artBg) artBg.style.opacity = '0';
         if(artImg) artImg.style.display = 'none';
      }
    }

    function toggleSepColorInput() {
       const cb = document.getElementById('inp-sepUseAccent');
       const inp = document.getElementById('inp-sepColor');
       if(cb && inp) {
          inp.disabled = cb.checked;
          inp.style.opacity = cb.checked ? '0.5' : '1';
       }
    }

    function getSettingsFromInputs() {
      return {
        width: document.getElementById('inp-width').value,
        minHeight: document.getElementById('inp-minHeight').value,
        borderRadius: document.getElementById('inp-borderRadius').value,
        animType: document.getElementById('inp-animType').value,
        textAnim: document.getElementById('inp-textAnim').value,
        font: document.getElementById('inp-font').value,
        
        fontSizeSong: document.getElementById('inp-fontSizeSong').value,
        fontSizeArtist: document.getElementById('inp-fontSizeArtist').value,
        fontSizeUser: document.getElementById('inp-fontSizeUser').value,
        fontSizeHeader: document.getElementById('inp-fontSizeHeader').value,

        accent: document.getElementById('inp-accent').value,
        icon: document.getElementById('inp-icon').value,
        iconCircleSize: document.getElementById('inp-iconCircleSize').value,
        iconFontSize: document.getElementById('inp-iconFontSize').value,
        iconBg: document.getElementById('inp-iconBg').value,
        iconOpacity: document.getElementById('inp-iconOpacity').value,
        bg: document.getElementById('inp-bg').value,
        opacity: document.getElementById('inp-opacity').value,
        text: document.getElementById('inp-text').value,
        duration: document.getElementById('inp-duration').value,
        sepColor: document.getElementById('inp-sepColor').value,
        sepUseAccent: document.getElementById('inp-sepUseAccent').checked,
        sepOpacity: document.getElementById('inp-sepOpacity').value,
        sepWidth: document.getElementById('inp-sepWidth').value,
        sepStyle: document.getElementById('inp-sepStyle').value,
        
        layoutMode: document.getElementById('inp-layoutMode').value,
        useAlbumArt: document.getElementById('inp-useAlbumArt').checked
      };
    }

    function previewSettings() {
      const settings = getSettingsFromInputs();
      console.log('Previewing settings:', settings);
      console.log(`Applying sizes - Circle: ${settings.iconCircleSize}, Icon: ${settings.iconFontSize}`);
      applySettings(settings);
    }

    function saveSettings() {
      const settings = getSettingsFromInputs();
      console.log('Saving settings:', settings);
      localStorage.setItem('overlay_settings', JSON.stringify(settings));
      applySettings(settings);
      
      // Sync to Firestore
      if (db) {
        db.collection('userSettings').doc('global_overlay_config').set(settings)
          .then(() => console.log("Configuraci贸n guardada en la nube"))
          .catch(err => console.error("Error guardando configuraci贸n:", err));
      }

      toggleSettings(); // close panel
    }
    
    // Listeners para vista previa en tiempo real
    document.addEventListener('DOMContentLoaded', () => {
        ['inp-width', 'inp-minHeight', 'inp-borderRadius', 'inp-animType', 'inp-textAnim',
         'inp-font', 'inp-fontSizeSong', 'inp-fontSizeArtist', 'inp-fontSizeUser', 'inp-fontSizeHeader', 
         'inp-accent', 'inp-icon', 'inp-iconCircleSize', 'inp-iconFontSize', 'inp-iconBg', 'inp-iconOpacity',
         'inp-bg', 'inp-opacity', 'inp-text', 'inp-duration',
         'inp-sepColor', 'inp-sepUseAccent', 'inp-sepOpacity', 'inp-sepWidth', 'inp-sepStyle'].forEach(id => {
           const el = document.getElementById(id);
           if(el) {
             el.addEventListener('input', previewSettings);
             el.addEventListener('change', previewSettings);
           }
        });
    });

    function resetSettings() {
      if(confirm('驴Restablecer valores por defecto?')) {
        applySettings(defaultSettings);
        localStorage.removeItem('overlay_settings');
        loadSettings(); // reload inputs
        toggleSettings();
      }
    }

    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      panel.classList.toggle('open');
    }

    // Inicializar settings
    loadSettings();

    // Configuraci贸n de Firebase (Tomada de index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyA6c3EaIvuPEfM6sTV0YHqCBHuz35ZmNIU",
      authDomain: "zero-strom-web.firebaseapp.com",
      projectId: "zero-strom-web",
      storageBucket: "zero-strom-web.firebasestorage.app",
      messagingSenderId: "758369466349",
      appId: "1:758369466349:web:f2ced362a5a049c70b59e4"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Sincronizar configuraci贸n global desde Firestore
    db.collection('userSettings').doc('global_overlay_config')
      .onSnapshot((doc) => {
        if (doc.exists) {
          console.log("Configuraci贸n remota recibida");
          const remoteSettings = doc.data();
          const settings = { ...defaultSettings, ...remoteSettings };
          
          // Guardar localmente y aplicar
          localStorage.setItem('overlay_settings', JSON.stringify(settings));
          applySettings(settings);
          
          // Actualizar inputs si el panel est谩 abierto (o para la pr贸xima vez)
          if (document.getElementById('inp-width')) {
              document.getElementById('inp-width').value = settings.width;
              document.getElementById('inp-minHeight').value = settings.minHeight;
              document.getElementById('inp-borderRadius').value = settings.borderRadius;
              document.getElementById('inp-animType').value = settings.animType;
              document.getElementById('inp-textAnim').value = settings.textAnim || 'text-anim-fade';
              
              document.getElementById('inp-font').value = settings.font;
              
              document.getElementById('inp-fontSizeSong').value = settings.fontSizeSong;
              document.getElementById('inp-fontSizeArtist').value = settings.fontSizeArtist;
              document.getElementById('inp-fontSizeUser').value = settings.fontSizeUser;
              document.getElementById('inp-fontSizeHeader').value = settings.fontSizeHeader;
        
              document.getElementById('inp-accent').value = settings.accent;
              document.getElementById('inp-bg').value = settings.bg;
              
              const opVal = settings.opacity !== undefined ? settings.opacity : 85;
              document.getElementById('inp-opacity').value = opVal;
              document.getElementById('bg-opacity-val').innerText = opVal + '%';
        
              document.getElementById('inp-text').value = settings.text;
              document.getElementById('inp-duration').value = settings.duration !== undefined ? settings.duration : 10;
              
              if(document.getElementById('inp-sepColor')) {
                   document.getElementById('inp-sepColor').value = settings.sepColor || '#ffffff';
                   document.getElementById('inp-sepUseAccent').checked = settings.sepUseAccent !== undefined ? settings.sepUseAccent : true;
                   toggleSepColorInput();

                   document.getElementById('inp-sepOpacity').value = settings.sepOpacity !== undefined ? settings.sepOpacity : 10;
                   document.getElementById('sep-opacity-val').innerText = (settings.sepOpacity !== undefined ? settings.sepOpacity : 10) + '%';
                   document.getElementById('inp-sepWidth').value = settings.sepWidth !== undefined ? settings.sepWidth : 1;
                   document.getElementById('inp-sepStyle').value = settings.sepStyle || 'solid';
               }
          }
        }
      }, (error) => {
         console.warn("No se pudo sincronizar configuraci贸n remota (posiblemente offline o sin permisos):", error);
      });

    const card = document.getElementById('card');
    const songEl = document.getElementById('song');
    const artistEl = document.getElementById('artist');
    const userEl = document.getElementById('user');

    let hideTimeout;
    
    // --- Queue Logic ---
    let notificationQueue = [];
    let isShowing = false;

    function addToQueue(data) {
      console.log("A帽adido a la cola:", data.cancion);
      notificationQueue.push(data);
      processQueue();
    }

    function processQueue() {
      if (isShowing || notificationQueue.length === 0) return;
      
      const data = notificationQueue.shift();
      showNotification(data);
    }

    function showNotification(data) {
      isShowing = true;

      // Rellenar datos
      songEl.textContent = data.cancion || 'Desconocida';
      artistEl.textContent = data.artista || 'Desconocido';
      userEl.textContent = data.usuario || 'An贸nimo';

      // Album Art Logic
      const settings = getSettingsFromInputs(); // Get current settings to check if enabled
      if (settings.useAlbumArt) {
         fetchAlbumArt(data.artista, data.cancion);
      } else {
         // Reset art if disabled
         const artBg = document.getElementById('album-art-bg');
         const artImg = document.getElementById('album-art-img');
         if(artBg) artBg.style.opacity = '0';
         if(artImg) artImg.style.display = 'none';
      }

      // Resetear animaci贸n (por si acaso, aunque processQueue espera)
      card.classList.remove('show');
      void card.offsetWidth; // Trigger reflow
      card.classList.add('show');

      // Limpiar timeout anterior si existe (seguridad)
      if (hideTimeout) clearTimeout(hideTimeout);

      // Ocultar despu茅s de X segundos
      hideTimeout = setTimeout(() => {
        card.classList.remove('show');
        
        // Esperar a que termine la animaci贸n de salida antes de procesar el siguiente
        // Asumimos unos 600ms de transici贸n CSS + un peque帽o buffer
        setTimeout(() => {
          isShowing = false;
          processQueue();
        }, 1000); 

      }, displayDuration);
    }

    // --- Album Art Logic ---
    function fetchAlbumArt(artist, song) {
      if(!artist || !song) return;
      
      const query = encodeURIComponent(`${artist} ${song}`);
      const url = `https://itunes.apple.com/search?term=${query}&media=music&entity=song&limit=1`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
           if(data.results && data.results.length > 0) {
              const artUrl = data.results[0].artworkUrl100.replace('100x100', '600x600');
              
              const artBg = document.getElementById('album-art-bg');
              const artImg = document.getElementById('album-art-img');
              
              if(artBg) {
                 artBg.style.backgroundImage = `url('${artUrl}')`;
                 artBg.style.opacity = '1';
              }
              
              if(artImg) {
                 artImg.style.backgroundImage = `url('${artUrl}')`;
                 // Show image only if in row mode or configured to show
                 const settings = getSettingsFromInputs();
                 if(settings.layoutMode === 'row') {
                    artImg.style.display = 'block';
                 } else {
                    artImg.style.display = 'none';
                 }
              }
           } else {
              console.log("No album art found for", artist, song);
              // Hide or use placeholder? For now hide.
              const artBg = document.getElementById('album-art-bg');
              const artImg = document.getElementById('album-art-img');
              if(artBg) artBg.style.opacity = '0';
              if(artImg) artImg.style.display = 'none';
           }
        })
        .catch(err => {
           console.error("Error fetching album art:", err);
        });
    }

    // Variable para controlar la carga inicial
    let isInitialLoad = true;

    // Escuchar la colecci贸n 'solicitudes'
    // Ordenamos por timestamp descendente y limitamos a 1 para ver el 煤ltimo
    db.collection('solicitudes')
      .orderBy('ts', 'desc')
      .limit(1)
      .onSnapshot((snapshot) => {
        if (snapshot.empty) {
          isInitialLoad = false;
          return;
        }

        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const data = change.doc.data();
            
            // L贸gica de timestamp
            let docTime = Date.now();
            if (data.ts && typeof data.ts.toDate === 'function') {
              docTime = data.ts.toDate().getTime();
            } else if (data.ts && data.ts instanceof Date) {
               docTime = data.ts.getTime(); // Para simulaciones locales que usan Date
            } else if (data.ts) {
               // Fallback si es string o n煤mero
               docTime = new Date(data.ts).getTime();
            }
            
            const now = Date.now();
            const diff = now - docTime;
            
            // Umbral para carga inicial (evitar mostrar pedidos viejos al abrir OBS)
            // 20 minutos de tolerancia
            const initialLoadThreshold = 20 * 60 * 1000; 

            console.log(`Pedido recibido: ${data.cancion}, TS: ${docTime}, Ahora: ${now}, Diff: ${diff}ms, Initial: ${isInitialLoad}`);

            if (isInitialLoad) {
               // En carga inicial, solo mostrar si es reciente (< 20 min)
               if (diff < initialLoadThreshold) {
                 addToQueue(data);
               } else {
                 console.log('Solicitud antigua ignorada en carga inicial:', data);
               }
            } else {
               // Si NO es carga inicial, es un evento en tiempo real.
               addToQueue(data);
            }
          }
        });
        
        // Marcar carga inicial como completada despu茅s de procesar el primer snapshot
        isInitialLoad = false;

      }, (error) => {
        console.error("Error escuchando solicitudes:", error);
      });

    // Funci贸n de simulaci贸n para pruebas manuales
    function simulateRequest() {
      const artists = ["Bad Bunny", "Karol G", "Feid", "Rauw Alejandro", "Shakira", "Daddy Yankee", "Rosal铆a"];
      const songs = ["Tit铆 Me Pregunt贸", "Provenza", "Classy 101", "Todo de Ti", "Bzrp Music Sessions, Vol. 53", "Gasolina", "Despech谩"];
      
      const randomArtist = artists[Math.floor(Math.random() * artists.length)];
      const randomSong = songs[Math.floor(Math.random() * songs.length)];
      const randomUser = "Prueba";

      const now = new Date();
      // Utilidad simple para fecha local YYYY-MM-DD
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const dayKey = `${y}-${m}-${d}`;

      const req = {
        cancion: randomSong,
        artista: randomArtist,
        usuario: randomUser,
        ts: now,
        day: dayKey,
        isSimulation: true
      };

      console.log("Enviando simulaci贸n a Firebase:", req);
      db.collection('solicitudes').add(req)
        .then(() => console.log("Simulaci贸n enviada con 茅xito"))
        .catch(err => console.error("Error enviando simulaci贸n:", err));
    }

    // Modo de prueba autom谩tico: ?test=true
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('test') === 'true') {
      setTimeout(() => {
        console.log("Iniciando prueba de cola (3 solicitudes)...");
        simulateRequest();
        setTimeout(simulateRequest, 2000); 
        setTimeout(simulateRequest, 4000);
      }, 1000);
    }
    // --- Drag & Drop Logic ---
    function makeDraggable(el, clickCallback) {
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let hasMoved = false;

        el.addEventListener('mousedown', (e) => {
            isDragging = true;
            hasMoved = false;
            const rect = el.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            el.style.cursor = 'grabbing';
            el.style.transition = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            hasMoved = true;
            e.preventDefault();
            const x = e.clientX - dragOffsetX;
            const y = e.clientY - dragOffsetY;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            el.style.cursor = 'grab';
            el.style.transition = 'background 0.3s ease, transform 0.3s ease';
        });

        el.addEventListener('click', (e) => {
            if (!hasMoved && clickCallback) {
                clickCallback();
            }
        });
    }

    // Init Drag for Settings Button
    makeDraggable(document.getElementById('settings-btn'), toggleSettings);

    // Init Drag for Presets Button
    makeDraggable(document.getElementById('presets-btn'), togglePresets);


    // --- Presets Logic ---
    function togglePresets() {
        const panel = document.getElementById('presets-panel');
        panel.classList.toggle('open');
        if(panel.classList.contains('open')) {
           loadPresetsList();
        }
    }

    function loadPresetsList() {
        const list = document.getElementById('presets-list');
        list.innerHTML = '';
        
        let presets = JSON.parse(localStorage.getItem('overlay_presets') || '[]');
        
        // Add Default "Apple Style" Preset if not present (optional, or just hardcode it as a button)
        // But better to check if user has any presets. If empty, maybe add some defaults?
        if(presets.length === 0) {
           // Create default Apple Music style preset
           const applePreset = {
              name: "Apple Music Style",
              settings: {
                  ...defaultSettings,
                  layoutMode: 'row',
                  useAlbumArt: true,
                  width: 500,
                  minHeight: 120,
                  borderRadius: 16,
                  bg: "#1a1a1a",
                  opacity: 90,
                  icon: "",
                  iconCircleSize: 0, // Hide icon circle
                  iconFontSize: 0,
                  sepWidth: 0, // Hide separator
                  animType: 'anim-slide-up',
                  textAnim: 'text-anim-slide',
                  fontSizeSong: 24,
                  fontSizeArtist: 16,
                  fontSizeUser: 12,
                  fontSizeHeader: 14
              }
           };
           // Add to list but don't save to storage automatically unless user wants? 
           // Let's save it so they have a starting point.
           presets.push(applePreset);
           localStorage.setItem('overlay_presets', JSON.stringify(presets));
        }

        presets.forEach((preset, index) => {
            const item = document.createElement('div');
            item.className = 'preset-item';
            item.innerHTML = `
               <span class="preset-name">${preset.name}</span>
               <span class="preset-delete" onclick="event.stopPropagation(); deletePreset(${index})">Eliminar</span>
            `;
            item.onclick = () => applyPreset(preset);
            list.appendChild(item);
        });
    }

    function saveAsPreset() {
        const nameInput = document.getElementById('inp-newPresetName');
        const name = nameInput.value.trim();
        if(!name) {
           alert("Por favor ingresa un nombre para el preset.");
           return;
        }

        const currentSettings = getSettingsFromInputs();
        const presets = JSON.parse(localStorage.getItem('overlay_presets') || '[]');
        
        presets.push({
           name: name,
           settings: currentSettings
        });
        
        localStorage.setItem('overlay_presets', JSON.stringify(presets));
        nameInput.value = '';
        alert(`Preset "${name}" guardado!`);
        
        // If panel is open, refresh
        if(document.getElementById('presets-panel').classList.contains('open')) {
           loadPresetsList();
        }
    }

    function deletePreset(index) {
        if(!confirm("驴Est谩s seguro de eliminar este preset?")) return;
        
        const presets = JSON.parse(localStorage.getItem('overlay_presets') || '[]');
        presets.splice(index, 1);
        localStorage.setItem('overlay_presets', JSON.stringify(presets));
        loadPresetsList();
    }

    function applyPreset(preset) {
        if(confirm(`驴Aplicar preset "${preset.name}"?`)) {
           // Merge with defaults to ensure completeness
           const settings = { ...defaultSettings, ...preset.settings };
           applySettings(settings);
           
           // Update inputs
           // Reuse logic from loadSettings but with specific object
           // Or just call loadSettings logic (refactoring loadSettings to take object would be cleaner, but for now we manually update inputs by saving and reloading or just calling apply and updating inputs manually)
           
           // Easy way: Save to localStorage as current settings and reload
           localStorage.setItem('overlay_settings', JSON.stringify(settings));
           loadSettings(); // This reloads inputs and re-applies
           
           console.log(`Preset ${preset.name} applied`);
        }
    }
   </script>
</body>
</html>