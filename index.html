<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Canciones Zero Radio</title>
  <link rel="stylesheet" href="styles.css?v=2.11" />
  
  <!-- Script de sincronizaci√≥n de temas -->
  <script>
    // Sincronizaci√≥n global de temas entre pesta√±as/ventanas
    window.addEventListener('focus', function() {
      // Cuando la ventana recibe foco, verificar si hay cambios de tema
      if (typeof window.applyTheme === 'function') {
        window.applyTheme();
      }
      if (typeof window.updateActiveStates === 'function') {
        window.updateActiveStates();
      }
    });
  </script>
  
  <!-- Firebase SDK (compat para uso sencillo en HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <main class="container">
    <section class="card" aria-labelledby="titulo">
      <div class="header-with-points">
        <h1 id="titulo">Lista de canciones</h1>
        <div class="header-controls">
          <div id="user-points-indicator" class="points-indicator" style="display: none;">
            <div class="points-icon">üèÜ</div>
            <div class="points-info">
              <div class="points-value" id="header-points">0</div>
              <div class="points-label">puntos</div>
            </div>
          </div>
          <button type="button" class="theme-btn" id="theme-btn" aria-label="Cambiar tema">üé®</button>
        </div>
      </div>


      <!-- Formulario: Usuario | Canci√≥n | Artista -->
      <form id="formulario" class="nuevo-form" autocomplete="on" aria-label="Formulario para pedir nueva canci√≥n">
        <div class="field">
          <label for="usuario">Usuario</label>
          <div class="user-split">
            <input id="usuario" name="usuario" type="text" placeholder="Escribe aqu√≠ tu nombre de usuario" />
            <select id="usuario-registrado" aria-label="Selecciona un usuario registrado">
              <option value="">Selecciona un usuario</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label for="cancion">Canci√≥n</label>
          <input id="cancion" name="cancion" type="text" required placeholder="¬øQu√© cancion vas a elegir?" />
        </div>
        <div class="field">
          <label for="artista">Artista</label>
          <input id="artista" name="artista" type="text" required placeholder="¬øQui√©n interpreta la cancion?" />
        </div>

        <div class="actions">
          <button type="submit" class="btn">Enviar solicitud</button>
          <a href="lista.html" class="btn">Lista de Canciones</a>
        </div>
      </form>
    </section>
  </main>

  <!-- Modal de Temas -->
  <div id="theme-modal" class="modal-overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="theme-modal-title">
      <button type="button" class="modal-close-btn" aria-label="Cerrar modal">&times;</button>
      <h2 id="theme-modal-title">üé® Personalizar Tema</h2>
      
      <div class="theme-options accordion">
        <!-- Secci√≥n: Modo de Color (Abierto por defecto) -->
        <div class="accordion-item active">
          <button type="button" class="accordion-header">
             <span>Modo de Color</span>
             <span class="accordion-icon">‚ñº</span>
          </button>
          <div class="accordion-content">
            <div class="theme-grid">
              <button type="button" class="theme-option active" data-theme="light">
                <div class="theme-preview light-preview"></div>
                <span>Claro</span>
              </button>
              <button type="button" class="theme-option" data-theme="dark">
                <div class="theme-preview dark-preview"></div>
                <span>Oscuro</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Colores de Acento -->
        <div class="accordion-item">
          <button type="button" class="accordion-header">
             <span>Colores de Acento</span>
             <span class="accordion-icon">‚ñº</span>
          </button>
          <div class="accordion-content">
            <div class="theme-grid">
              <button type="button" class="theme-color active" data-color="default">
                <div class="color-preview" style="background: #000;"></div>
                <span>Negro</span>
              </button>
              <button type="button" class="theme-color" data-color="blue">
                <div class="color-preview" style="background: #2563eb;"></div>
                <span>Azul</span>
              </button>
              <button type="button" class="theme-color" data-color="green">
                <div class="color-preview" style="background: #16a34a;"></div>
                <span>Verde</span>
              </button>
              <button type="button" class="theme-color" data-color="purple">
                <div class="color-preview" style="background: #9333ea;"></div>
                <span>Morado</span>
              </button>
              <button type="button" class="theme-color" data-color="red">
                <div class="color-preview" style="background: #dc2626;"></div>
                <span>Rojo</span>
              </button>
              <button type="button" class="theme-color" data-color="pink">
                <div class="color-preview" style="background: #ec4899;"></div>
                <span>Rosa</span>
              </button>
              <button type="button" class="theme-color" data-color="magenta">
                <div class="color-preview" style="background: #d946ef;"></div>
                <span>Magenta</span>
              </button>
              <button type="button" class="theme-color" data-color="cyan">
                <div class="color-preview" style="background: #06b6d4;"></div>
                <span>Cian</span>
              </button>
              <button type="button" class="theme-color" data-color="orange">
                <div class="color-preview" style="background: #f97316;"></div>
                <span>Naranja</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Forma del Fondo -->
        <div class="accordion-item">
          <button type="button" class="accordion-header">
             <span>Forma del Fondo</span>
             <span class="accordion-icon">‚ñº</span>
          </button>
          <div class="accordion-content">
            <div class="theme-grid">
              <button type="button" class="theme-shape active" data-shape="orb">
                <div class="shape-preview shape-orb"></div>
                <span>Orb</span>
              </button>
              <button type="button" class="theme-shape" data-shape="triangle">
                <div class="shape-preview shape-triangle"></div>
                <span>Tri√°ngulo</span>
              </button>
              <button type="button" class="theme-shape" data-shape="hexagon">
                <div class="shape-preview shape-hexagon"></div>
                <span>Teseracto</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Cantidad de Part√≠culas -->
        <div class="accordion-item">
          <button type="button" class="accordion-header">
             <span>Cantidad de Part√≠culas</span>
             <span class="accordion-icon">‚ñº</span>
          </button>
          <div class="accordion-content">
            <div class="particle-control" style="padding: 0 4px;">
              <input type="range" id="theme-particles" min="100" max="2000" step="100" value="800" style="width: 100%; margin-bottom: 8px; cursor: pointer;">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary, #666);">
                <span>Pocas</span>
                <span>Muchas</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Transparencia -->
        <div class="accordion-item">
          <button type="button" class="accordion-header">
             <span>Transparencia de Fondo</span>
             <span class="accordion-icon">‚ñº</span>
          </button>
          <div class="accordion-content">
            <div class="transparency-control" style="padding: 0 4px;">
              <input type="range" id="theme-transparency" min="0" max="100" value="0" style="width: 100%; margin-bottom: 8px; cursor: pointer;">
              <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary, #666);">
                <span>Opaco</span>
                <span>Transparente</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions modal-actions">
        <button type="button" id="theme-reset" class="btn">Restablecer</button>
        <button type="button" id="theme-close" class="btn">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // Sistema de temas sincronizado
    (function() {
      // Funci√≥n para aplicar tema
      function applyTheme() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'light';
        const savedColor = localStorage.getItem('selectedColor') || 'default';
        const savedTransparency = parseInt(localStorage.getItem('themeTransparency') || '0');
        
        // Limpiar clases anteriores
        document.body.classList.remove('dark-theme');
        document.body.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-red', 'theme-pink', 'theme-magenta', 'theme-cyan', 'theme-orange');
        document.documentElement.removeAttribute('data-theme');
        
        // Aplicar tema
        if (savedTheme === 'dark') {
          document.body.classList.add('dark-theme');
          document.documentElement.setAttribute('data-theme', 'dark');
        }
        
        // Aplicar color de acento
        if (savedColor !== 'default') {
          document.body.classList.add(`theme-${savedColor}`);
        }

        // Aplicar transparencia
        const isDark = savedTheme === 'dark';
        const baseAlpha = isDark ? 0.88 : 0.96;
        const minAlpha = 0.2;
        const currentAlpha = baseAlpha - (savedTransparency / 100) * (baseAlpha - minAlpha);
        document.documentElement.style.setProperty('--card-bg-alpha', currentAlpha);
      }
      
      // Aplicar tema al cargar
      applyTheme();
      
      // Escuchar cambios en localStorage desde otras p√°ginas
      window.addEventListener('storage', function(e) {
        if (e.key === 'selectedTheme' || e.key === 'selectedColor') {
          applyTheme();
          // Actualizar estados del modal si est√° abierto
          if (typeof updateActiveStates === 'function') {
            updateActiveStates();
          }
        }
      });
      
      // Hacer la funci√≥n global para uso en el modal
      window.applyTheme = applyTheme;
    })();

    // Manejo del modal de tema
    document.addEventListener('DOMContentLoaded', function() {
      const themeBtn = document.getElementById('theme-btn');
      const themeModal = document.getElementById('theme-modal');
      const modalCloseBtn = themeModal.querySelector('.modal-close-btn');
      const themeCloseBtn = document.getElementById('theme-close');
      const themeResetBtn = document.getElementById('theme-reset');
      const themeOptions = document.querySelectorAll('.theme-option');
      const themeColors = document.querySelectorAll('.theme-color');
      const themeShapes = document.querySelectorAll('.theme-shape');
      const themeParticles = document.getElementById('theme-particles');
      const themeTransparency = document.getElementById('theme-transparency');

      // Abrir modal
      (function setupThemeBtnDraggable() {
        if (!themeBtn) return;
        const storageKey = `widget_btn_pos:${location.pathname}:theme-btn`;
        let isDragging = false;
        let hasMoved = false;
        let startX = 0;
        let startY = 0;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        try {
          const saved = localStorage.getItem(storageKey);
          if (saved) {
            const pos = JSON.parse(saved);
            if (pos && typeof pos.left === 'number' && typeof pos.top === 'number') {
              themeBtn.style.position = 'fixed';
              themeBtn.style.left = `${pos.left}px`;
              themeBtn.style.top = `${pos.top}px`;
              themeBtn.style.marginLeft = '0';
              themeBtn.style.zIndex = '10000';
              themeBtn.style.cursor = 'grab';
            }
          }
        } catch (_) {}

        themeBtn.addEventListener('mousedown', (e) => {
          isDragging = true;
          hasMoved = false;
          startX = e.clientX;
          startY = e.clientY;
          const rect = themeBtn.getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left;
          dragOffsetY = e.clientY - rect.top;
          themeBtn.style.cursor = 'grabbing';
          themeBtn.style.transition = 'none';
        });

        window.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;
          const left = e.clientX - dragOffsetX;
          const top = e.clientY - dragOffsetY;

          themeBtn.style.position = 'fixed';
          themeBtn.style.left = `${left}px`;
          themeBtn.style.top = `${top}px`;
          themeBtn.style.marginLeft = '0';
          themeBtn.style.zIndex = '10000';
        });

        window.addEventListener('mouseup', () => {
          if (!isDragging) return;
          isDragging = false;
          themeBtn.style.cursor = 'grab';
          themeBtn.style.transition = '';

          if (hasMoved) {
            const rect = themeBtn.getBoundingClientRect();
            const left = Math.max(0, Math.min(rect.left, window.innerWidth - rect.width));
            const top = Math.max(0, Math.min(rect.top, window.innerHeight - rect.height));
            themeBtn.style.left = `${left}px`;
            themeBtn.style.top = `${top}px`;
            try {
              localStorage.setItem(storageKey, JSON.stringify({ left, top }));
            } catch (_) {}
          }
        });

        themeBtn.addEventListener('click', function(e) {
          if (hasMoved) return;
          themeModal.hidden = false;
          updateActiveStates();
          e.stopPropagation();
        });
      })();

      // L√≥gica de Acorde√≥n
      const accordionHeaders = themeModal.querySelectorAll('.accordion-header');
      accordionHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const item = header.parentElement;
          const isActive = item.classList.contains('active');

          // Cerrar otros items
          themeModal.querySelectorAll('.accordion-item').forEach(otherItem => {
            if (otherItem !== item) {
              otherItem.classList.remove('active');
            }
          });

          // Alternar item actual
          if (!isActive) {
            item.classList.add('active');
          } else {
             item.classList.remove('active');
          }
        });
      });

      // Cerrar modal
      function closeModal() {
        themeModal.hidden = true;
      }

      modalCloseBtn.addEventListener('click', closeModal);
      themeCloseBtn?.addEventListener('click', closeModal);
      themeModal.addEventListener('click', function(e) {
        if (e.target === themeModal) closeModal();
      });

      // Actualizar estados activos
      function updateActiveStates() {
        const currentTheme = localStorage.getItem('selectedTheme') || 'light';
        const currentColor = localStorage.getItem('selectedColor') || 'default';
        const currentShape = localStorage.getItem('selectedShape') || 'orb';
        const currentParticles = localStorage.getItem('particleCount') || '800';
        const currentTransparency = localStorage.getItem('themeTransparency') || '0';

        themeOptions.forEach(option => {
          option.classList.toggle('active', option.dataset.theme === currentTheme);
        });

        themeColors.forEach(color => {
          color.classList.toggle('active', color.dataset.color === currentColor);
        });

        themeShapes.forEach(shape => {
          shape.classList.toggle('active', shape.dataset.shape === currentShape);
        });
        
        if (themeParticles) {
          themeParticles.value = currentParticles;
        }

        if (themeTransparency) {
          themeTransparency.value = currentTransparency;
        }
      }
      
      // Hacer la funci√≥n global
      window.updateActiveStates = updateActiveStates;

      // Cambiar tema
      themeOptions.forEach(option => {
        option.addEventListener('click', function() {
          const theme = this.dataset.theme;
          
          // Guardar en localStorage
          localStorage.setItem('selectedTheme', theme);
          
          // Aplicar tema usando la funci√≥n global
          window.applyTheme();
          
          // Actualizar estados
          updateActiveStates();
          
          // Disparar evento personalizado para sincronizaci√≥n
          window.dispatchEvent(new CustomEvent('themeChanged', { 
            detail: { theme, color: localStorage.getItem('selectedColor') || 'default' }
          }));
        });
      });

      // Cambiar color
      themeColors.forEach(color => {
        color.addEventListener('click', function() {
          const colorName = this.dataset.color;
          
          // Guardar en localStorage
          localStorage.setItem('selectedColor', colorName);
          
          // Aplicar tema usando la funci√≥n global
          window.applyTheme();
          
          // Actualizar estados
          updateActiveStates();
          
          // Disparar evento personalizado para sincronizaci√≥n
          window.dispatchEvent(new CustomEvent('themeChanged', { 
            detail: { theme: localStorage.getItem('selectedTheme') || 'light', color: colorName }
          }));
        });
      });

      // Cambiar forma del fondo
      themeShapes.forEach(shape => {
        shape.addEventListener('click', () => {
          const shapeName = shape.dataset.shape;
          localStorage.setItem('selectedShape', shapeName);
          updateActiveStates();
          window.dispatchEvent(new CustomEvent('shapeChanged', { detail: { shape: shapeName } }));
        });
      });

      // Cambiar cantidad de part√≠culas
      themeParticles?.addEventListener('input', function() {
        localStorage.setItem('particleCount', this.value);
        // No disparamos evento complejo porque index.html no tiene part√≠culas,
        // pero se guarda para cuando se vaya a lista.html
      });

      // Control de transparencia
      themeTransparency?.addEventListener('input', (e) => {
        const val = e.target.value;
        localStorage.setItem('themeTransparency', val);
        window.applyTheme();
        
        window.dispatchEvent(new CustomEvent('themeChanged', { 
          detail: { 
            theme: localStorage.getItem('selectedTheme') || 'light', 
            color: localStorage.getItem('selectedColor') || 'default',
            transparency: val
          }
        }));
      });

      // Interacci√≥n visual durante ajuste de transparencia
      const startTransparencyInteraction = () => {
        themeModal.classList.add('interacting-transparency');
      };
      
      const endTransparencyInteraction = () => {
        themeModal.classList.remove('interacting-transparency');
      };

      themeTransparency?.addEventListener('mousedown', startTransparencyInteraction);
      themeTransparency?.addEventListener('touchstart', startTransparencyInteraction);
      
      themeTransparency?.addEventListener('mouseup', endTransparencyInteraction);
      themeTransparency?.addEventListener('touchend', endTransparencyInteraction);
      themeTransparency?.addEventListener('mouseleave', endTransparencyInteraction);

      themeParticles?.addEventListener('mousedown', startTransparencyInteraction);
      themeParticles?.addEventListener('touchstart', startTransparencyInteraction);
      
      themeParticles?.addEventListener('mouseup', endTransparencyInteraction);
      themeParticles?.addEventListener('touchend', endTransparencyInteraction);
      themeParticles?.addEventListener('mouseleave', endTransparencyInteraction);

      // Restablecer tema
      themeResetBtn?.addEventListener('click', function() {
        localStorage.removeItem('selectedTheme');
        localStorage.removeItem('selectedColor');
        localStorage.removeItem('selectedShape');
        localStorage.removeItem('themeTransparency');
        
        // Aplicar tema usando la funci√≥n global
        window.applyTheme();
        
        // Actualizar estados
        updateActiveStates();
        
        // Resetear forma
        window.dispatchEvent(new CustomEvent('shapeChanged', { 
          detail: { shape: 'orb' } 
        }));

        // Disparar evento personalizado para sincronizaci√≥n
        window.dispatchEvent(new CustomEvent('themeChanged', { 
          detail: { theme: 'light', color: 'default', transparency: '0' }
        }));
      });

      // Cerrar con Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !themeModal.hidden) {
          closeModal();
        }
      });
    });

    (function () {
      function getLocalDateKey(ts) {
        const d = ts ? new Date(ts) : new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
      }

      // Inicializa Firebase si a√∫n no est√°
      const firebaseConfig = {
        apiKey: "AIzaSyA6c3EaIvuPEfM6sTV0YHqCBHuz35ZmNIU",
        authDomain: "zero-strom-web.firebaseapp.com",
        projectId: "zero-strom-web",
        storageBucket: "zero-strom-web.firebasestorage.app",
        messagingSenderId: "758369466349",
        appId: "1:758369466349:web:f2ced362a5a049c70b59e4"
      };

      let db = null;
      try {
        if (typeof firebase !== 'undefined' && firebase.apps) {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          db = firebase.firestore();
          
          // Autenticaci√≥n an√≥nima para permitir reglas basadas en usuarios no registrados
          if (firebase.auth) {
             firebase.auth().onAuthStateChanged((user) => {
              if (!user) {
                firebase.auth().signInAnonymously().catch((err) => {
                  console.error('Error al autenticar an√≥nimamente:', err);
                });
              }
            });
          }
        } else {
           console.warn('Firebase SDK not loaded - Offline mode');
        }
      } catch (e) {
        console.error('Error initializing Firebase:', e);
      }

      const form = document.getElementById('formulario');
      const usuarioSelect = document.getElementById('usuario-registrado');

      // Poblar lista de usuarios registrados desde localStorage y Firestore
      async function collectRegisteredUsers() {
        const set = new Set();
        
        // 1. Obtener desde localStorage (sincrono)
        try {
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          Object.values(byDay).forEach(arr => (arr || []).forEach(it => {
            const original = String(it.usuario || '').trim().replace(/^@/, '');
            if (original) set.add(original);
          }));
          const legacy = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          (legacy || []).forEach(it => {
            const original = String(it.usuario || '').trim().replace(/^@/, '');
            if (original) set.add(original);
          });
        } catch (e) {}
        
        // 2. Intentar obtener desde Firestore (asincrono)
        try {
           if (db) {
             // Desde userStats
             const statsSnap = await db.collection('userStats').get();
             statsSnap.forEach(doc => { if (doc.id) set.add(doc.id); });
             
             // Desde users (si existe)
             const usersSnap = await db.collection('users').orderBy('name').get();
             usersSnap.forEach(doc => { const d=doc.data(); if (d.name) set.add(d.name); });
           }
        } catch (e) { console.warn('Error fetching users from Firestore:', e); }

        const arr = Array.from(set);
        arr.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        return arr;
      }

      async function populateRegisteredUsers() {
        if (!usuarioSelect) return;
        const users = await collectRegisteredUsers();
        usuarioSelect.innerHTML = '<option value="">Selecciona un usuario</option>' +
          users.map(u => `<option value="${u}">@${u}</option>`).join('');
      }

      populateRegisteredUsers();

      // Cargar el √∫ltimo usuario utilizado
      const lastUser = localStorage.getItem('currentUser');
      if (lastUser) {
        const usuarioEl = document.getElementById('usuario');
        if (usuarioEl) {
          usuarioEl.value = lastUser;
          // Actualizar indicador de puntos para el usuario cargado
          // Se difiere la actualizaci√≥n para asegurar que las funciones de gamificaci√≥n est√©n disponibles
          setTimeout(function() {
            if (typeof updatePointsIndicator === 'function') {
              try { updatePointsIndicator(); } catch (e) {}
            }
          }, 0);
        }
      }

      // Actualizar indicador de puntos cuando se selecciona usuario
      function updatePointsIndicator() {
        const usuarioEl = document.getElementById('usuario');
        const usuarioText = (usuarioEl.value || '').trim().replace(/^@/, '');
        const usuarioSel = (usuarioSelect?.value || '').trim().replace(/^@/, '');
        const usuario = usuarioText || usuarioSel;
        
        const pointsIndicator = document.getElementById('user-points-indicator');
        const pointsValue = document.getElementById('header-points');
        
        if (usuario) {
          const data = getGamificationData(usuario);
          pointsValue.textContent = data.points;
          pointsIndicator.style.display = 'flex';
        } else {
          pointsIndicator.style.display = 'none';
        }
      }

      // Event listeners para actualizar puntos
      document.getElementById('usuario')?.addEventListener('input', updatePointsIndicator);
      usuarioSelect?.addEventListener('change', updatePointsIndicator);

      // Flags globales para evitar doble registro y doble ejecuci√≥n
      window.__FORM_SUBMIT_HANDLER_ADDED__ = window.__FORM_SUBMIT_HANDLER_ADDED__ || false;
      window.__FORM_SUBMITTED__ = window.__FORM_SUBMITTED__ || false;

      // Handler de env√≠o (localStorage + Firestore)
      if (form && !window.__FORM_SUBMIT_HANDLER_ADDED__) {
        window.__FORM_SUBMIT_HANDLER_ADDED__ = true;

        form.addEventListener('submit', async function (e) {
          e.preventDefault();

          // Si ya se proces√≥ una vez (por duplicidad), no volver a validar ni alertar
          if (window.__FORM_SUBMITTED__) return;

          const usuarioEl = document.getElementById('usuario');
          const cancionEl = document.getElementById('cancion');
          const artistaEl = document.getElementById('artista');

          const usuarioText = (usuarioEl.value || '').trim().replace(/^@/, '');
          const usuarioSel = (usuarioSelect?.value || '').trim().replace(/^@/, '');
          const usuario = usuarioText || usuarioSel;

          const cancion = (cancionEl.value || '').trim();
          const artista = (artistaEl.value || '').trim();

          if (!usuario || !cancion || !artista) {
            alert('Por favor completa Usuario (escribe o selecciona), Canci√≥n y Artista.');
            return;
          }

          const ts = Date.now();
          const dayKey = getLocalDateKey(ts);

          async function resolveBadgeForUserKey(userKey) {
            try {
              if (!db || !userKey) return '';
              const key = String(userKey || '').trim().replace(/^@/, '').toLowerCase();
              if (!key) return '';

              try {
                const sel = await db.collection('selectedBadges').doc(key).get();
                if (sel && sel.exists) {
                  const d = sel.data() || {};
                  const b = String(d.badge || '').trim();
                  if (b) return b;
                }
              } catch (_) {}

              const order = [
                ['z0PlatinumUsers', 'z0-platino'],
                ['z0VipUsers', 'z0-vip'],
                ['vipUsers', 'vip'],
                ['donadorUsers', 'donador'],
                ['z0FanUsers', 'z0-fan']
              ];
              for (let i = 0; i < order.length; i++) {
                const col = order[i][0];
                const badge = order[i][1];
                try {
                  const docSnap = await db.collection(col).doc(key).get();
                  if (docSnap && docSnap.exists) return badge;
                } catch (_) {}
              }
            } catch (_) {}
            return '';
          }

          const usuarioKey = usuario.toLowerCase();
          const badge = await resolveBadgeForUserKey(usuarioKey);

          // Guardar en localStorage (compatibilidad/local)
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          (byDay[dayKey] ??= []).push({ usuario, cancion, artista, time: ts });
          localStorage.setItem('solicitudes_by_day', JSON.stringify(byDay));

          const arr = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          arr.push({ usuario, cancion, artista, time: ts });
          localStorage.setItem('solicitudes', JSON.stringify(arr));

          // Guardar en Firestore (sincronizaci√≥n multi-dispositivo)
          try {
            if (db) {
              await db.collection('solicitudes').add({
                usuario,
                displayName: usuario,
                badge: badge || '',
                cancion,
                artista,
                day: dayKey,
                ts: firebase.firestore.FieldValue.serverTimestamp(),
              });

              // Upsert del usuario para que aparezca en el panel Admin (colecci√≥n users)
              await db.collection('users')
                .doc(usuario.toLowerCase())
                .set({ name: usuario }, { merge: true });
            } else {
               console.warn('Firestore no disponible. Se guard√≥ localmente.');
               // Opcional: Podr√≠amos mostrar un toast o aviso no bloqueante
            }
          } catch (err) {
            console.error('Error guardando en Firestore:', err);
            // Fallo silencioso en Firestore, ya que se guard√≥ localmente
          }

          // Guardar el √∫ltimo usuario utilizado para facilitar pr√≥ximas solicitudes
          localStorage.setItem('currentUser', usuario);

          // Gamificaci√≥n: puntos se otorgan solo al marcar reproducci√≥n

          // Marca que ya se proces√≥ para evitar que otro handler muestre el alerta
          window.__FORM_SUBMITTED__ = true;

          form.reset();
          window.location.href = 'lista.html';
        });
      }

      // Modo Admin: gesti√≥n de VIP y visualizaci√≥n de usuarios registrados
      const ADMIN_PASS = '1415130*';
      const adminBtn = document.getElementById('admin-btn');
      const adminPanel = document.getElementById('admin-panel');

      // Referencias del modal
      const adminModal = document.getElementById('admin-modal');
      const adminPassInput = document.getElementById('admin-pass-input');
      const adminPassError = document.getElementById('admin-pass-error');
      const adminPassCancelBtn = document.getElementById('admin-pass-cancel');
      const adminPassConfirmBtn = document.getElementById('admin-pass-confirm');

      const vipAddBtn = document.getElementById('vip-add');
      const vipListEl = document.getElementById('vip-list');
      const usersSelectEl = document.getElementById('all-users-select');
      const wipeAllBtn = document.getElementById('wipe-all');

      function normUser(u) {
        return String(u || '').trim().toLowerCase().replace(/^@/, '');
      }
      function escapeHTML(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function getVipUsers() {
        const arr = JSON.parse(localStorage.getItem('vipUsers') || '[]');
        return Array.isArray(arr) ? arr : [];
      }
      function setVipUsers(arr) {
        localStorage.setItem('vipUsers', JSON.stringify(arr));
      }
      function renderVipList() {
        const vipUsers = getVipUsers();
        vipListEl.innerHTML = vipUsers.map(u => `
          <li>
            <span>@${escapeHTML(u)}</span>
            <button type="button" class="remove-btn" data-user="${escapeHTML(u)}">Eliminar</button>
          </li>
        `).join('');
      }
      async function renderAllUsersSelect() {
        if (!usersSelectEl) return;
        const users = await collectRegisteredUsers();
        usersSelectEl.innerHTML = '<option value="">Selecciona un usuario</option>' +
          users.map(u => `<option value="${escapeHTML(u)}">@${escapeHTML(u)}</option>`).join('');
      }

      // Asegurar oculto al cargar
      adminModal && (adminModal.hidden = true);
      adminPanel && (adminPanel.hidden = true);

      // Abrir modal solo al hacer click en "Modo Admin"
      adminBtn?.addEventListener('click', () => {
        if (!adminModal || !adminPassInput || !adminPassError) return;
        adminModal.hidden = false;
        adminPassInput.value = '';
        adminPassError.hidden = true;
        adminPassInput.focus();
      });

      function tryOpenAdmin() {
        const pass = adminPassInput?.value;
        if (pass === ADMIN_PASS) {
          if (!adminModal || !adminPanel) return;
          adminModal.hidden = true;
          adminPanel.hidden = false;
          // Inicializar contenido del panel
          renderVipList?.();
          renderAllUsersSelect?.();
        } else {
          if (!adminPassError || !adminPassInput) return;
          adminPassError.hidden = false;
          adminPassInput.focus();
        }
      }

      adminPassConfirmBtn?.addEventListener('click', tryOpenAdmin);
      adminPassCancelBtn?.addEventListener('click', () => {
        if (adminModal) adminModal.hidden = true; // cerrar modal sin abrir panel
      });
      adminPassInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          tryOpenAdmin();
        }
      });

      vipAddBtn?.addEventListener('click', async () => {
          const raw = usersSelectEl?.value || '';
          const user = normUser(raw);
          if (!user) {
            alert('Selecciona un usuario registrado.');
            return;
          }
          const vipUsers = getVipUsers();
          if (vipUsers.includes(user)) {
            alert('Ese usuario ya es VIP.');
            return;
          }
          
          try {
            await db.collection('vipUsers').doc(user).set({ 
              name: user,
              activatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            vipUsers.push(user);
            setVipUsers(vipUsers);
            renderVipList();
            alert('Usuario VIP agregado correctamente.');
          } catch (err) {
            console.error('Error guardando VIP:', err);
            alert('Error al guardar VIP en la nube.');
          }
        });

      vipListEl?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-btn');
        if (!btn) return;
        const user = btn.getAttribute('data-user');
        if (!user) return;
        const vipUsers = getVipUsers().filter(u => u !== user);
        setVipUsers(vipUsers);
        renderVipList();
      });

      wipeAllBtn?.addEventListener('click', () => {
        const ok = confirm('Esto borrar√° todas las solicitudes guardadas (todos los d√≠as). ¬øQuieres continuar?');
        if (!ok) return;
        localStorage.removeItem('solicitudes_by_day');
        localStorage.removeItem('solicitudes');
        renderAllUsersSelect();
        alert('Solicitudes borradas. La lista est√° limpia.');
      });
    })();
  </script>
<!-- Deploy Trigger: 2026-02-02 Force Update -->
</body>
</html>

<script>
  // Autenticaci√≥n: sesi√≥n an√≥nima autom√°tica para usuarios normales
  firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
      firebase.auth().signInAnonymously().catch((err) => {
        console.error('Error al autenticar an√≥nimamente:', err);
      });
    }
  });

  // ===== FUNCIONES DE GAMIFICACI√ìN =====
  
  function getSongDay(s) {
    const t = s?.timestamp || s?.ts || s?.time;
    try {
      const d = t ? new Date(t) : new Date();
      return d.toISOString().split('T')[0];
    } catch (_) {
      return '';
    }
  }

  // Configuraci√≥n del sistema de puntos
  const POINTS_CONFIG = {
    SONG_REQUEST: 25,
    DAILY_BONUS: 5,
    STREAK_MULTIPLIER: 2,
    VIP_BONUS: 40
  };

  function getGamificationData(usuario) {
    const allStr = localStorage.getItem('gamificationData') || '{}';
    const all = JSON.parse(allStr);
    const u = (usuario || '').toLowerCase();
    const d = all[u];
    return d || {
      points: 0,
      level: 1,
      xp: 0,
      achievements: [],
      streaks: { current: 0, best: 0, lastActivity: null, calendar: {} },
      stats: { totalSongs: 0, uniqueArtists: 0, activeDays: 0, isVip: false }
    };
  }

  function saveGamificationData(usuario, data) {
    if (!usuario || usuario === 'null' || usuario === 'undefined' || usuario.toLowerCase() === 'text/plain') {
      console.warn(`‚ö†Ô∏è Intento de guardar datos para usuario inv√°lido: ${usuario}`);
      return;
    }
    const u = (usuario || '').toLowerCase();
    const allStr = localStorage.getItem('gamificationData') || '{}';
    const all = JSON.parse(allStr);
    all[u] = data;
    localStorage.setItem('gamificationData', JSON.stringify(all));
    try {
      const db = firebase.firestore();
      db.collection('userStats').doc(u).set({
        totalPoints: Number(data.points || 0),
        currentStreak: Number((data.streaks && data.streaks.current) || 0),
        bestStreak: Number((data.streaks && data.streaks.best) || 0),
        lastActivity: (data.streaks && data.streaks.lastActivity) || null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    } catch (_) {}
  }

  function addPoints(usuario, points) {
    const data = getGamificationData(usuario);
    data.points += points;
    data.xp += points;
    const newLevel = calculateLevel(data.xp);
    if (newLevel > data.level) data.level = newLevel;
    saveGamificationData(usuario, data);
    return data;
  }

  function calculateLevel(xp) {
    const levels = [
      { level: 1, xpRequired: 0 },
      { level: 2, xpRequired: 100 },
      { level: 3, xpRequired: 250 },
      { level: 4, xpRequired: 500 },
      { level: 5, xpRequired: 1000 },
      { level: 6, xpRequired: 2000 },
      { level: 7, xpRequired: 5000 }
    ];
    
    for (let i = levels.length - 1; i >= 0; i--) {
      if (xp >= levels[i].xpRequired) {
        return levels[i].level;
      }
    }
    return 1;
  }

  function updateStreak(usuario) {
    const data = getGamificationData(usuario);
    const today = new Date().toISOString().split('T')[0];
    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

    function getRequestsForDay(day) {
      const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
      if (Array.isArray(byDay[day]) && byDay[day].length) return byDay[day];
      const arr = JSON.parse(localStorage.getItem('solicitudes') || '[]');
      return arr.filter(s => {
        const sday = s.day || getSongDay(s);
        return sday === day;
      });
    }

    const norm = v => String(v || '').trim().replace(/^@/, '').toLowerCase();
    const todayRequests = getRequestsForDay(today);
    const distinctUsersToday = new Set(todayRequests.map(s => s && norm(s.usuario))).size;
    const userRequestedToday = todayRequests.some(s => s && norm(s.usuario) === norm(usuario));

    // D√≠a v√°lido: 2+ usuarios distintos y el usuario actual solicit√≥
    const todayValid = distinctUsersToday >= 2 && userRequestedToday;

    if (!todayValid) {
      // D√≠a inv√°lido: no modificar la racha ni el calendario
      saveGamificationData(usuario, data);
      return data.streaks.current;
    }

    // Consecutividad: incrementa solo si ayer tambi√©n fue v√°lido
    const yesterdayValid = !!data.streaks.calendar[yesterday];
    if (yesterdayValid) {
      data.streaks.current++;
    } else if (data.streaks.lastActivity !== today) {
      data.streaks.current = 1;
    }

    // Record: conservar y actualizar si se supera
    if (data.streaks.current > data.streaks.best) {
      data.streaks.best = data.streaks.current;
    }

    data.streaks.lastActivity = today;
    data.streaks.calendar[today] = true; // solo marcamos d√≠as v√°lidos

    saveGamificationData(usuario, data);
    return data.streaks.current;
  }

  (function migrateLegacyGamification(){
    try {
      const keys = Object.keys(localStorage);
      const allStr = localStorage.getItem('gamificationData') || '{}';
      const all = JSON.parse(allStr);
      keys.forEach(k => {
        if (k.startsWith('gamificationData_')) {
          const user = k.replace('gamificationData_','').toLowerCase();
          const d = JSON.parse(localStorage.getItem(k) || '{}');
          if (d && Object.keys(d).length) {
            all[user] = d;
            localStorage.removeItem(k);
          }
        }
      });
      localStorage.setItem('gamificationData', JSON.stringify(all));
    } catch (_){}
  })();
  function calculateUserStats(usuario) {
    const solicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
    const vipUsers = JSON.parse(localStorage.getItem('vipUsers') || '[]');
    
    const userSongs = solicitudes.filter(s => s.usuario === usuario);
    const uniqueArtists = [...new Set(userSongs.map(s => s.artista))].length;
    const uniqueDays = [...new Set(userSongs.map(s => s.fecha?.split('T')[0]))].length;
    const isVip = vipUsers.includes(usuario);

    return {
      totalSongs: userSongs.length,
      uniqueArtists,
      activeDays: uniqueDays,
      isVip
    };
  }

  function processNewSongRequest(usuario) {
    const streakDays = updateStreak(usuario);
    let points = POINTS_CONFIG.SONG_REQUEST;
    
    // Bonus por racha
    if (streakDays > 1) {
      points += POINTS_CONFIG.STREAK_MULTIPLIER * Math.min(streakDays - 1, 10);
    }
    
    // Bonus VIP
    const vipUsers = JSON.parse(localStorage.getItem('vipUsers') || '[]');
    if (vipUsers.includes(usuario)) {
      points += POINTS_CONFIG.VIP_BONUS;
    }
    
    const data = addPoints(usuario, points);
    
    // Actualizar estad√≠sticas
    const stats = calculateUserStats(usuario);
    data.stats = { ...data.stats, ...stats };
    saveGamificationData(usuario, data);
    
    // Mostrar notificaci√≥n de puntos ganados
    showPointsNotification(points, streakDays);
  }

  function showPointsNotification(points, streak) {
    // Crear notificaci√≥n temporal
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 300px;
      font-family: 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    let message = `+${points} puntos ganados! üéµ`;
    if (streak > 1) {
      message += `<br><small>Racha de ${streak} d√≠as! üî•</small>`;
    }
    
    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="font-size: 24px;">üèÜ</div>
        <div style="font-size: 14px; line-height: 1.3;">${message}</div>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Agregar estilos para la animaci√≥n
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);

  // Ejemplo: cuando env√≠as la solicitud, aseg√∫rate de usar serverTimestamp() del SDK compat
  // await db.collection('solicitudes').add({
  //   usuario, cancion, artista, day,
  //   ts: firebase.firestore.FieldValue.serverTimestamp(),
  // });
  (function subscribeAllUserPoints(){
    try {
      const db = firebase.firestore();
      db.collection('userStats').onSnapshot((snap) => {
        const allStr = localStorage.getItem('gamificationData') || '{}';
        const all = JSON.parse(allStr);
        snap.forEach((doc) => {
          const u = (doc.id || '').toLowerCase();
          const d = all[u] || {
            points: 0,
            level: 1,
            xp: 0,
            achievements: [],
            streaks: { current: 0, best: 0, lastActivity: null, calendar: {} },
            stats: { totalSongs: 0, uniqueArtists: 0, activeDays: 0, isVip: false }
          };
          const data = doc.data() || {};
          if (typeof data.totalPoints === 'number') d.points = data.totalPoints;
          if (typeof data.currentStreak === 'number') d.streaks.current = data.currentStreak;
          if (typeof data.bestStreak === 'number') d.streaks.best = data.bestStreak;
          if (typeof data.lastActivity === 'string') d.streaks.lastActivity = data.lastActivity;
          all[u] = d;
        });
        localStorage.setItem('gamificationData', JSON.stringify(all));
        try { if (typeof updatePointsIndicator === 'function') updatePointsIndicator(); } catch (_){}
      });
    } catch (_){}
  })();
  window.debugUserPoints = async function(usuario){
    try {
      const u = String(usuario||'').toLowerCase();
      const db = firebase.firestore();
      const doc = await db.collection('userStats').doc(u).get();
      const cloud = doc.exists ? doc.data() : null;
      const local = (JSON.parse(localStorage.getItem('gamificationData')||'{}')[u])||null;
      return { usuario: u, cloud, local };
    } catch (e) {
      return { error: String(e&&e.message||e) };
    }
  };
</script>
