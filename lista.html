<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista d'Canciones - Zero Radio</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <main class="container">
    <section class="card" aria-labelledby="titulo">
      <div class="title-bar" role="group" aria-label="Barra de t√≠tulo y filtro">
        <h1 id="titulo">Lista de canciones</h1>
        <div class="title-tools">
          <div class="search-box" role="search">
            <span class="search-icon" aria-hidden="true">üîç</span>
            <input id="search-input" type="search" placeholder="Buscar canci√≥n..." aria-label="Buscar canci√≥n" />
            <div id="search-results" class="search-results" hidden></div>
          </div>
          <button id="menu-btn" class="menu-btn" type="button" aria-label="Abrir men√∫" aria-haspopup="true" aria-expanded="false" aria-controls="menu-dropdown">
            <span class="bar bar1"></span>
            <span class="bar bar2"></span>
            <span class="bar bar3"></span>
          </button>
          <div id="menu-dropdown" class="menu-dropdown" hidden>
            <ul class="menu-list" role="menu" aria-label="Acciones">
              <li><a href="index.html" class="menu-item" role="menuitem">Pedir nueva canci√≥n</a></li>
              <li><button type="button" id="menu-search-open" class="menu-item" role="menuitem">Buscar canci√≥n</button></li>
              <li><button type="button" id="menu-changelog-open" class="menu-item" role="menuitem">Mejoras (v1.3)</button></li>
              <li><button type="button" id="menu-admin-open" class="menu-item" role="menuitem">Modo Admin</button></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="day-filter-row" role="group" aria-label="Filtro de d√≠a">
        <div class="day-filter">
          <label for="day-select">Ver d√≠a:</label>
          <select id="day-select"></select>
        </div>
      </div>

      <div class="vip-filter">
        <label><input type="checkbox" id="vip-only" /> Ver solo VIP</label>
      </div>

      <div id="admin-panel" class="admin-panel" hidden>
        <div class="admin-row">
          <label for="all-users-select">Selecciona usuario registrado para VIP:</label>
          <select id="all-users-select" class="user-select" aria-label="Usuarios registrados">
            <option value="">Selecciona un usuario</option>
          </select>
          <div class="admin-btns">
            <button type="button" id="vip-add" class="btn">Agregar</button>
            <button type="button" id="user-delete" class="btn">Borrar usuario</button>
          </div>
        </div>
        <div class="admin-row">
          <strong>Usuarios VIP:</strong>
          <ul id="vip-list" class="vip-list"></ul>
        </div>
        <div class="admin-row">
          <strong>Mantenimiento:</strong>
          <button type="button" id="wipe-all" class="btn">Borrar todas las solicitudes</button>
        </div>
        <div class="admin-row admin-actions">
          <button type="button" id="admin-exit" class="btn">Salir del modo Admin</button>
        </div>
      </div>

      <!-- Modales -->
      <div id="admin-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title">
          <h2 id="admin-modal-title">Modo Admin</h2>
          <p>Inicia sesi√≥n para administrar VIP y mantenimiento</p>
          <div class="field">
            <label for="admin-email-input">Correo</label>
            <input id="admin-email-input" type="email" placeholder="correo@ejemplo.com" />
          </div>
          <div class="field">
            <label for="admin-pass-input">Contrase√±a</label>
            <input id="admin-pass-input" type="password" placeholder="Contrase√±a" />
            <p id="admin-auth-error" class="error" hidden>Credenciales incorrectas o no eres admin.</p>
          </div>
          <div class="actions modal-actions">
            <button type="button" id="admin-pass-cancel" class="btn">Cancelar</button>
            <button type="button" id="admin-pass-confirm" class="btn">Entrar</button>
          </div>
        </div>
      </div>

      <div id="user-delete-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="user-delete-modal-title">
          <h2 id="user-delete-modal-title">Borrar usuario</h2>
          <p>¬øBorrar al usuario "<span id="user-delete-name"></span>" de la lista de registrados?</p>
          <div class="actions modal-actions">
            <button type="button" id="user-delete-cancel" class="btn">Cancelar</button>
            <button type="button" id="user-delete-confirm" class="btn">Borrar</button>
          </div>
        </div>
      </div>

      <div id="vip-remove-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="vip-remove-modal-title">
          <h2 id="vip-remove-modal-title">Quitar VIP</h2>
          <p>¬øQuitar VIP a "<span id="vip-remove-user"></span>"?</p>
          <div class="actions modal-actions">
            <button type="button" id="vip-remove-cancel" class="btn">Cancelar</button>
            <button type="button" id="vip-remove-confirm" class="btn">Quitar</button>
          </div>
        </div>
      </div>

      <div id="wipe-all-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wipe-all-modal-title">
          <h2 id="wipe-all-modal-title">Borrar todas las solicitudes</h2>
          <p>¬øBorrar todas las solicitudes del d√≠a "<span id="wipe-all-day"></span>"?</p>
          <div class="actions modal-actions">
            <button type="button" id="wipe-all-cancel" class="btn">Cancelar</button>
            <button type="button" id="wipe-all-confirm" class="btn">Borrar</button>
          </div>
        </div>
      </div>

      <!-- Modal de cambios por versi√≥n (changelog) -->
      <div id="changelog-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="changelog-modal-title">
          <h2 id="changelog-modal-title">Mejoras por versi√≥n</h2>

          <h3>v1.3 (actual)</h3>
          <ul>
            <li>Buscador con lupita y opci√≥n en men√∫; resultados en tiempo real.</li>
            <li>Modal para ‚ÄúBorrar todas las solicitudes‚Äù (sin pop-up nativo).</li>
            <li>Borrar usuario en Admin con modal y permisos ajustados.</li>
            <li>Tipograf√≠a global Avenir y mejoras de responsive en m√≥viles.</li>
            <li>Panel Admin: botones ‚ÄúAgregar/Borrar‚Äù apilados y selector ajustado.</li>
          </ul>

          <h3>v1.2</h3>
          <ul>
            <li>Quitar VIP con modal (bot√≥n ‚Äú√ó‚Äù).</li>
            <li>Selector de usuarios registrados y gesti√≥n de VIP desde Admin.</li>
            <li>Correcciones de eventos en Admin y limpieza de c√≥digo.</li>
          </ul>

          <h3>v1.1</h3>
          <ul>
            <li>Modo Admin b√°sico, filtro VIP y selecci√≥n de d√≠a.</li>
            <li>Suscripci√≥n en tiempo real a solicitudes y VIP.</li>
          </ul>

          <div class="actions modal-actions">
            <button type="button" id="changelog-close" class="btn">Cerrar</button>
          </div>
        </div>
      </div>

      <section class="list" aria-live="polite">
        <div class="list-header" role="group" aria-label="Encabezados de lista">
          <span class="col col-time">Hora</span>
          <span class="col col-usuario">Usuario</span>
          <span class="col col-cancion">Canci√≥n</span>
          <span class="col col-artista">Artista</span>
        </div>
        <ul id="solicitudes-list" class="items"></ul>
        <p id="empty" class="empty" hidden>A√∫n no hay solicitudes.</p>
      </section>
    </section>
  </main>

  <script>
    (function () {
      const firebaseConfig = {
        apiKey: "AIzaSyA6c3EaIvuPEfM6sTV0YHqCBHuz35ZmNIU",
        authDomain: "zero-strom-web.firebaseapp.com",
        projectId: "zero-strom-web",
        storageBucket: "zero-strom-web.firebasestorage.app",
        messagingSenderId: "758369466349",
        appId: "1:758369466349:web:f2ced362a5a049c70b59e4"
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();
      window.db = db;

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          firebase.auth().signInAnonymously().catch((err) => {
            console.error('Error al iniciar sesi√≥n an√≥nima:', err);
          });
        }
      });

      const solicitudesList = document.getElementById('solicitudes-list');
      const emptyEl = document.getElementById('empty');
      const vipOnly = document.getElementById('vip-only');
      const daySelect = document.getElementById('day-select');

      const allUsersSelect = document.getElementById('all-users-select');
      const vipAddBtn = document.getElementById('vip-add');
      const vipListEl = document.getElementById('vip-list');
      const wipeAllBtn = document.getElementById('wipe-all');

      const vipRemoveModal = document.getElementById('vip-remove-modal');
      const vipRemoveUserSpan = document.getElementById('vip-remove-user');
      const vipRemoveCancelBtn = document.getElementById('vip-remove-cancel');
      const vipRemoveConfirmBtn = document.getElementById('vip-remove-confirm');
      let pendingVipRemoveUser = null;

      let vipSet = new Set();
      let unsubscribeSolicitudes = null;
      let currentDayItems = [];

      function renderSolicitudes(items) {
        solicitudesList.innerHTML = '';
        if (!items.length) {
          emptyEl.hidden = false;
          return;
        }
        emptyEl.hidden = true;
        items.forEach((it) => {
          const isVip = vipSet.has(it.usuario);
          const li = document.createElement('li');
          li.className = isVip ? 'item vip' : 'item';
          li.innerHTML = `
            <span class="col col-time">${it.hora || ''}</span>
            <span class="col col-usuario usuario">${it.usuario}</span>
            <span class="col col-cancion">${it.cancion}</span>
            <span class="col col-artista">${it.artista}</span>
          `;
          solicitudesList.appendChild(li);
        });
      }

      function toHour(ts) {
        if (!ts) return '';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      async function loadDays() {
        const snap = await db.collection('solicitudes').orderBy('day', 'desc').limit(500).get();
        const days = new Set();
        snap.forEach(doc => days.add(doc.data().day));
        const sorted = Array.from(days).sort().reverse();
        daySelect.innerHTML = '';
        sorted.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          daySelect.appendChild(opt);
        });
        if (sorted.length) {
          daySelect.value = sorted[0];
        }

        if (!daySelect.value) {
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          const localDays = Object.keys(byDay).sort().reverse();
          if (localDays.length) {
            daySelect.innerHTML = '';
            localDays.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d;
              opt.textContent = d;
              daySelect.appendChild(opt);
            });
            daySelect.value = localDays[0];
          }
        }
      }

      function subscribeSolicitudesForDay(dayValue) {
        if (unsubscribeSolicitudes) {
          unsubscribeSolicitudes();
          unsubscribeSolicitudes = null;
        }
        const q = db.collection('solicitudes')
          .where('day', '==', dayValue)
          .orderBy('ts', 'desc');

        unsubscribeSolicitudes = q.onSnapshot((snap) => {
          let items = [];
          snap.forEach((doc) => {
            const data = doc.data();
            const isVip = vipSet.has(data.usuario);
            if (vipOnly.checked && !isVip) return;
            items.push({
              usuario: data.usuario,
              cancion: data.cancion,
              artista: data.artista,
              hora: toHour(data.ts),
              day: dayValue
            });
          });

          if (items.length === 0) {
            const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
            const arr = Array.isArray(byDay[dayValue]) ? byDay[dayValue] : [];
            items = arr
              .filter(it => !vipOnly.checked || vipSet.has(it.usuario))
              .map(it => ({
                usuario: it.usuario,
                cancion: it.cancion,
                artista: it.artista,
                hora: toHour(it.time),
                day: dayValue
              }));
          }

          currentDayItems = items;
          renderSolicitudes(items);
        }, (err) => {
          console.error('Error suscripci√≥n solicitudes:', err);
        });
      }

      // Hacer accesible desde el IIFE de UI
      window.subscribeSolicitudesForDay = subscribeSolicitudesForDay;

      // Buscar ignorando acentos y en canci√≥n/artista/usuario
      function searchSolicitudes(query) {
        const normalize = (s) => String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '');

        const q = normalize(query);
        if (!q) return [];

        return currentDayItems.filter(it => {
          const song = normalize(it.cancion);
          const artist = normalize(it.artista);
          const user = normalize(it.usuario);
          return song.includes(q) || artist.includes(q) || user.includes(q);
        });
      }
      window.searchSolicitudes = searchSolicitudes;

      function subscribeVipUsers() {
        db.collection('vipUsers').onSnapshot((snap) => {
          vipSet = new Set();
          vipListEl.innerHTML = '';
          snap.forEach((doc) => {
            const { name } = doc.data();
            if (name) {
              vipSet.add(name);
              const li = document.createElement('li');
              li.innerHTML = `
                <span>${name}</span>
                <button type="button" class="remove-btn" data-user="${name}" aria-label="Quitar VIP">√ó</button>
              `;
              vipListEl.appendChild(li);
            }
          });
          if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
        }, (err) => {
          console.error('Error suscripci√≥n VIP:', err);
        });
      }

      async function renderAllUsersSelect() {
        const snap = await db.collection('users').orderBy('name').get();
        const set = new Set();

        if (!snap.empty) {
          snap.forEach(doc => {
            const { name } = doc.data();
            if (name) set.add(name);
          });
        } else {
          const reqSnap = await db.collection('solicitudes').orderBy('day', 'desc').limit(1000).get();
          reqSnap.forEach(doc => {
            const u = String(doc.data().usuario || '').trim();
            if (u) set.add(u);
          });

          if (set.size === 0) {
            try {
              const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
              Object.values(byDay).forEach(arr => (arr || []).forEach(it => {
                const u = String(it.usuario || '').trim();
                if (u) set.add(u);
              }));
              const legacy = JSON.parse(localStorage.getItem('solicitudes') || '[]');
              (legacy || []).forEach(it => {
                const u = String(it.usuario || '').trim();
                if (u) set.add(u);
              });
            } catch (_) {}
          }
        }

        const list = Array.from(set).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        allUsersSelect.innerHTML = '<option value="">Selecciona un usuario</option>';
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          allUsersSelect.appendChild(opt);
        });
      }
      window.renderAllUsersSelect = renderAllUsersSelect;

      vipAddBtn?.addEventListener('click', async () => {
        const name = allUsersSelect.value.trim();
        if (!name) {
          alert('Selecciona un usuario del listado.');
          return;
        }
        try {
          await db.collection('vipUsers').doc(name).set({ name }, { merge: true });
        } catch (err) {
          console.error('Error al agregar VIP:', err);
          alert('No se pudo agregar el usuario a VIP. Revisa reglas/permisos.');
        }
      });

      vipListEl?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-btn');
        if (!btn) return;
        const user = btn.getAttribute('data-user');
        if (!user) return;

        pendingVipRemoveUser = user;
        vipRemoveUserSpan.textContent = user;
        vipRemoveModal.hidden = false;
      });

      vipRemoveCancelBtn?.addEventListener('click', () => {
        pendingVipRemoveUser = null;
        vipRemoveModal.hidden = true;
      });

      vipRemoveConfirmBtn?.addEventListener('click', async () => {
        if (!pendingVipRemoveUser) return;
        try {
          await db.collection('vipUsers').doc(pendingVipRemoveUser).delete();
        } catch (err) {
          console.error('Error al quitar VIP:', err);
          alert('No se pudo quitar el VIP. Revisa reglas/permisos.');
        } finally {
          pendingVipRemoveUser = null;
          vipRemoveModal.hidden = true;
        }
      });

      const wipeAllModal = document.getElementById('wipe-all-modal');
      const wipeAllDaySpan = document.getElementById('wipe-all-day');
      const wipeAllCancelBtn = document.getElementById('wipe-all-cancel');
      const wipeAllConfirmBtn = document.getElementById('wipe-all-confirm');

      wipeAllBtn?.addEventListener('click', () => {
        if (!daySelect.value) return;
        wipeAllDaySpan.textContent = daySelect.value;
        wipeAllModal.hidden = false;
      });

      wipeAllCancelBtn?.addEventListener('click', () => {
        wipeAllModal.hidden = true;
      });

      wipeAllConfirmBtn?.addEventListener('click', async () => {
        const day = daySelect.value;
        if (!day) {
          wipeAllModal.hidden = true;
          return;
        }

        wipeAllBtn.disabled = true;

        try {
          const snap = await db.collection('solicitudes').where('day', '==', day).get();
          const docs = snap.docs;

          const chunkSize = 500;
          for (let i = 0; i < docs.length; i += chunkSize) {
            const batch = db.batch();
            const chunk = docs.slice(i, i + chunkSize);
            chunk.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
          }

          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          if (byDay && byDay[day]) {
            delete byDay[day];
            localStorage.setItem('solicitudes_by_day', JSON.stringify(byDay));
          }

          if (daySelect.value === day) {
            subscribeSolicitudesForDay(day);
          }
        } catch (err) {
          console.error('Error al borrar solicitudes:', err);
          alert('Ocurri√≥ un error al borrar las solicitudes. Verifica reglas y vuelve a intentar.');
        } finally {
          wipeAllBtn.disabled = false;
          wipeAllModal.hidden = true;
        }
      });

      daySelect?.addEventListener('change', () => {
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      });
      vipOnly?.addEventListener('change', () => {
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      });

      (async function init() {
        await loadDays();
        subscribeVipUsers();
        await renderAllUsersSelect();
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      })();
    })();
  </script>

  <script>
    (function () {
      const menuBtn = document.getElementById('menu-btn');
      const menuDropdown = document.getElementById('menu-dropdown');
      const menuAdminOpen = document.getElementById('menu-admin-open');
      const menuSearchOpen = document.getElementById('menu-search-open');

      // Referencias del changelog (una sola vez)
      const menuChangelogOpen = document.getElementById('menu-changelog-open');
      const changelogModal = document.getElementById('changelog-modal');
      const changelogCloseBtn = document.getElementById('changelog-close');

      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchBox = document.querySelector('.search-box');
      const daySelect = document.getElementById('day-select');

      const ADMIN_PASS = '1415130*';
      const adminModal = document.getElementById('admin-modal');
      const adminPanel = document.getElementById('admin-panel');
      const adminPassInput = document.getElementById('admin-pass-input');
      const adminPassError = document.getElementById('admin-auth-error');
      const adminPassCancelBtn = document.getElementById('admin-pass-cancel');
      const adminPassConfirmBtn = document.getElementById('admin-pass-confirm');
      const allUsersSelect = document.getElementById('all-users-select');
      const vipAddBtn = document.getElementById('vip-add');
      const adminExitBtn = document.getElementById('admin-exit');

      const userDeleteBtn = document.getElementById('user-delete');
      const userDeleteModal = document.getElementById('user-delete-modal');
      const userDeleteNameSpan = document.getElementById('user-delete-name');
      const userDeleteCancelBtn = document.getElementById('user-delete-cancel');
      const userDeleteConfirmBtn = document.getElementById('user-delete-confirm');
      let pendingUserDelete = null;

      function openMenu() {
        if (!menuDropdown) return;
        menuDropdown.hidden = false;
        requestAnimationFrame(() => {
          menuDropdown.classList.add('open');
          menuBtn?.setAttribute('aria-expanded', 'true');
        });
      }
      function closeMenu() {
        if (!menuDropdown) return;
        menuDropdown.classList.remove('open');
        menuBtn?.setAttribute('aria-expanded', 'false');
        const onEnd = (e) => {
          if (e.target !== menuDropdown) return;
          menuDropdown.hidden = true;
          menuDropdown.removeEventListener('transitionend', onEnd);
        };
        menuDropdown.addEventListener('transitionend', onEnd);
      }

      menuBtn?.addEventListener('click', () => {
        if (!menuDropdown) return;
        if (menuDropdown.hidden) {
          openMenu();
        } else {
          closeMenu();
        }
      });

      document.addEventListener('click', (e) => {
        if (!menuDropdown || menuDropdown.hidden) return;
        const clickInside = menuDropdown.contains(e.target) || menuBtn.contains(e.target);
        if (!clickInside) {
          closeMenu();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !menuDropdown.hidden) {
          closeMenu();
        }
      });

      adminModal.hidden = true;
      adminPanel.hidden = true;
      menuAdminOpen?.addEventListener('click', () => {
        closeMenu();
        adminModal.hidden = false;
        adminPassInput.value = '';
        adminPassError.hidden = true;
        adminPassInput.focus();
      });

      function tryOpenAdmin() {
        const pass = adminPassInput.value;
        if (pass === ADMIN_PASS) {
          adminModal.hidden = true;
          adminPanel.hidden = false;
          window.renderAllUsersSelect?.();
        } else {
          adminPassError.hidden = false;
          adminPassInput.focus();
        }
      }

      adminPassConfirmBtn?.addEventListener('click', tryOpenAdmin);
      adminPassCancelBtn?.addEventListener('click', () => {
        adminModal.hidden = true;
      });
      adminPassInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          tryOpenAdmin();
        }
      });

      adminExitBtn?.addEventListener('click', () => {
        adminPanel.hidden = true;
        adminModal.hidden = true;
        adminPassInput.value = '';
        adminPassError.hidden = true;
      });

      userDeleteBtn?.addEventListener('click', () => {
        const name = allUsersSelect.value.trim();
        if (!name) {
          alert('Selecciona un usuario del listado.');
          return;
        }
        if (!userDeleteModal) {
          alert('No se encontr√≥ el modal de borrado de usuario en el HTML.');
          return;
        }
        pendingUserDelete = name;
        userDeleteNameSpan.textContent = name;
        userDeleteModal.hidden = false;
      });

      userDeleteCancelBtn?.addEventListener('click', () => {
        pendingUserDelete = null;
        userDeleteModal.hidden = true;
      });

      userDeleteConfirmBtn?.addEventListener('click', async () => {
        if (!pendingUserDelete) return;
        const name = pendingUserDelete;
        try {
          await window.ensureAuth?.();
          await window.db.collection('users').doc(name.toLowerCase()).delete();
          try { await window.db.collection('vipUsers').doc(name).delete(); } catch (_) {}
          if (typeof window.renderAllUsersSelect === 'function') {
            await window.renderAllUsersSelect();
          } else {
            const opt = Array.from(allUsersSelect.options).find(o => o.value === name);
            if (opt) allUsersSelect.remove(opt.index);
          }
          allUsersSelect.value = '';
        } catch (err) {
          console.error('Error al borrar usuario:', err);
          alert('No se pudo borrar el usuario. Revisa reglas/permisos.');
        } finally {
          pendingUserDelete = null;
          userDeleteModal.hidden = true;
        }
      });

      // Abrir buscador desde el men√∫
      menuSearchOpen?.addEventListener('click', () => {
        closeMenu();
        document.getElementById('search-input')?.focus();
      });

      function renderSearchResults(rows) {
        if (!searchResults) return;
        if (!rows.length) {
          searchResults.hidden = true;
          searchResults.innerHTML = '';
          return;
        }
        const list = rows.slice(0, 10).map(it => `
          <div class="search-result" data-day="${it.day || ''}" tabindex="0">
            <span class="sr-song">${it.cancion}</span>
            <span class="sr-artist">${it.artista}</span>
            <span class="sr-user">${it.usuario}</span>
            <span class="sr-time">${it.hora || ''}</span>
          </div>
        `).join('');
        searchResults.innerHTML = list;
        searchResults.hidden = false;
      }

      function goToDayFromResult(el) {
        const day = el?.dataset?.day;
        if (!day) return;
        daySelect.value = day;
        window.subscribeSolicitudesForDay?.(day);
        searchResults.hidden = true;
        searchResults.innerHTML = '';
        searchInput.value = '';
      }

      // Click en resultado: saltar al d√≠a
      searchResults?.addEventListener('click', (e) => {
        const el = e.target.closest('.search-result');
        if (el) goToDayFromResult(el);
      });

      // Tecla Enter en resultado: saltar al d√≠a
      searchResults?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const el = e.target.closest('.search-result');
          if (el) goToDayFromResult(el);
        }
      });

      searchInput?.addEventListener('input', () => {
        const q = searchInput.value;
        if (!q.trim()) {
          searchResults.hidden = true;
          searchResults.innerHTML = '';
          return;
        }
        const results = typeof window.searchSolicitudes === 'function' ? window.searchSolicitudes(q) : [];
        renderSearchResults(results);
      });

      searchInput?.addEventListener('focus', () => {
        const q = searchInput.value;
        if (q.trim() && typeof window.searchSolicitudes === 'function') {
          renderSearchResults(window.searchSolicitudes(q));
        }
      });

      document.addEventListener('click', (e) => {
        if (!searchBox) return;
        const inside = searchBox.contains(e.target);
        if (!inside) {
          searchResults.hidden = true;
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchResults.hidden = true;
        }
      });

      // Listeners del changelog (un √∫nico bloque)
      menuChangelogOpen?.addEventListener('click', () => {
        closeMenu();
        changelogModal.hidden = false;
      });

      changelogCloseBtn?.addEventListener('click', () => {
        changelogModal.hidden = true;
      });

      changelogModal?.addEventListener('click', (e) => {
        if (e.target === changelogModal) {
          changelogModal.hidden = true;
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !changelogModal.hidden) {
          changelogModal.hidden = true;
        }
      });
    })();
  </script>
</body>
</html>
