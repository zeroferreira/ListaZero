<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista d'Canciones - Zero Radio</title>
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Script de sincronizaci√≥n de temas -->
  <script>
    // Sincronizaci√≥n global de temas entre pesta√±as/ventanas
    window.addEventListener('focus', function() {
      // Cuando la ventana recibe foco, verificar si hay cambios de tema
      if (typeof window.applyTheme === 'function') {
        window.applyTheme();
      }
      if (typeof window.updateActiveStates === 'function') {
        window.updateActiveStates();
      }
    });
  </script>
  
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <main class="container">
    <section class="card" aria-labelledby="titulo">
      <div class="title-bar" role="group" aria-label="Barra de t√≠tulo y filtro">
        <h1 id="titulo">Lista de canciones</h1>
        <div class="title-tools">
          <form class="search-box" role="search" autocomplete="off" data-lpignore="true" data-1p-ignore="true">
            <span class="search-icon" aria-hidden="true">üîç</span>
            <input id="search-input" name="song-search-query" type="search" placeholder="Buscar canci√≥n..." aria-label="Buscar canci√≥n" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" data-form-type="search" data-lpignore="true" data-1p-ignore="true" inputmode="search" enterkeyhint="search" readonly onfocus="this.removeAttribute('readonly');" />
            <div id="search-results" class="search-results" hidden></div>
          </form>
          <button id="theme-btn" class="theme-btn" type="button" aria-label="Cambiar tema" title="Cambiar tema">
            üé®
          </button>
          <button id="menu-btn" class="menu-btn" type="button" aria-label="Abrir men√∫" aria-haspopup="true" aria-expanded="false" aria-controls="menu-dropdown">
            <span class="bar bar1"></span>
            <span class="bar bar2"></span>
            <span class="bar bar3"></span>
          </button>
          <div id="menu-dropdown" class="menu-dropdown" hidden>
            <ul class="menu-list" role="menu" aria-label="Acciones">
              <li><a href="index.html" class="menu-item" role="menuitem">Pedir nueva canci√≥n</a></li>
              <li><button type="button" id="menu-search-open" class="menu-item" role="menuitem">Buscar canci√≥n</button></li>
              <li><button type="button" id="menu-stats-open" class="menu-item" role="menuitem">üìä Estad√≠sticas</button></li>
              <li><button type="button" id="menu-gamification-open" class="menu-item" role="menuitem">üèÜ Mi Perfil</button></li>
              <li><button type="button" id="menu-changelog-open" class="menu-item" role="menuitem">Mejoras (v1.4)</button></li>
              <li><button type="button" id="menu-admin-open" class="menu-item" role="menuitem">Modo Admin</button></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="day-filter-row" role="group" aria-label="Filtro de d√≠a">
        <div class="day-filter">
          <label for="day-select">Ver d√≠a:</label>
          <select id="day-select"></select>
        </div>
      </div>

      <div class="vip-filter">
        <label><input type="checkbox" id="vip-only" /> Ver solo VIP</label>
      </div>

      <div id="admin-panel" class="admin-panel" hidden>
        <div class="admin-row">
          <label for="all-users-select">Selecciona usuario registrado para VIP:</label>
          <select id="all-users-select" class="user-select" aria-label="Usuarios registrados">
            <option value="">Selecciona un usuario</option>
          </select>
          <div class="admin-btns">
            <button type="button" id="vip-add" class="btn">Agregar</button>
            <button type="button" id="user-delete" class="btn">Borrar usuario</button>
          </div>
          <div class="admin-list-section">
            <strong>Usuarios VIP:</strong>
            <ul id="vip-list" class="vip-list"></ul>
          </div>
        </div>
        <div class="admin-row">
          <label for="all-users-select-z0">Selecciona usuario registrado para Z0-VIP:</label>
          <select id="all-users-select-z0" class="user-select" aria-label="Usuarios registrados para Z0-VIP">
            <option value="">Selecciona un usuario</option>
          </select>
          <div class="admin-btns">
            <button type="button" id="z0-vip-add" class="btn">Agregar Z0-VIP</button>
          </div>
          <div class="admin-list-section">
            <strong>Usuarios Z0-VIP:</strong>
            <ul id="z0-vip-list" class="vip-list"></ul>
          </div>
        </div>
        <div class="admin-row">
          <strong>Mantenimiento:</strong>
          <button type="button" id="wipe-all" class="btn">Borrar todas las solicitudes</button>
        </div>
        <div class="admin-row admin-actions">
          <button type="button" id="admin-exit" class="btn">Salir del modo Admin</button>
        </div>
      </div>

      <!-- Modales -->
      <div id="admin-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title">
          <h2 id="admin-modal-title">Modo Admin</h2>
          <p>Inicia sesi√≥n para administrar VIP y mantenimiento</p>
          <div class="field">
            <label for="admin-email-input">Correo</label>
            <input id="admin-email-input" type="email" placeholder="correo@ejemplo.com" autocomplete="off" spellcheck="false" data-form-type="other" />
          </div>
          <div class="field">
            <label for="admin-pass-input">Contrase√±a</label>
            <input id="admin-pass-input" type="password" placeholder="Contrase√±a" autocomplete="new-password" spellcheck="false" data-form-type="other" />
            <p id="admin-auth-error" class="error" hidden>Credenciales incorrectas o no eres admin.</p>
          </div>
          <div class="actions modal-actions">
            <button type="button" id="admin-pass-cancel" class="btn">Cancelar</button>
            <button type="button" id="admin-pass-confirm" class="btn">Entrar</button>
          </div>
        </div>
      </div>

      <div id="user-delete-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="user-delete-modal-title">
          <h2 id="user-delete-modal-title">Borrar usuario</h2>
          <p>¬øBorrar al usuario "<span id="user-delete-name"></span>" de la lista de registrados?</p>
          <div class="actions modal-actions">
            <button type="button" id="user-delete-cancel" class="btn">Cancelar</button>
            <button type="button" id="user-delete-confirm" class="btn">Borrar</button>
          </div>
        </div>
      </div>

      <div id="vip-remove-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="vip-remove-modal-title">
          <h2 id="vip-remove-modal-title">Quitar VIP</h2>
          <p>¬øQuitar VIP a "<span id="vip-remove-user"></span>"?</p>
          <div class="actions modal-actions">
            <button type="button" id="vip-remove-cancel" class="btn">Cancelar</button>
            <button type="button" id="vip-remove-confirm" class="btn">Quitar</button>
          </div>
        </div>
      </div>

      <div id="wipe-all-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wipe-all-modal-title">
          <h2 id="wipe-all-modal-title">Borrar todas las solicitudes</h2>
          <p>¬øBorrar todas las solicitudes del d√≠a "<span id="wipe-all-day"></span>"?</p>
          <div class="actions modal-actions">
            <button type="button" id="wipe-all-cancel" class="btn">Cancelar</button>
            <button type="button" id="wipe-all-confirm" class="btn">Borrar</button>
          </div>
        </div>
      </div>

      <!-- Modal de cambios por versi√≥n (changelog) -->
      <div id="changelog-modal" class="modal-overlay" hidden>
        <div class="modal changelog-modal" role="dialog" aria-modal="true" aria-labelledby="changelog-modal-title">
          <h2 id="changelog-modal-title">Mejoras por versi√≥n</h2>
          
          <div class="changelog-content">
            <h3>v1.4 (actual)</h3>
          <ul>
            <li>üéÆ Modal de gamificaci√≥n con logros, rachas y estad√≠sticas personales.</li>
            <li>üìä Sistema de estad√≠sticas avanzadas con gr√°ficos y m√©tricas detalladas.</li>
            <li>üîç B√∫squeda global mejorada: navega a cualquier fecha con un click.</li>
            <li>üìÖ Resultados de b√∫squeda con fechas formateadas ("Hoy", "Ayer", etc.).</li>
            <li>üé® Sistema de temas completo: modo claro/oscuro con 5 colores de acento.</li>
            <li>üîÑ Sincronizaci√≥n de temas en tiempo real entre todas las p√°ginas abiertas.</li>
            <li>üíæ Persistencia de preferencias de tema con migraci√≥n autom√°tica de datos.</li>
            <li>üéØ Modal de temas redise√±ado con botones de cerrar y restablecer funcionales.</li>
            <li>üì± Centrado perfecto del contenido en pantallas peque√±as y m√≥viles.</li>
            <li>‚ö° B√∫squeda con debounce y indicadores de carga para mejor UX.</li>
            <li>üé® Scrollbars personalizados en secciones de gamificaci√≥n.</li>
            <li>üì± Calendario de actividad reciente centrado y optimizado.</li>
          </ul>

          <h3>v1.3</h3>
          <ul>
            <li>Buscador con lupita y opci√≥n en men√∫; resultados en tiempo real.</li>
            <li>Modal para "Borrar todas las solicitudes" (sin pop-up nativo).</li>
            <li>Borrar usuario en Admin con modal y permisos ajustados.</li>
            <li>Tipograf√≠a global Avenir y mejoras de responsive en m√≥viles.</li>
            <li>Panel Admin: botones "Agregar/Borrar" apilados y selector ajustado.</li>
          </ul>

          <h3>v1.2</h3>
          <ul>
            <li>Quitar VIP con modal (bot√≥n ‚Äú√ó‚Äù).</li>
            <li>Selector de usuarios registrados y gesti√≥n de VIP desde Admin.</li>
            <li>Correcciones de eventos en Admin y limpieza de c√≥digo.</li>
          </ul>

          <h3>v1.1</h3>
          <ul>
            <li>Modo Admin b√°sico, filtro VIP y selecci√≥n de d√≠a.</li>
            <li>Suscripci√≥n en tiempo real a solicitudes y VIP.</li>
          </ul>
          </div>

          <div class="actions modal-actions">
            <button type="button" id="changelog-close" class="btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal de Estad√≠sticas -->
      <div id="stats-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stats-modal-title">
          <h2 id="stats-modal-title">üìä Estad√≠sticas</h2>
          
          <div class="stats-tabs">
            <button type="button" class="stats-tab active" data-tab="general">General</button>
            <button type="button" class="stats-tab" data-tab="songs">Canciones</button>
            <button type="button" class="stats-tab" data-tab="artists">Artistas</button>
            <button type="button" class="stats-tab" data-tab="users">Usuarios</button>
          </div>

          <div class="stats-content">
            <div id="stats-general" class="stats-panel active">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-number" id="total-songs">0</div>
                  <div class="stat-label">Total de canciones</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="total-users">0</div>
                  <div class="stat-label">Usuarios √∫nicos</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="total-artists">0</div>
                  <div class="stat-label">Artistas √∫nicos</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="today-songs">0</div>
                  <div class="stat-label">Canciones hoy</div>
                </div>
              </div>
            </div>

            <div id="stats-songs" class="stats-panel">
              <h3>üéµ Top Canciones</h3>
              <div id="top-songs-list" class="stats-list"></div>
            </div>

            <div id="stats-artists" class="stats-panel">
              <h3>üé§ Top Artistas</h3>
              <div id="top-artists-list" class="stats-list"></div>
            </div>

            <div id="stats-users" class="stats-panel">
              <h3>üë• Usuarios M√°s Activos</h3>
              <div id="top-users-list" class="stats-list"></div>
            </div>
          </div>

          <div class="actions modal-actions">
            <button type="button" id="stats-close" class="btn">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal de Gamificaci√≥n -->
      <div id="gamification-modal" class="modal-overlay" hidden>
        <div class="modal gamification-modal" role="dialog" aria-modal="true" aria-labelledby="gamification-modal-title">
          <button type="button" id="gamification-close-x" class="modal-close-btn" aria-label="Cerrar">√ó</button>
          <h2 id="gamification-modal-title">üèÜ Mi Perfil Musical</h2>
          
          <!-- Informaci√≥n del Usuario -->
          <div class="user-profile">
            <div class="user-avatar">üéµ</div>
            <div class="user-info">
              <h3 id="user-name">Usuario</h3>
              <div class="user-level">
                <span id="user-level-name">Novato</span>
                <span id="user-level-number">Nivel 1</span>
              </div>
            </div>
            <div class="user-points">
              <div class="points-display">
                <span id="user-points">0</span>
                <span class="points-label">puntos</span>
              </div>
            </div>
          </div>

          <!-- Selector de Usuario -->
          <div class="user-selector">
            <label for="gamification-user-select">üë§ Ver perfil de usuario:</label>
            <div class="user-selector-controls">
              <select id="gamification-user-select" class="user-select">
                <option value="">Selecciona un usuario</option>
              </select>
              <button type="button" id="back-to-my-profile" class="btn btn-primary" style="display: none;">
                üë• Cambiar Usuario
              </button>
            </div>
          </div>

          <!-- Barra de Progreso -->
          <div class="level-progress">
            <div class="progress-bar">
              <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text">
              <span id="current-xp">0</span> / <span id="next-level-xp">100</span> XP para el siguiente nivel
            </div>
          </div>

          <!-- Tabs de Gamificaci√≥n -->
          <div class="gamification-tabs">
            <button type="button" class="gamification-tab active" data-tab="achievements">üèÖ Logros</button>
            <button type="button" class="gamification-tab" data-tab="streaks">üî• Rachas</button>
            <button type="button" class="gamification-tab" data-tab="stats">üìà Estad√≠sticas</button>
          </div>

          <div class="gamification-content">
            <!-- Panel de Logros -->
            <div id="gamification-achievements" class="gamification-panel active">
              <div id="achievements-list" class="achievements-grid">
                <!-- Los logros se cargar√°n din√°micamente -->
              </div>
            </div>

            <!-- Panel de Rachas -->
            <div id="gamification-streaks" class="gamification-panel">
              <div class="streaks-container">
                <div class="streak-card">
                  <div class="streak-icon">üî•</div>
                  <div class="streak-info">
                    <h4>Racha Actual</h4>
                    <div class="streak-count" id="current-streak">0 d√≠as</div>
                    <div class="streak-desc">D√≠as consecutivos pidiendo canciones</div>
                  </div>
                </div>
                
                <div class="streak-card">
                  <div class="streak-icon">‚≠ê</div>
                  <div class="streak-info">
                    <h4>Mejor Racha</h4>
                    <div class="streak-count" id="best-streak">0 d√≠as</div>
                    <div class="streak-desc">Tu r√©cord personal</div>
                  </div>
                </div>

                <div class="streak-calendar">
                  <h4>üìÖ Actividad Reciente</h4>
                  <div id="streak-calendar-grid" class="calendar-grid">
                    <!-- El calendario se generar√° din√°micamente -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Panel de Estad√≠sticas Personales -->
            <div id="gamification-stats" class="gamification-panel">
              <div class="personal-stats-container">
                <div class="personal-stats-grid">
                  <div class="stat-card">
                    <div class="stat-icon">üéµ</div>
                    <div class="stat-number" id="personal-total-songs">0</div>
                    <div class="stat-label">Canciones pedidas</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-icon">üé§</div>
                    <div class="stat-number" id="personal-unique-artists">0</div>
                    <div class="stat-label">Artistas √∫nicos</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-number" id="personal-active-days">0</div>
                    <div class="stat-label">D√≠as activos</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-number" id="personal-rank">-</div>
                    <div class="stat-label">Posici√≥n global</div>
                  </div>
                </div>

                <div class="favorite-genres">
                  <h4>üéº Tus G√©neros Favoritos</h4>
                  <div id="favorite-genres-list" class="genres-list">
                    <!-- Se generar√° din√°micamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="actions modal-actions">
          </div>
        </div>
      </div>

      <!-- Modal de Temas -->
      <div id="theme-modal" class="modal-overlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="theme-modal-title">
          <button type="button" class="modal-close-btn" aria-label="Cerrar modal">&times;</button>
          <h2 id="theme-modal-title">üé® Personalizar Tema</h2>
          
          <div class="theme-options">
            <div class="theme-section">
              <h3>Modo de Color</h3>
              <div class="theme-grid">
                <button type="button" class="theme-option active" data-theme="light">
                  <div class="theme-preview light-preview"></div>
                  <span>Claro</span>
                </button>
                <button type="button" class="theme-option" data-theme="dark">
                  <div class="theme-preview dark-preview"></div>
                  <span>Oscuro</span>
                </button>
              </div>
            </div>

            <div class="theme-section">
              <h3>Colores de Acento</h3>
              <div class="theme-grid">
                <button type="button" class="theme-color active" data-color="default">
                  <div class="color-preview" style="background: #000;"></div>
                  <span>Negro</span>
                </button>
                <button type="button" class="theme-color" data-color="blue">
                  <div class="color-preview" style="background: #2563eb;"></div>
                  <span>Azul</span>
                </button>
                <button type="button" class="theme-color" data-color="green">
                  <div class="color-preview" style="background: #16a34a;"></div>
                  <span>Verde</span>
                </button>
                <button type="button" class="theme-color" data-color="purple">
                  <div class="color-preview" style="background: #9333ea;"></div>
                  <span>Morado</span>
                </button>
                <button type="button" class="theme-color" data-color="red">
                  <div class="color-preview" style="background: #dc2626;"></div>
                  <span>Rojo</span>
                </button>
                <button type="button" class="theme-color" data-color="pink">
                  <div class="color-preview" style="background: #ec4899;"></div>
                  <span>Rosa</span>
                </button>
              </div>
            </div>
          </div>

          <div class="actions modal-actions">
            <button type="button" id="theme-reset" class="btn btn-secondary">Restablecer</button>
            <button type="button" id="theme-close" class="btn">Cerrar</button>
          </div>
        </div>
      </div>

      <section class="list" aria-live="polite">
        <div class="list-header" role="group" aria-label="Encabezados de lista">
          <span class="col col-time">Hora</span>
          <span class="col col-usuario">Usuario</span>
          <span class="col col-cancion">Canci√≥n</span>
          <span class="col col-artista">Artista</span>
        </div>
        <ul id="solicitudes-list" class="items"></ul>
        <p id="empty" class="empty" hidden>A√∫n no hay solicitudes.</p>
      </section>
    </section>
  </main>

  <script>
    (function () {
      const firebaseConfig = {
        apiKey: "AIzaSyA6c3EaIvuPEfM6sTV0YHqCBHuz35ZmNIU",
        authDomain: "zero-strom-web.firebaseapp.com",
        projectId: "zero-strom-web",
        storageBucket: "zero-strom-web.firebasestorage.app",
        messagingSenderId: "758369466349",
        appId: "1:758369466349:web:f2ced362a5a049c70b59e4"
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();
      window.db = db;

      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          firebase.auth().signInAnonymously().catch((err) => {
            console.error('Error al iniciar sesi√≥n an√≥nima:', err);
          });
        }
      });

      const solicitudesList = document.getElementById('solicitudes-list');
      const emptyEl = document.getElementById('empty');
      const vipOnly = document.getElementById('vip-only');
      const daySelect = document.getElementById('day-select');

      const allUsersSelect = document.getElementById('all-users-select');
      const vipAddBtn = document.getElementById('vip-add');
      const vipListEl = document.getElementById('vip-list');
      const wipeAllBtn = document.getElementById('wipe-all');

      const vipRemoveModal = document.getElementById('vip-remove-modal');
      const vipRemoveUserSpan = document.getElementById('vip-remove-user');
      const vipRemoveCancelBtn = document.getElementById('vip-remove-cancel');
      const vipRemoveConfirmBtn = document.getElementById('vip-remove-confirm');
      let pendingVipRemoveUser = null;
      let pendingVipRemoveType = 'vip'; // 'vip' o 'z0'

      let vipSet = new Set();
      let z0VipSet = new Set();
      let unsubscribeSolicitudes = null;
      let currentDayItems = [];

      function renderSolicitudes(items) {
        solicitudesList.innerHTML = '';
        if (!items.length) {
          emptyEl.hidden = false;
          return;
        }
        emptyEl.hidden = true;
        items.forEach((it) => {
          const isVip = vipSet.has(it.usuario);
          const isZ0Vip = z0VipSet.has(it.usuario);
          const li = document.createElement('li');
          
          if (isZ0Vip) {
            li.className = 'item z0-vip';
          } else if (isVip) {
            li.className = 'item vip';
          } else {
            li.className = 'item';
          }
          
          li.innerHTML = `
            <span class="col col-time">${it.hora || ''}</span>
            <span class="col col-usuario usuario">${it.usuario}</span>
            <span class="col col-cancion">${it.cancion}</span>
            <span class="col col-artista">${it.artista}</span>
          `;
          solicitudesList.appendChild(li);
        });
        
        // Actualizar selector de usuarios cuando hay nuevos datos
        if (typeof populateUserSelector === 'function') {
          populateUserSelector().catch(console.error);
        }
        
        // Analizar autom√°ticamente nuevos usuarios
        analyzeNewUsersAutomatically().catch(console.error);
      }

      function toHour(ts) {
        if (!ts) return '';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      async function loadDays() {
        const snap = await db.collection('solicitudes').orderBy('day', 'desc').limit(500).get();
        const days = new Set();
        snap.forEach(doc => days.add(doc.data().day));
        const sorted = Array.from(days).sort().reverse();
        daySelect.innerHTML = '';
        sorted.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          daySelect.appendChild(opt);
        });
        if (sorted.length) {
          daySelect.value = sorted[0];
        }

        if (!daySelect.value) {
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          const localDays = Object.keys(byDay).sort().reverse();
          if (localDays.length) {
            daySelect.innerHTML = '';
            localDays.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d;
              opt.textContent = d;
              daySelect.appendChild(opt);
            });
            daySelect.value = localDays[0];
          }
        }
      }

      function subscribeSolicitudesForDay(dayValue) {
        if (unsubscribeSolicitudes) {
          unsubscribeSolicitudes();
          unsubscribeSolicitudes = null;
        }
        const q = db.collection('solicitudes')
          .where('day', '==', dayValue)
          .orderBy('ts', 'desc');

        unsubscribeSolicitudes = q.onSnapshot((snap) => {
          let items = [];
          snap.forEach((doc) => {
            const data = doc.data();
            const isVip = vipSet.has(data.usuario) || z0VipSet.has(data.usuario);
            if (vipOnly.checked && !isVip) return;
            items.push({
              usuario: data.usuario,
              cancion: data.cancion,
              artista: data.artista,
              hora: toHour(data.ts),
              day: dayValue
            });
          });

          if (items.length === 0) {
            const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
            const arr = Array.isArray(byDay[dayValue]) ? byDay[dayValue] : [];
            items = arr
              .filter(it => !vipOnly.checked || vipSet.has(it.usuario) || z0VipSet.has(it.usuario))
              .map(it => ({
                usuario: it.usuario,
                cancion: it.cancion,
                artista: it.artista,
                hora: toHour(it.time),
                day: dayValue
              }));
          }

          currentDayItems = items;
          renderSolicitudes(items);
        }, (err) => {
          console.error('Error suscripci√≥n solicitudes:', err);
        });
      }

      // Hacer accesible desde el IIFE de UI
      window.subscribeSolicitudesForDay = subscribeSolicitudesForDay;

      // Buscar ignorando acentos y en canci√≥n/artista/usuario en TODOS los d√≠as
      async function searchSolicitudes(query) {
        const normalize = (s) => String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '');

        const q = normalize(query);
        if (!q) return [];

        let allResults = [];

        try {
          // Buscar en Firestore
          const firestoreSnapshot = await db.collection('solicitudes').get();
          firestoreSnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.ts && data.ts.toDate) {
              const date = data.ts.toDate();
              const dayValue = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
              
              const song = normalize(data.cancion);
              const artist = normalize(data.artista);
              const user = normalize(data.usuario);
              
              if (song.includes(q) || artist.includes(q) || user.includes(q)) {
                allResults.push({
                  usuario: data.usuario,
                  cancion: data.cancion,
                  artista: data.artista,
                  hora: toHour(data.ts),
                  day: dayValue
                });
              }
            }
          });
        } catch (error) {
          console.log('Error buscando en Firestore, usando localStorage:', error);
        }

        // Buscar tambi√©n en localStorage como respaldo
        const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
        Object.keys(byDay).forEach(dayValue => {
          const dayItems = Array.isArray(byDay[dayValue]) ? byDay[dayValue] : [];
          dayItems.forEach(it => {
            const song = normalize(it.cancion);
            const artist = normalize(it.artista);
            const user = normalize(it.usuario);
            
            if (song.includes(q) || artist.includes(q) || user.includes(q)) {
              // Evitar duplicados de Firestore
              const exists = allResults.some(result => 
                result.cancion === it.cancion && 
                result.artista === it.artista && 
                result.usuario === it.usuario && 
                result.day === dayValue
              );
              
              if (!exists) {
                allResults.push({
                  usuario: it.usuario,
                  cancion: it.cancion,
                  artista: it.artista,
                  hora: toHour(it.time),
                  day: dayValue
                });
              }
            }
          });
        });

        // Ordenar por fecha m√°s reciente primero
        allResults.sort((a, b) => {
          const dateA = new Date(a.day);
          const dateB = new Date(b.day);
          return dateB - dateA;
        });

        return allResults;
      }
      window.searchSolicitudes = searchSolicitudes;

      function subscribeVipUsers() {
        db.collection('vipUsers').onSnapshot((snap) => {
          vipSet = new Set();
          vipListEl.innerHTML = '';
          snap.forEach((doc) => {
            const { name } = doc.data();
            if (name) {
              vipSet.add(name);
              const li = document.createElement('li');
              li.innerHTML = `
                <span>${name}</span>
                <button type="button" class="remove-btn" data-user="${name}" aria-label="Quitar VIP">√ó</button>
              `;
              vipListEl.appendChild(li);
            }
          });
          if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
        }, (err) => {
          console.error('Error suscripci√≥n VIP:', err);
        });
      }

      function subscribeZ0VipUsers() {
        const z0VipListEl = document.getElementById('z0-vip-list');
        db.collection('z0VipUsers').onSnapshot((snap) => {
          z0VipSet = new Set();
          if (z0VipListEl) {
            z0VipListEl.innerHTML = '';
          }
          snap.forEach((doc) => {
            const { name } = doc.data();
            if (name) {
              z0VipSet.add(name);
              if (z0VipListEl) {
                const li = document.createElement('li');
                li.innerHTML = `
                  <span>${name}</span>
                  <button type="button" class="remove-btn" data-user="${name}" data-type="z0" aria-label="Quitar Z0-VIP">√ó</button>
                `;
                z0VipListEl.appendChild(li);
              }
            }
          });
          if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
        }, (err) => {
          console.error('Error suscripci√≥n Z0-VIP:', err);
        });
      }

      async function renderAllUsersSelect() {
        const snap = await db.collection('users').orderBy('name').get();
        const set = new Set();

        if (!snap.empty) {
          snap.forEach(doc => {
            const { name } = doc.data();
            if (name) set.add(name);
          });
        } else {
          const reqSnap = await db.collection('solicitudes').orderBy('day', 'desc').limit(1000).get();
          reqSnap.forEach(doc => {
            const u = String(doc.data().usuario || '').trim();
            if (u) set.add(u);
          });

          if (set.size === 0) {
            try {
              const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
              Object.values(byDay).forEach(arr => (arr || []).forEach(it => {
                const u = String(it.usuario || '').trim();
                if (u) set.add(u);
              }));
              const legacy = JSON.parse(localStorage.getItem('solicitudes') || '[]');
              (legacy || []).forEach(it => {
                const u = String(it.usuario || '').trim();
                if (u) set.add(u);
              });
            } catch (_) {}
          }
        }

        const list = Array.from(set).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
        allUsersSelect.innerHTML = '<option value="">Selecciona un usuario</option>';
        const allUsersSelectZ0 = document.getElementById('all-users-select-z0');
        if (allUsersSelectZ0) {
          allUsersSelectZ0.innerHTML = '<option value="">Selecciona un usuario</option>';
        }
        list.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          allUsersSelect.appendChild(opt);
          
          if (allUsersSelectZ0) {
            const optZ0 = document.createElement('option');
            optZ0.value = name;
            optZ0.textContent = name;
            allUsersSelectZ0.appendChild(optZ0);
          }
        });
      }
      window.renderAllUsersSelect = renderAllUsersSelect;

      vipAddBtn?.addEventListener('click', async () => {
        const name = allUsersSelect.value.trim();
        if (!name) {
          alert('Selecciona un usuario del listado.');
          return;
        }
        try {
          await db.collection('vipUsers').doc(name).set({ name }, { merge: true });
        } catch (err) {
          console.error('Error al agregar VIP:', err);
          alert('No se pudo agregar el usuario a VIP. Revisa reglas/permisos.');
        }
      });

      const z0VipAddBtn = document.getElementById('z0-vip-add');
      z0VipAddBtn?.addEventListener('click', async () => {
        const allUsersSelectZ0 = document.getElementById('all-users-select-z0');
        const name = allUsersSelectZ0?.value.trim();
        if (!name) {
          alert('Selecciona un usuario del listado.');
          return;
        }
        try {
          await db.collection('z0VipUsers').doc(name).set({ name }, { merge: true });
        } catch (err) {
          console.error('Error al agregar Z0-VIP:', err);
          alert('No se pudo agregar el usuario a Z0-VIP. Revisa reglas/permisos.');
        }
      });

      vipListEl?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-btn');
        if (!btn) return;
        const user = btn.getAttribute('data-user');
        if (!user) return;

        pendingVipRemoveUser = user;
        pendingVipRemoveType = 'vip';
        vipRemoveUserSpan.textContent = user;
        vipRemoveModal.hidden = false;
      });

      const z0VipListEl = document.getElementById('z0-vip-list');
      z0VipListEl?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-btn');
        if (!btn) return;
        const user = btn.getAttribute('data-user');
        const type = btn.getAttribute('data-type');
        if (!user) return;

        pendingVipRemoveUser = user;
        pendingVipRemoveType = type || 'z0';
        vipRemoveUserSpan.textContent = user;
        vipRemoveModal.hidden = false;
      });

      vipRemoveCancelBtn?.addEventListener('click', () => {
        pendingVipRemoveUser = null;
        pendingVipRemoveType = 'vip';
        vipRemoveModal.hidden = true;
      });

      vipRemoveConfirmBtn?.addEventListener('click', async () => {
        if (!pendingVipRemoveUser) return;
        try {
          const collection = pendingVipRemoveType === 'z0' ? 'z0VipUsers' : 'vipUsers';
          await db.collection(collection).doc(pendingVipRemoveUser).delete();
        } catch (err) {
          console.error('Error al quitar VIP:', err);
          alert('No se pudo quitar el VIP. Revisa reglas/permisos.');
        } finally {
          pendingVipRemoveUser = null;
          pendingVipRemoveType = 'vip';
          vipRemoveModal.hidden = true;
        }
      });

      const wipeAllModal = document.getElementById('wipe-all-modal');
      const wipeAllDaySpan = document.getElementById('wipe-all-day');
      const wipeAllCancelBtn = document.getElementById('wipe-all-cancel');
      const wipeAllConfirmBtn = document.getElementById('wipe-all-confirm');

      wipeAllBtn?.addEventListener('click', () => {
        if (!daySelect.value) return;
        wipeAllDaySpan.textContent = daySelect.value;
        wipeAllModal.hidden = false;
      });

      wipeAllCancelBtn?.addEventListener('click', () => {
        wipeAllModal.hidden = true;
      });

      wipeAllConfirmBtn?.addEventListener('click', async () => {
        const day = daySelect.value;
        if (!day) {
          wipeAllModal.hidden = true;
          return;
        }

        wipeAllBtn.disabled = true;

        try {
          const snap = await db.collection('solicitudes').where('day', '==', day).get();
          const docs = snap.docs;

          const chunkSize = 500;
          for (let i = 0; i < docs.length; i += chunkSize) {
            const batch = db.batch();
            const chunk = docs.slice(i, i + chunkSize);
            chunk.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
          }

          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          if (byDay && byDay[day]) {
            delete byDay[day];
            localStorage.setItem('solicitudes_by_day', JSON.stringify(byDay));
          }

          if (daySelect.value === day) {
            subscribeSolicitudesForDay(day);
          }
        } catch (err) {
          console.error('Error al borrar solicitudes:', err);
          alert('Ocurri√≥ un error al borrar las solicitudes. Verifica reglas y vuelve a intentar.');
        } finally {
          wipeAllBtn.disabled = false;
          wipeAllModal.hidden = true;
        }
      });

      daySelect?.addEventListener('change', () => {
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      });
      vipOnly?.addEventListener('change', () => {
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      });

      (async function init() {
        await loadDays();
        subscribeVipUsers();
        subscribeZ0VipUsers();
        await renderAllUsersSelect();
        if (daySelect.value) subscribeSolicitudesForDay(daySelect.value);
      })();
    })();
  </script>

  <script>
    // Variables globales del men√∫
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    // Funciones globales del men√∫
    function openMenu() {
      if (!menuDropdown) return;
      menuDropdown.hidden = false;
      requestAnimationFrame(() => {
        menuDropdown.classList.add('open');
        menuBtn?.setAttribute('aria-expanded', 'true');
      });
    }
    
    function closeMenu() {
      if (!menuDropdown) return;
      menuDropdown.classList.remove('open');
      menuBtn?.setAttribute('aria-expanded', 'false');
      const onEnd = (e) => {
        if (e.target !== menuDropdown) return;
        menuDropdown.hidden = true;
        menuDropdown.removeEventListener('transitionend', onEnd);
      };
      menuDropdown.addEventListener('transitionend', onEnd);
    }

    (function () {
      const menuAdminOpen = document.getElementById('menu-admin-open');
      const menuSearchOpen = document.getElementById('menu-search-open');

      // Referencias del changelog (una sola vez)
      const menuChangelogOpen = document.getElementById('menu-changelog-open');
      const changelogModal = document.getElementById('changelog-modal');
      const changelogCloseBtn = document.getElementById('changelog-close');

      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchBox = document.querySelector('.search-box');
      const daySelect = document.getElementById('day-select');

      const ADMIN_PASS = '1415130*';
      const adminModal = document.getElementById('admin-modal');
      const adminPanel = document.getElementById('admin-panel');
      const adminPassInput = document.getElementById('admin-pass-input');
      const adminPassError = document.getElementById('admin-auth-error');
      const adminPassCancelBtn = document.getElementById('admin-pass-cancel');
      const adminPassConfirmBtn = document.getElementById('admin-pass-confirm');
      const allUsersSelect = document.getElementById('all-users-select');
      const vipAddBtn = document.getElementById('vip-add');
      const adminExitBtn = document.getElementById('admin-exit');

      const userDeleteBtn = document.getElementById('user-delete');
      const userDeleteModal = document.getElementById('user-delete-modal');
      const userDeleteNameSpan = document.getElementById('user-delete-name');
      const userDeleteCancelBtn = document.getElementById('user-delete-cancel');
      const userDeleteConfirmBtn = document.getElementById('user-delete-confirm');
      let pendingUserDelete = null;

      menuBtn?.addEventListener('click', () => {
        if (!menuDropdown) return;
        if (menuDropdown.hidden) {
          openMenu();
        } else {
          closeMenu();
        }
      });

      document.addEventListener('click', (e) => {
        if (!menuDropdown || menuDropdown.hidden) return;
        const clickInside = menuDropdown.contains(e.target) || menuBtn.contains(e.target);
        if (!clickInside) {
          closeMenu();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !menuDropdown.hidden) {
          closeMenu();
        }
      });

      adminModal.hidden = true;
      adminPanel.hidden = true;
      menuAdminOpen?.addEventListener('click', () => {
        closeMenu();
        adminModal.hidden = false;
        adminPassInput.value = '';
        adminPassError.hidden = true;
        adminPassInput.focus();
      });

      function tryOpenAdmin() {
        const pass = adminPassInput.value;
        if (pass === ADMIN_PASS) {
          adminModal.hidden = true;
          adminPanel.hidden = false;
          window.renderAllUsersSelect?.();
        } else {
          adminPassError.hidden = false;
          adminPassInput.focus();
        }
      }

      adminPassConfirmBtn?.addEventListener('click', tryOpenAdmin);
      adminPassCancelBtn?.addEventListener('click', () => {
        adminModal.hidden = true;
      });
      adminPassInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          tryOpenAdmin();
        }
      });

      adminExitBtn?.addEventListener('click', () => {
        adminPanel.hidden = true;
        adminModal.hidden = true;
        adminPassInput.value = '';
        adminPassError.hidden = true;
      });

      userDeleteBtn?.addEventListener('click', () => {
        const name = allUsersSelect.value.trim();
        if (!name) {
          alert('Selecciona un usuario del listado.');
          return;
        }
        if (!userDeleteModal) {
          alert('No se encontr√≥ el modal de borrado de usuario en el HTML.');
          return;
        }
        pendingUserDelete = name;
        userDeleteNameSpan.textContent = name;
        userDeleteModal.hidden = false;
      });

      userDeleteCancelBtn?.addEventListener('click', () => {
        pendingUserDelete = null;
        userDeleteModal.hidden = true;
      });

      userDeleteConfirmBtn?.addEventListener('click', async () => {
        if (!pendingUserDelete) return;
        const name = pendingUserDelete;
        try {
          await window.ensureAuth?.();
          await window.db.collection('users').doc(name.toLowerCase()).delete();
          try { await window.db.collection('vipUsers').doc(name).delete(); } catch (_) {}
          if (typeof window.renderAllUsersSelect === 'function') {
            await window.renderAllUsersSelect();
          } else {
            const opt = Array.from(allUsersSelect.options).find(o => o.value === name);
            if (opt) allUsersSelect.remove(opt.index);
          }
          allUsersSelect.value = '';
        } catch (err) {
          console.error('Error al borrar usuario:', err);
          alert('No se pudo borrar el usuario. Revisa reglas/permisos.');
        } finally {
          pendingUserDelete = null;
          userDeleteModal.hidden = true;
        }
      });

      // Abrir buscador desde el men√∫
      menuSearchOpen?.addEventListener('click', () => {
        closeMenu();
        document.getElementById('search-input')?.focus();
      });

      function renderSearchResults(rows) {
        if (!searchResults) return;
        if (!rows.length) {
          searchResults.hidden = true;
          searchResults.innerHTML = '';
          return;
        }
        const list = rows.slice(0, 10).map(it => {
          // Formatear fecha para mostrar
          const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (dateStr === today.toISOString().split('T')[0]) {
              return 'Hoy';
            } else if (dateStr === yesterday.toISOString().split('T')[0]) {
              return 'Ayer';
            } else {
              return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit',
                year: '2-digit'
              });
            }
          };
          
          return `
            <div class="search-result" data-day="${it.day || ''}" tabindex="0" title="Click para ir a la fecha: ${formatDate(it.day)}">
              <span class="sr-song">${it.cancion}</span>
              <span class="sr-artist">${it.artista}</span>
              <span class="sr-user">${it.usuario}</span>
              <span class="sr-date">${formatDate(it.day)}</span>
              <span class="sr-arrow">‚Üí</span>
            </div>
          `;
        }).join('');
        searchResults.innerHTML = list;
        searchResults.hidden = false;
      }

      function goToDayFromResult(el) {
        const day = el?.dataset?.day;
        if (!day) return;
        daySelect.value = day;
        window.subscribeSolicitudesForDay?.(day);
        searchResults.hidden = true;
        searchResults.innerHTML = '';
        searchInput.value = '';
      }

      // Click en resultado: saltar al d√≠a
      searchResults?.addEventListener('click', (e) => {
        const el = e.target.closest('.search-result');
        if (el) goToDayFromResult(el);
      });

      // Tecla Enter en resultado: saltar al d√≠a
      searchResults?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const el = e.target.closest('.search-result');
          if (el) goToDayFromResult(el);
        }
      });

      let searchTimeout;
      searchInput?.addEventListener('input', async () => {
        const q = searchInput.value;
        
        // Limpiar timeout anterior
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        if (!q.trim()) {
          searchResults.hidden = true;
          searchResults.innerHTML = '';
          return;
        }
        
        // Mostrar indicador de carga inmediatamente
        searchResults.innerHTML = '<div class="search-loading">Buscando...</div>';
        searchResults.hidden = false;
        
        // Debounce de 300ms
        searchTimeout = setTimeout(async () => {
          try {
            const results = typeof window.searchSolicitudes === 'function' ? await window.searchSolicitudes(q) : [];
            renderSearchResults(results);
          } catch (error) {
            console.error('Error en b√∫squeda:', error);
            searchResults.innerHTML = '<div class="search-error">Error en la b√∫squeda</div>';
          }
        }, 300);
      });

      searchInput?.addEventListener('focus', async () => {
        const q = searchInput.value;
        if (q.trim() && typeof window.searchSolicitudes === 'function') {
          try {
            const results = await window.searchSolicitudes(q);
            renderSearchResults(results);
          } catch (error) {
            console.error('Error en b√∫squeda:', error);
          }
        }
      });

      document.addEventListener('click', (e) => {
        if (!searchBox) return;
        const inside = searchBox.contains(e.target);
        if (!inside) {
          searchResults.hidden = true;
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchResults.hidden = true;
        }
      });

      // Listeners del changelog (un √∫nico bloque)
      menuChangelogOpen?.addEventListener('click', () => {
        closeMenu();
        hideSearchResults();
        changelogModal.hidden = false;
      });

      changelogCloseBtn?.addEventListener('click', () => {
        changelogModal.hidden = true;
      });

      changelogModal?.addEventListener('click', (e) => {
        if (e.target === changelogModal) {
          changelogModal.hidden = true;
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !changelogModal.hidden) {
          changelogModal.hidden = true;
        }
      });

      // Animaci√≥n del placeholder del campo de b√∫squeda
      function animatePlaceholder() {
        const searchInput = document.getElementById('search-input');
        if (!searchInput) return;

        // Detectar si es un dispositivo m√≥vil o pantalla ultra ancha
        const isMobile = window.innerWidth <= 768 || (window.innerWidth > 2600 && window.innerHeight < 650);
        const texts = ['Buscar canci√≥n...', 'Buscar artista...'];
        let currentIndex = 0;
        let isDeleting = false;
        let currentText = '';
        let charIndex = 0;
        let animationTimeout = null;

        function typeEffect() {
          // Verificar si el elemento a√∫n existe y no tiene foco
          if (!searchInput || document.activeElement === searchInput) {
            return;
          }

          const fullText = texts[currentIndex];
          
          if (isDeleting) {
            currentText = fullText.substring(0, charIndex - 1);
            charIndex--;
          } else {
            currentText = fullText.substring(0, charIndex + 1);
            charIndex++;
          }

          // Usar requestAnimationFrame para mejor rendimiento en m√≥viles
          requestAnimationFrame(() => {
            if (searchInput && document.activeElement !== searchInput) {
              searchInput.placeholder = currentText;
            }
          });

          // Ajustar velocidades para dispositivos m√≥viles
          let typeSpeed = isMobile ? 150 : 100;
          if (isDeleting) {
            typeSpeed = isMobile ? 75 : 50;
          }

          if (!isDeleting && charIndex === fullText.length) {
            // Pausa al completar el texto
            typeSpeed = isMobile ? 2000 : 3000;
            isDeleting = true;
          } else if (isDeleting && charIndex === 0) {
            isDeleting = false;
            currentIndex = (currentIndex + 1) % texts.length;
            typeSpeed = isMobile ? 300 : 500;
          }

          animationTimeout = setTimeout(typeEffect, typeSpeed);
        }

        // Limpiar timeout anterior si existe
        if (window.placeholderTimeout) {
          clearTimeout(window.placeholderTimeout);
        }

        // Solo iniciar la animaci√≥n si el campo no tiene foco
        if (document.activeElement !== searchInput) {
          typeEffect();
        }

        // Pausar animaci√≥n cuando el usuario hace foco en el campo
        const focusHandler = () => {
          if (animationTimeout) {
            clearTimeout(animationTimeout);
            animationTimeout = null;
          }
          if (window.placeholderTimeout) {
            clearTimeout(window.placeholderTimeout);
          }
          searchInput.placeholder = 'Escribe para buscar...';
        };

        // Reanudar animaci√≥n cuando el usuario sale del campo (si est√° vac√≠o)
        const blurHandler = () => {
          if (!searchInput.value.trim()) {
            window.placeholderTimeout = setTimeout(() => {
              if (document.activeElement !== searchInput) {
                animatePlaceholder();
              }
            }, 1000);
          }
        };

        // Remover listeners anteriores para evitar duplicados
        searchInput.removeEventListener('focus', focusHandler);
        searchInput.removeEventListener('blur', blurHandler);
        
        // Agregar nuevos listeners
        searchInput.addEventListener('focus', focusHandler);
        searchInput.addEventListener('blur', blurHandler);
      }

      // Funci√≥n para limpiar la animaci√≥n del placeholder
      function cleanupPlaceholderAnimation() {
        if (window.placeholderTimeout) {
          clearTimeout(window.placeholderTimeout);
          window.placeholderTimeout = null;
        }
      }

      // Iniciar la animaci√≥n despu√©s de un breve delay
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isUltraWide = window.innerWidth > 2600 && window.innerHeight < 650;
      const isNubiaZ70Ultra = window.innerWidth === 2688 && window.innerHeight === 1216;
      
      // Activar animaci√≥n en desktop, ultra wide, o Nubia Z70 Ultra espec√≠ficamente
      if (!isTouchDevice || isUltraWide || isNubiaZ70Ultra) {
        setTimeout(animatePlaceholder, 1000);
      } else {
        // En otros dispositivos t√°ctiles, usar placeholder est√°tico
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.placeholder = 'Buscar canci√≥n...';
        }
      }

      // Limpiar animaci√≥n al cambiar de p√°gina
      window.addEventListener('beforeunload', cleanupPlaceholderAnimation);

      // ===== FUNCIONALIDAD DE ESTAD√çSTICAS =====
      const statsModal = document.getElementById('stats-modal');
      const statsCloseBtn = document.getElementById('stats-close');
      const menuStatsOpen = document.getElementById('menu-stats-open');
      const statsTabs = document.querySelectorAll('.stats-tab');
      const statsPanels = document.querySelectorAll('.stats-panel');

      // Funci√≥n para ocultar buscador
      function hideSearchResults() {
        const searchResults = document.getElementById('search-results');
        const searchInput = document.getElementById('search-input');
        if (searchResults) searchResults.hidden = true;
        if (searchInput) searchInput.blur();
      }

      // Abrir modal de estad√≠sticas
      menuStatsOpen?.addEventListener('click', async () => {
        closeMenu();
        hideSearchResults();
        statsModal.hidden = false;
        await calculateStats();
      });

      // Cerrar modal de estad√≠sticas
      statsCloseBtn?.addEventListener('click', () => {
        statsModal.hidden = true;
      });

      // Cambiar tabs de estad√≠sticas
      statsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          // Actualizar tabs activos
          statsTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Mostrar panel correspondiente
          statsPanels.forEach(panel => {
            panel.classList.remove('active');
            if (panel.id === `stats-${targetTab}`) {
              panel.classList.add('active');
            }
          });
        });
      });

      // Calcular estad√≠sticas
      async function calculateStats() {
        try {
          // Mostrar indicador de carga
          document.getElementById('total-songs').textContent = '...';
          document.getElementById('total-users').textContent = '...';
          document.getElementById('total-artists').textContent = '...';
          document.getElementById('today-songs').textContent = '...';
          
          // Obtener todas las solicitudes de Firestore
          const firestoreSnapshot = await db.collection('solicitudes').get();
          const firestoreSolicitudes = [];
          
          firestoreSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.usuario && data.cancion && data.artista) {
              firestoreSolicitudes.push({
                usuario: data.usuario,
                cancion: data.cancion,
                artista: data.artista,
                day: data.day,
                ts: data.ts ? data.ts.toMillis() : Date.now()
              });
            }
          });
          
          // Obtener solicitudes de localStorage como respaldo
          const localSolicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          
          // Combinar datos de Firestore y localStorage, evitando duplicados
          const allSolicitudesMap = new Map();
          
          // Agregar solicitudes de Firestore
          firestoreSolicitudes.forEach(s => {
            const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.ts}`;
            allSolicitudesMap.set(key, s);
          });
          
          // Agregar solicitudes de localStorage que no est√©n en Firestore
          localSolicitudes.forEach(s => {
            const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.time}`;
            if (!allSolicitudesMap.has(key)) {
              allSolicitudesMap.set(key, {
                usuario: s.usuario,
                cancion: s.cancion,
                artista: s.artista,
                ts: s.time
              });
            }
          });
          
          // Agregar solicitudes de byDay que no est√©n incluidas
          Object.values(byDay).flat().forEach(s => {
            const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.time}`;
            if (!allSolicitudesMap.has(key)) {
              allSolicitudesMap.set(key, {
                usuario: s.usuario,
                cancion: s.cancion,
                artista: s.artista,
                ts: s.time
              });
            }
          });
          
          const allSolicitudes = Array.from(allSolicitudesMap.values());
          
          // Estad√≠sticas generales
          const totalSongs = allSolicitudes.length;
          const uniqueUsers = new Set(allSolicitudes.map(s => s.usuario)).size;
          const uniqueArtists = new Set(allSolicitudes.map(s => s.artista)).size;
          
          // Canciones de hoy
          const today = new Date();
          const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
          const todaySongs = allSolicitudes.filter(s => {
            const date = new Date(s.ts);
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            return dateKey === todayKey;
          }).length;
          
          // Actualizar n√∫meros generales
          document.getElementById('total-songs').textContent = totalSongs;
          document.getElementById('total-users').textContent = uniqueUsers;
          document.getElementById('total-artists').textContent = uniqueArtists;
          document.getElementById('today-songs').textContent = todaySongs;
          
          // Top canciones
          const songCounts = {};
          allSolicitudes.forEach(s => {
            const key = `${s.cancion} - ${s.artista}`;
            songCounts[key] = (songCounts[key] || 0) + 1;
          });
          
          const topSongs = Object.entries(songCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
          
          renderStatsList('top-songs-list', topSongs);
          
          // Top artistas
          const artistCounts = {};
          allSolicitudes.forEach(s => {
            artistCounts[s.artista] = (artistCounts[s.artista] || 0) + 1;
          });
          
          const topArtists = Object.entries(artistCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
          
          renderStatsList('top-artists-list', topArtists);
          
          // Top usuarios
          const userCounts = {};
          allSolicitudes.forEach(s => {
            userCounts[s.usuario] = (userCounts[s.usuario] || 0) + 1;
          });
          
          const topUsers = Object.entries(userCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
          
          renderStatsList('top-users-list', topUsers);
          
        } catch (error) {
          console.error('Error calculando estad√≠sticas:', error);
          
          // Fallback a datos locales en caso de error
          const allSolicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
          
          const totalSongs = allSolicitudes.length;
          const uniqueUsers = new Set(allSolicitudes.map(s => s.usuario)).size;
          const uniqueArtists = new Set(allSolicitudes.map(s => s.artista)).size;
          
          const today = new Date();
          const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
          const todaySongs = (byDay[todayKey] || []).length;
          
          document.getElementById('total-songs').textContent = totalSongs + ' (local)';
          document.getElementById('total-users').textContent = uniqueUsers + ' (local)';
          document.getElementById('total-artists').textContent = uniqueArtists + ' (local)';
          document.getElementById('today-songs').textContent = todaySongs + ' (local)';
          
          // Mostrar mensaje de error en las listas
          ['top-songs-list', 'top-artists-list', 'top-users-list'].forEach(id => {
            const container = document.getElementById(id);
            if (container) {
              container.innerHTML = '<div class="stats-item">Error cargando datos. Mostrando datos locales.</div>';
            }
          });
        }
      }

      function renderStatsList(containerId, items) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        if (items.length === 0) {
          container.innerHTML = '<div class="stats-item">No hay datos disponibles</div>';
          return;
        }
        
        container.innerHTML = items.map(([name, count], index) => `
          <div class="stats-item">
            <span class="stats-item-name">${index + 1}. ${name}</span>
            <span class="stats-item-count">${count}</span>
          </div>
        `).join('');
      }

      // ===== FUNCIONALIDAD DE TEMAS =====
      const themeModal = document.getElementById('theme-modal');
      const themeBtn = document.getElementById('theme-btn');
      const themeCloseBtn = document.getElementById('theme-close');
      const themeCloseBtnX = themeModal?.querySelector('.modal-close-btn');
      const themeResetBtn = document.getElementById('theme-reset');
      const themeOptions = document.querySelectorAll('.theme-option');
      const themeColors = document.querySelectorAll('.theme-color');

      // Migrar datos de tema de claves antiguas a nuevas (solo una vez)
      (function migrateThemeData() {
        const oldTheme = localStorage.getItem('app-theme');
        const oldColor = localStorage.getItem('app-color');
        
        if (oldTheme && !localStorage.getItem('selectedTheme')) {
          localStorage.setItem('selectedTheme', oldTheme);
          localStorage.removeItem('app-theme');
        }
        
        if (oldColor && !localStorage.getItem('selectedColor')) {
          localStorage.setItem('selectedColor', oldColor);
          localStorage.removeItem('app-color');
        }
      })();

      // Funci√≥n para aplicar tema (sincronizada)
      function applyTheme() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'light';
        const savedColor = localStorage.getItem('selectedColor') || 'default';
        
        // Limpiar clases anteriores
        document.body.classList.remove('dark-theme');
        document.body.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-red', 'theme-pink');
        
        // Aplicar tema
        if (savedTheme === 'dark') {
          document.body.classList.add('dark-theme');
        }
        
        // Aplicar color de acento
        if (savedColor !== 'default') {
          document.body.classList.add(`theme-${savedColor}`);
        }
      }

      // Actualizar estados activos del modal
      function updateActiveStates() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'light';
        const savedColor = localStorage.getItem('selectedColor') || 'default';
        
        themeOptions.forEach(option => {
          option.classList.toggle('active', option.dataset.theme === savedTheme);
        });
        themeColors.forEach(color => {
          color.classList.toggle('active', color.dataset.color === savedColor);
        });
      }

      // Cargar tema guardado
      function loadSavedTheme() {
        applyTheme();
        updateActiveStates();
      }
      
      // Escuchar cambios en localStorage desde otras p√°ginas
      window.addEventListener('storage', function(e) {
        if (e.key === 'selectedTheme' || e.key === 'selectedColor') {
          applyTheme();
          updateActiveStates();
        }
      });

      // Abrir modal de temas
      themeBtn?.addEventListener('click', () => {
        hideSearchResults();
        themeModal.hidden = false;
      });

      // Cerrar modal de temas
      function closeThemeModal() {
        themeModal.hidden = true;
      }

      themeCloseBtn?.addEventListener('click', closeThemeModal);
      themeCloseBtnX?.addEventListener('click', closeThemeModal);
      
      // Cerrar modal al hacer clic fuera
      themeModal?.addEventListener('click', function(e) {
        if (e.target === themeModal) closeThemeModal();
      });

      // Cambiar tema (claro/oscuro)
      themeOptions.forEach(option => {
        option.addEventListener('click', () => {
          const theme = option.dataset.theme;
          
          // Guardar preferencia
          localStorage.setItem('selectedTheme', theme);
          
          // Aplicar tema
          applyTheme();
          updateActiveStates();
          
          // Disparar evento personalizado para sincronizaci√≥n
          window.dispatchEvent(new CustomEvent('themeChanged', { 
            detail: { theme, color: localStorage.getItem('selectedColor') || 'default' }
          }));
        });
      });

      // Cambiar color de acento
      themeColors.forEach(color => {
        color.addEventListener('click', () => {
          const colorName = color.dataset.color;
          
          // Guardar preferencia
          localStorage.setItem('selectedColor', colorName);
          
          // Aplicar tema
          applyTheme();
          updateActiveStates();
          
          // Disparar evento personalizado para sincronizaci√≥n
          window.dispatchEvent(new CustomEvent('themeChanged', { 
            detail: { theme: localStorage.getItem('selectedTheme') || 'light', color: colorName }
          }));
        });
      });

      // Restablecer tema
      themeResetBtn?.addEventListener('click', () => {
        localStorage.removeItem('selectedTheme');
        localStorage.removeItem('selectedColor');
        applyTheme();
        updateActiveStates();
        
        // Actualizar botones
        themeOptions.forEach(option => {
          option.classList.toggle('active', option.dataset.theme === 'light');
        });
        themeColors.forEach(color => {
          color.classList.toggle('active', color.dataset.color === 'default');
        });
      });

      // Cerrar modales con Escape o click fuera
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (!statsModal.hidden) statsModal.hidden = true;
          if (!themeModal.hidden) themeModal.hidden = true;
        }
      });

      // ===== SISTEMA DE GAMIFICACI√ìN =====
      const gamificationModal = document.getElementById('gamification-modal');
      const gamificationOpenBtn = document.getElementById('menu-gamification-open');
      const gamificationCloseBtn = document.getElementById('gamification-close');

      // Configuraci√≥n del sistema de puntos
      const POINTS_CONFIG = {
        SONG_REQUEST: 10,
        DAILY_BONUS: 5,
        STREAK_MULTIPLIER: 2,
        VIP_BONUS: 15
      };

      // Configuraci√≥n de niveles
      const LEVELS = [
        { level: 1, name: 'Novato', xpRequired: 0 },
        { level: 2, name: 'Aficionado', xpRequired: 100 },
        { level: 3, name: 'Mel√≥mano', xpRequired: 250 },
        { level: 4, name: 'Experto', xpRequired: 500 },
        { level: 5, name: 'Maestro', xpRequired: 1000 },
        { level: 6, name: 'Virtuoso', xpRequired: 2000 },
        { level: 7, name: 'Leyenda', xpRequired: 5000 }
      ];

      // Configuraci√≥n de logros
      const ACHIEVEMENTS = [
        {
          id: 'first_song',
          title: 'Primera Canci√≥n',
          description: 'Pide tu primera canci√≥n',
          icon: 'üéµ',
          points: 25,
          condition: (stats) => stats.totalSongs >= 1
        },
        {
          id: 'music_lover',
          title: 'Amante de la M√∫sica',
          description: 'Pide 10 canciones',
          icon: 'üé∂',
          points: 50,
          condition: (stats) => stats.totalSongs >= 10
        },
        {
          id: 'music_addict',
          title: 'Adicto a la M√∫sica',
          description: 'Pide 50 canciones',
          icon: 'üé∏',
          points: 100,
          condition: (stats) => stats.totalSongs >= 50
        },
        {
          id: 'music_master',
          title: 'Maestro Musical',
          description: 'Pide 100 canciones',
          icon: 'üéπ',
          points: 200,
          condition: (stats) => stats.totalSongs >= 100
        },
        {
          id: 'diverse_taste',
          title: 'Gusto Diverso',
          description: 'Pide canciones de 10 artistas diferentes',
          icon: 'üåü',
          points: 75,
          condition: (stats) => stats.uniqueArtists >= 10
        },
        {
          id: 'explorer',
          title: 'Explorador Musical',
          description: 'Pide canciones de 25 artistas diferentes',
          icon: 'üó∫Ô∏è',
          points: 150,
          condition: (stats) => stats.uniqueArtists >= 25
        },
        {
          id: 'streak_starter',
          title: 'Inicio de Racha',
          description: 'Mant√©n una racha de 3 d√≠as',
          icon: 'üî•',
          points: 50,
          condition: (stats) => stats.bestStreak >= 3
        },
        {
          id: 'streak_master',
          title: 'Maestro de Rachas',
          description: 'Mant√©n una racha de 7 d√≠as',
          icon: 'üèÜ',
          points: 100,
          condition: (stats) => stats.bestStreak >= 7
        },
        {
          id: 'streak_legend',
          title: 'Leyenda de Rachas',
          description: 'Mant√©n una racha de 30 d√≠as',
          icon: 'üëë',
          points: 300,
          condition: (stats) => stats.bestStreak >= 30
        },
        {
          id: 'daily_user',
          title: 'Usuario Diario',
          description: 'Usa la app durante 10 d√≠as diferentes',
          icon: 'üìÖ',
          points: 100,
          condition: (stats) => stats.activeDays >= 10
        },
        {
          id: 'vip_member',
          title: 'Miembro VIP',
          description: 'Convi√©rtete en usuario VIP',
          icon: 'üíé',
          points: 200,
          condition: (stats) => stats.isVip
        }
      ];

      // Funciones del sistema de gamificaci√≥n
      function getGamificationData() {
        return getGamificationDataForUser(getCurrentUser());
      }

      function saveGamificationData(data) {
        saveGamificationDataForUser(data, getCurrentUser());
      }

      function calculateUserStats() {
        return calculateUserStatsForUser(getCurrentUser());
      }

      function getCurrentUser() {
        // Intentar obtener el usuario actual de diferentes fuentes
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('user') || localStorage.getItem('currentUser') || 'Usuario';
      }

      function addPoints(points, reason = '') {
        const data = getGamificationData();
        data.points += points;
        data.xp += points;
        
        // Verificar subida de nivel
        const newLevel = calculateLevel(data.xp);
        if (newLevel > data.level) {
          data.level = newLevel;
          showLevelUpNotification(newLevel);
        }
        
        saveGamificationData(data);
        return data;
      }

      function calculateLevel(xp) {
        for (let i = LEVELS.length - 1; i >= 0; i--) {
          if (xp >= LEVELS[i].xpRequired) {
            return LEVELS[i].level;
          }
        }
        return 1;
      }

      function getLevelInfo(level) {
        return LEVELS.find(l => l.level === level) || LEVELS[0];
      }

      function getNextLevelInfo(level) {
        return LEVELS.find(l => l.level === level + 1) || LEVELS[LEVELS.length - 1];
      }

      function updateStreak() {
        const data = getGamificationData();
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        
        if (data.streaks.lastActivity === yesterday) {
          // Continuar racha
          data.streaks.current++;
        } else if (data.streaks.lastActivity !== today) {
          // Nueva racha o racha rota
          data.streaks.current = 1;
        }
        
        // Actualizar mejor racha
        if (data.streaks.current > data.streaks.best) {
          data.streaks.best = data.streaks.current;
        }
        
        data.streaks.lastActivity = today;
        data.streaks.calendar[today] = true;
        
        saveGamificationData(data);
        return data.streaks.current;
      }

      function checkAchievements() {
        const data = getGamificationData();
        const stats = calculateUserStats();
        data.stats = { ...data.stats, ...stats };
        
        const newAchievements = [];
        
        ACHIEVEMENTS.forEach(achievement => {
          if (!data.achievements.includes(achievement.id) && achievement.condition(data.stats)) {
            data.achievements.push(achievement.id);
            newAchievements.push(achievement);
            data.points += achievement.points;
            data.xp += achievement.points;
          }
        });
        
        if (newAchievements.length > 0) {
          saveGamificationData(data);
          showAchievementNotification(newAchievements);
        }
        
        return newAchievements;
      }

      function showLevelUpNotification(level) {
        const levelInfo = getLevelInfo(level);
        // Crear notificaci√≥n temporal
        const notification = document.createElement('div');
        notification.className = 'level-up-notification';
        notification.innerHTML = `
          <div class="notification-content">
            <div class="notification-icon">üéâ</div>
            <div class="notification-text">
              <strong>¬°Nivel ${level}!</strong><br>
              Ahora eres ${levelInfo.name}
            </div>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 4000);
      }

      function showAchievementNotification(achievements) {
        achievements.forEach((achievement, index) => {
          setTimeout(() => {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
              <div class="notification-content">
                <div class="notification-icon">${achievement.icon}</div>
                <div class="notification-text">
                  <strong>¬°Logro desbloqueado!</strong><br>
                  ${achievement.title} (+${achievement.points} pts)
                </div>
              </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.remove();
            }, 4000);
          }, index * 1000);
        });
      }

      function renderGamificationModal() {
        const data = getGamificationData();
        const currentLevel = getLevelInfo(data.level);
        const nextLevel = getNextLevelInfo(data.level);
        const progressPercent = ((data.xp - currentLevel.xpRequired) / (nextLevel.xpRequired - currentLevel.xpRequired)) * 100;
        
        // Actualizar informaci√≥n del usuario
        document.getElementById('user-name').textContent = getCurrentUser();
        document.getElementById('user-level-name').textContent = currentLevel.name;
        document.getElementById('user-level-number').textContent = `Nivel ${data.level}`;
        document.getElementById('user-points').textContent = data.points;
        
        // Actualizar barra de progreso
        document.getElementById('progress-fill').style.width = `${Math.min(progressPercent, 100)}%`;
        document.getElementById('current-xp').textContent = data.xp - currentLevel.xpRequired;
        document.getElementById('next-level-xp').textContent = nextLevel.xpRequired - currentLevel.xpRequired;
        
        // Renderizar logros
        renderAchievements(data);
        
        // Renderizar rachas
        renderStreaks(data);
        
        // Renderizar estad√≠sticas personales
        renderPersonalStats(data);
      }

      function renderAchievements(data) {
        const container = document.getElementById('achievements-list');
        
        container.innerHTML = ACHIEVEMENTS.map(achievement => {
          const isUnlocked = data.achievements.includes(achievement.id);
          const progress = getAchievementProgress(achievement, data.stats);
          
          return `
            <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
              <div class="achievement-points">+${achievement.points}</div>
              <div class="achievement-icon">${achievement.icon}</div>
              <div class="achievement-title">${achievement.title}</div>
              <div class="achievement-description">${achievement.description}</div>
              ${!isUnlocked && progress ? `<div class="achievement-progress">${progress}</div>` : ''}
            </div>
          `;
        }).join('');
      }

      function getAchievementProgress(achievement, stats) {
        const id = achievement.id;
        
        if (id === 'first_song' || id === 'music_lover' || id === 'music_addict' || id === 'music_master') {
          const targets = { first_song: 1, music_lover: 10, music_addict: 50, music_master: 100 };
          return `${stats.totalSongs}/${targets[id]} canciones`;
        }
        
        if (id === 'diverse_taste' || id === 'explorer') {
          const targets = { diverse_taste: 10, explorer: 25 };
          return `${stats.uniqueArtists}/${targets[id]} artistas`;
        }
        
        if (id === 'streak_starter' || id === 'streak_master' || id === 'streak_legend') {
          const targets = { streak_starter: 3, streak_master: 7, streak_legend: 30 };
          const bestStreak = getGamificationData().streaks.best;
          return `${bestStreak}/${targets[id]} d√≠as`;
        }
        
        if (id === 'daily_user') {
          return `${stats.activeDays}/10 d√≠as`;
        }
        
        return null;
      }

      function renderStreaks(data) {
        document.getElementById('current-streak').textContent = `${data.streaks.current} d√≠as`;
        document.getElementById('best-streak').textContent = `${data.streaks.best} d√≠as`;
        
        // Renderizar calendario de actividad
        renderStreakCalendar(data.streaks.calendar);
      }

      function renderStreakCalendar(calendar) {
        const container = document.getElementById('streak-calendar-grid');
        const today = new Date();
        const days = [];
        
        // Generar √∫ltimos 28 d√≠as
        for (let i = 27; i >= 0; i--) {
          const date = new Date(today.getTime() - (i * 86400000));
          const dateStr = date.toISOString().split('T')[0];
          const isToday = i === 0;
          const isActive = calendar[dateStr];
          
          days.push(`
            <div class="calendar-day ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}">
              ${date.getDate()}
            </div>
          `);
        }
        
        container.innerHTML = days.join('');
      }

      function renderPersonalStats(data) {
        const stats = data.stats;
        
        document.getElementById('personal-total-songs').textContent = stats.totalSongs;
        document.getElementById('personal-unique-artists').textContent = stats.uniqueArtists;
        document.getElementById('personal-active-days').textContent = stats.activeDays;
        
        // Calcular posici√≥n global (simulada)
        const allUsers = JSON.parse(localStorage.getItem('solicitudes') || '[]');
        const userCounts = {};
        allUsers.forEach(s => {
          userCounts[s.usuario] = (userCounts[s.usuario] || 0) + 1;
        });
        
        const sortedUsers = Object.entries(userCounts).sort((a, b) => b[1] - a[1]);
        const userRank = sortedUsers.findIndex(([user]) => user === getCurrentUser()) + 1;
        
        document.getElementById('personal-rank').textContent = userRank > 0 ? `#${userRank}` : '-';
        
        // Renderizar g√©neros favoritos (simulado)
        renderFavoriteGenres();
      }

      function renderFavoriteGenres() {
        const container = document.getElementById('favorite-genres-list');
        const genres = ['Pop', 'Rock', 'Reggaeton', 'Electr√≥nica', 'Indie'];
        
        container.innerHTML = genres.map(genre => 
          `<span class="genre-tag">${genre}</span>`
        ).join('');
      }

      // Event listeners para tabs de gamificaci√≥n
      document.querySelectorAll('.gamification-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          // Actualizar tabs activos
          document.querySelectorAll('.gamification-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.gamification-panel').forEach(p => p.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`gamification-${targetTab}`).classList.add('active');
        });
      });

      // Event listeners para modal de gamificaci√≥n
      gamificationOpenBtn?.addEventListener('click', () => {
        // Cerrar el men√∫
        closeMenu();
        hideSearchResults();
        // Inicializar con el usuario actual
        currentSelectedUser = getCurrentUser();
        renderGamificationModal().catch(console.error);
        gamificationModal.hidden = false;
      });

      // Event listener para el bot√≥n X de cerrar
      document.getElementById('gamification-close-x')?.addEventListener('click', () => {
        gamificationModal.hidden = true;
      });

      // Funci√≥n para analizar autom√°ticamente nuevos usuarios
      async function analyzeNewUsersAutomatically() {
        try {
          const allSolicitudes = await getAllCombinedSolicitudes();
          const allUsers = [...new Set(allSolicitudes
            .map(s => s.usuario)
            .filter(user => user && user.trim() !== '')
          )];
          
          // Verificar qu√© usuarios no han sido procesados autom√°ticamente
          const newUsers = [];
          for (const user of allUsers) {
            const data = getGamificationDataForUser(user);
            if (!data.autoProcessed) {
              newUsers.push(user);
            }
          }
          
          if (newUsers.length > 0) {
            console.log(`üîç Detectados ${newUsers.length} usuarios nuevos para an√°lisis autom√°tico`);
            
            for (const user of newUsers) {
              await analyzeAndGrantPointsForUser(user);
            }
            
            console.log('‚úÖ An√°lisis autom√°tico completado para usuarios nuevos');
          }
        } catch (error) {
          console.error('Error en an√°lisis autom√°tico de nuevos usuarios:', error);
        }
      }

      // Funci√≥n para analizar y otorgar puntos autom√°ticamente a un usuario
      async function analyzeAndGrantPointsForUser(username) {
        try {
          // Calcular estad√≠sticas del usuario
          const stats = await calculateUserStatsForUser(username);
          
          // Obtener datos actuales del usuario
          let data = getGamificationDataForUser(username);
          
          // Solo procesar si no ha sido procesado autom√°ticamente antes
          if (data.autoProcessed) {
            return;
          }
          
          // Calcular puntos base por canciones
          const basePoints = stats.totalSongs * POINTS_CONFIG.SONG_REQUEST;
          
          // Bonus VIP si aplica
          const vipBonus = stats.isVip ? stats.totalSongs * POINTS_CONFIG.VIP_BONUS : 0;
          
          // Calcular puntos totales
          const totalPoints = basePoints + vipBonus;
          
          // Actualizar datos del usuario
          data.points = totalPoints;
          data.xp = totalPoints;
          data.level = calculateLevel(totalPoints);
          data.stats = stats;
          data.autoProcessed = true; // Marcar como procesado autom√°ticamente
          
          // Simular racha basada en d√≠as activos (conservadora)
          if (stats.activeDays > 1) {
            data.streaks.best = Math.min(stats.activeDays, 7); // M√°ximo 7 d√≠as de racha conservadora
            data.streaks.current = 1; // Racha actual conservadora
          }
          
          // Verificar y otorgar logros
          ACHIEVEMENTS.forEach(achievement => {
            if (!data.achievements.includes(achievement.id) && achievement.condition(data.stats)) {
              data.achievements.push(achievement.id);
              data.points += achievement.points;
              data.xp += achievement.points;
            }
          });
          
          // Recalcular nivel despu√©s de logros
          data.level = calculateLevel(data.xp);
          
          // Guardar datos
          saveGamificationDataForUser(data, username);
          
          console.log(`‚úÖ Usuario ${username} procesado autom√°ticamente: ${data.points} puntos, nivel ${data.level}`);
        } catch (error) {
          console.error(`Error procesando usuario ${username}:`, error);
        }
      }

      // Funci√≥n para procesar nueva solicitud de canci√≥n
      function processNewSongRequest() {
        const streakDays = updateStreak();
        let points = POINTS_CONFIG.SONG_REQUEST;
        
        // Bonus por racha
        if (streakDays > 1) {
          points += POINTS_CONFIG.STREAK_MULTIPLIER * Math.min(streakDays - 1, 10);
        }
        
        // Bonus VIP
        const vipUsers = JSON.parse(localStorage.getItem('vipUsers') || '[]');
        if (vipUsers.includes(getCurrentUser())) {
          points += POINTS_CONFIG.VIP_BONUS;
        }
        
        addPoints(points, 'Solicitud de canci√≥n');
        checkAchievements();
      }

      // Agregar estilos para notificaciones
      const notificationStyles = document.createElement('style');
      notificationStyles.textContent = `
        .level-up-notification,
        .achievement-notification {
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
          padding: 16px 20px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          z-index: 1000;
          animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 3.7s forwards;
          max-width: 300px;
        }
        
        .achievement-notification {
          background: linear-gradient(135deg, #FF6B6B, #ee5a24);
        }
        
        .notification-content {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .notification-icon {
          font-size: 24px;
        }
        
        .notification-text {
          font-size: 14px;
          line-height: 1.3;
        }
        
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(notificationStyles);

      // Inicializar sistema de gamificaci√≥n
      async function initGamification() {
        try {
          console.log('üéÆ INICIANDO SISTEMA DE GAMIFICACI√ìN...');
          
          // Usar la funci√≥n de actualizaci√≥n forzada que es m√°s robusta
          await forceUpdateAllUsers();
          
        } catch (error) {
          console.error('Error en inicializaci√≥n autom√°tica:', error);
          // Fallback: inicializar solo el usuario actual
          try {
            const data = getGamificationData();
            if (data.points === 0 && data.level === 1) {
              const stats = calculateUserStats();
              data.stats = stats;
              
              if (stats.totalSongs > 0) {
                data.points = stats.totalSongs * POINTS_CONFIG.SONG_REQUEST;
                data.xp = data.points;
                data.level = calculateLevel(data.xp);
              }
              
              saveGamificationData(data);
              checkAchievements();
            }
            
            await populateUserSelector();
          } catch (fallbackError) {
            console.error('Error en fallback:', fallbackError);
          }
        }
      }

      // Funci√≥n para analizar y otorgar puntos autom√°ticamente a un usuario
      async function analyzeAndGrantPointsForUser(username) {
        try {
          console.log(`üîç Analizando usuario: ${username}`);
          
          // Obtener datos actuales del usuario
          let data = getGamificationDataForUser(username);
          console.log(`üìä Datos actuales de ${username}:`, data);
          
          // Si el usuario ya tiene datos procesados, no volver a procesar
          if (data.autoProcessed) {
            console.log(`‚è≠Ô∏è Usuario ${username} ya procesado, saltando...`);
            return;
          }
          
          // Calcular estad√≠sticas del usuario
          const stats = await calculateUserStatsForUser(username);
          console.log(`üìà Estad√≠sticas de ${username}:`, stats);
          
          // Calcular puntos base por canciones
          const basePoints = stats.totalSongs * POINTS_CONFIG.SONG_REQUEST;
          console.log(`üí∞ Puntos base para ${username}: ${basePoints} (${stats.totalSongs} canciones √ó ${POINTS_CONFIG.SONG_REQUEST})`);
          
          // Bonus VIP si aplica
          const vipBonus = stats.isVip ? stats.totalSongs * POINTS_CONFIG.VIP_BONUS : 0;
          
          // Calcular puntos totales
          const totalPoints = basePoints + vipBonus;
          
          // Actualizar datos del usuario
          data.points = totalPoints;
          data.xp = totalPoints;
          data.level = calculateLevel(totalPoints);
          data.stats = stats;
          data.autoProcessed = true; // Marcar como procesado autom√°ticamente
          
          // Simular racha basada en d√≠as activos (conservadora)
          if (stats.activeDays > 1) {
            data.streaks.best = Math.min(stats.activeDays, 7);
            data.streaks.current = 1;
          }
          
          // Verificar y otorgar logros autom√°ticamente
          ACHIEVEMENTS.forEach(achievement => {
            if (!data.achievements.includes(achievement.id) && achievement.condition(data.stats)) {
              data.achievements.push(achievement.id);
              data.points += achievement.points;
              data.xp += achievement.points;
            }
          });
          
          // Recalcular nivel despu√©s de logros
          data.level = calculateLevel(data.xp);
          
          // Guardar datos
          saveGamificationDataForUser(data, username);
          console.log(`üíæ Datos guardados para ${username}`);
          
          console.log(`‚úÖ Usuario ${username}: ${data.points} puntos, nivel ${data.level}, ${data.achievements.length} logros`);
          
        } catch (error) {
          console.error(`Error procesando usuario ${username}:`, error);
        }
      }

      // ===== FUNCIONES PARA SELECTOR DE USUARIO =====
      
      let currentSelectedUser = '';

      async function populateUserSelector() {
        const userSelect = document.getElementById('gamification-user-select');
        if (!userSelect) {
          console.log('‚ùå No se encontr√≥ el selector de usuarios');
          return;
        }

        try {
          console.log('üîÑ Poblando selector de usuarios...');
          
          // Obtener datos combinados de Firestore y localStorage
          const allSolicitudes = await getAllCombinedSolicitudes();
          
          // Obtener usuarios √∫nicos
          const users = [...new Set(allSolicitudes
            .map(s => s.usuario)
            .filter(user => user && user.trim() !== '')
          )];
          
          console.log(`üë• Usuarios a procesar: ${users.length}`, users);
          console.log(`üë• Usuarios para selector: ${users.length}`, users);
          
          users.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

          // Construir opciones del selector
          const options = '<option value="">Selecciona un usuario</option>' +
            users.map(user => `<option value="${user}">${user}</option>`).join('');
          
          userSelect.innerHTML = options;
          
          // Si no hay usuarios, mostrar mensaje
          if (users.length === 0) {
            userSelect.innerHTML = '<option value="">No hay usuarios disponibles</option>';
          }
        } catch (error) {
          console.error('Error al cargar usuarios:', error);
          // Fallback a localStorage si hay error
          const solicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          const users = [...new Set(solicitudes
            .map(s => s.usuario)
            .filter(user => user && user.trim() !== '')
          )];
          
          users.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
          const options = '<option value="">Selecciona un usuario</option>' +
            users.map(user => `<option value="${user}">${user}</option>`).join('');
          
          userSelect.innerHTML = options;
        }
      }

      // Funci√≥n auxiliar para obtener todos los datos combinados
      async function getAllCombinedSolicitudes() {
        // Obtener todas las solicitudes de Firestore
        console.log('üîç Obteniendo datos de Firebase...');
        const firestoreSnapshot = await db.collection('solicitudes').get();
        const firestoreSolicitudes = [];
        
        console.log(`üìä Firebase devolvi√≥ ${firestoreSnapshot.size} documentos`);
        
        firestoreSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.usuario && data.cancion && data.artista) {
            firestoreSolicitudes.push({
              usuario: data.usuario,
              cancion: data.cancion,
              artista: data.artista,
              day: data.day,
              ts: data.ts ? data.ts.toMillis() : Date.now()
            });
          }
        });
        
        console.log(`‚úÖ Procesadas ${firestoreSolicitudes.length} solicitudes v√°lidas de Firebase`);
        
        // Obtener solicitudes de localStorage como respaldo
        const localSolicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
        const byDay = JSON.parse(localStorage.getItem('solicitudes_by_day') || '{}');
        
        // Combinar datos de Firestore y localStorage, evitando duplicados
        const allSolicitudesMap = new Map();
        
        // Agregar solicitudes de Firestore
        firestoreSolicitudes.forEach(s => {
          const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.ts}`;
          allSolicitudesMap.set(key, s);
        });
        
        // Agregar solicitudes de localStorage que no est√©n en Firestore
        localSolicitudes.forEach(s => {
          const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.time}`;
          if (!allSolicitudesMap.has(key)) {
            allSolicitudesMap.set(key, {
              usuario: s.usuario,
              cancion: s.cancion,
              artista: s.artista,
              ts: s.time
            });
          }
        });
        
        // Agregar solicitudes de byDay que no est√©n incluidas
        Object.values(byDay).flat().forEach(s => {
          const key = `${s.usuario}-${s.cancion}-${s.artista}-${s.time}`;
          if (!allSolicitudesMap.has(key)) {
            allSolicitudesMap.set(key, {
              usuario: s.usuario,
              cancion: s.cancion,
              artista: s.artista,
              ts: s.time
            });
          }
        });
        
        const finalResult = Array.from(allSolicitudesMap.values());
        console.log(`üéØ Total final: ${finalResult.length} solicitudes combinadas`);
        
        // Mostrar usuarios √∫nicos encontrados
        const uniqueUsers = [...new Set(finalResult.map(s => s.usuario))];
        console.log(`üë• Usuarios √∫nicos encontrados: ${uniqueUsers.length}`, uniqueUsers);
        
        return finalResult;
      }

      async function switchToUser(username) {
        console.log(`üîÑ Cambiando a usuario: ${username || 'usuario actual'}`);
        
        if (!username) {
          currentSelectedUser = getCurrentUser();
          username = currentSelectedUser;
        } else {
          currentSelectedUser = username;
        }
        
        // Siempre forzar actualizaci√≥n de datos para el usuario seleccionado
        console.log(`‚ö° Forzando actualizaci√≥n de datos para usuario: ${username}`);
        
        // Limpiar flag autoProcessed para forzar rec√°lculo
        const allData = JSON.parse(localStorage.getItem('gamificationData') || '{}');
        if (allData[username.toLowerCase()]) {
          delete allData[username.toLowerCase()].autoProcessed;
          localStorage.setItem('gamificationData', JSON.stringify(allData));
        }
        
        // Procesar usuario con datos actualizados
        await analyzeAndGrantPointsForUser(username);
        
        await renderGamificationModal();
        console.log(`‚úÖ Modal actualizado para usuario: ${currentSelectedUser}`);
      }

      function getCurrentSelectedUser() {
        return currentSelectedUser || getCurrentUser();
      }

      // Modificar funciones existentes para usar el usuario seleccionado
      function getGamificationDataForUser(usuario = null) {
        const targetUser = usuario || getCurrentSelectedUser();
        const data = localStorage.getItem('gamificationData');
        const allData = data ? JSON.parse(data) : {};
        
        console.log(`üìñ Recuperando datos para ${targetUser} de localStorage`);
        const userData = allData[targetUser.toLowerCase()];
        console.log(`üìä Datos encontrados para ${targetUser}:`, userData);
        
        return userData || {
          points: 0,
          level: 1,
          xp: 0,
          achievements: [],
          streaks: {
            current: 0,
            best: 0,
            lastActivity: null,
            calendar: {}
          },
          stats: {
            totalSongs: 0,
            uniqueArtists: 0,
            activeDays: 0,
            isVip: false
          }
        };
      }

      function saveGamificationDataForUser(data, usuario = null) {
        const targetUser = usuario || getCurrentSelectedUser();
        const allDataStr = localStorage.getItem('gamificationData');
        const allData = allDataStr ? JSON.parse(allDataStr) : {};
        
        console.log(`üíæ Guardando datos para ${targetUser}:`, data);
        
        allData[targetUser.toLowerCase()] = data;
        localStorage.setItem('gamificationData', JSON.stringify(allData));
        
        console.log(`‚úÖ Datos guardados en localStorage para ${targetUser}`);
      }

      async function calculateUserStatsForUser(usuario = null) {
        const targetUser = usuario || getCurrentSelectedUser();
        
        try {
          // Obtener datos combinados de Firebase y localStorage
          const allSolicitudes = await getAllCombinedSolicitudes();
          const vipUsers = JSON.parse(localStorage.getItem('vipUsers') || '[]');
          
          const userSongs = allSolicitudes.filter(s => s.usuario === targetUser);
          const uniqueArtists = [...new Set(userSongs.map(s => s.artista))].length;
          
          // Calcular d√≠as √∫nicos basado en fechas de solicitudes
          const uniqueDays = [...new Set(userSongs.map(s => {
            if (s.ts) {
              return new Date(s.ts).toISOString().split('T')[0];
            }
            return new Date().toISOString().split('T')[0];
          }))].length;
          
          const isVip = vipUsers.includes(targetUser);

          return {
            totalSongs: userSongs.length,
            uniqueArtists,
            activeDays: uniqueDays,
            isVip
          };
        } catch (error) {
          console.error('Error al calcular estad√≠sticas del usuario:', error);
          // Fallback a localStorage
          const solicitudes = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          const vipUsers = JSON.parse(localStorage.getItem('vipUsers') || '[]');
          
          const userSongs = solicitudes.filter(s => s.usuario === targetUser);
          const uniqueArtists = [...new Set(userSongs.map(s => s.artista))].length;
          
          const uniqueDays = [...new Set(userSongs.map(s => {
            if (s.time) {
              return new Date(s.time).toISOString().split('T')[0];
            }
            return new Date().toISOString().split('T')[0];
          }))].length;
          
          const isVip = vipUsers.includes(targetUser);

          return {
            totalSongs: userSongs.length,
            uniqueArtists,
            activeDays: uniqueDays,
            isVip
          };
        }
      }



      // Modificar renderGamificationModal para usar el usuario seleccionado
      async function renderGamificationModal() {
        const targetUser = getCurrentSelectedUser();
        
        // Asegurar que los datos est√©n actualizados antes de renderizar
        console.log(`üîÑ Asegurando datos actualizados para: ${targetUser}`);
        
        // Limpiar flag autoProcessed para forzar rec√°lculo si es necesario
        const allData = JSON.parse(localStorage.getItem('gamificationData') || '{}');
        const userData = allData[targetUser.toLowerCase()];
        
        // Si no hay datos o est√°n desactualizados, forzar actualizaci√≥n
        if (!userData || !userData.autoProcessed) {
          console.log(`‚ö° Actualizando datos para: ${targetUser}`);
          await analyzeAndGrantPointsForUser(targetUser);
        }
        
        const data = getGamificationDataForUser(targetUser);
        const currentLevel = getLevelInfo(data.level);
        const nextLevel = getNextLevelInfo(data.level);
        const progressPercent = ((data.xp - currentLevel.xpRequired) / (nextLevel.xpRequired - currentLevel.xpRequired)) * 100;
        
        // Actualizar informaci√≥n del usuario
        document.getElementById('user-name').textContent = targetUser;
        document.getElementById('user-level-name').textContent = currentLevel.name;
        document.getElementById('user-level-number').textContent = `Nivel ${data.level}`;
        document.getElementById('user-points').textContent = data.points;
        
        // Actualizar barra de progreso
        document.getElementById('progress-fill').style.width = `${Math.min(progressPercent, 100)}%`;
        document.getElementById('current-xp').textContent = data.xp - currentLevel.xpRequired;
        document.getElementById('next-level-xp').textContent = nextLevel.xpRequired - currentLevel.xpRequired;
        
        // Renderizar logros
        renderAchievementsForUser(data);
        
        // Renderizar rachas
        renderStreaksForUser(data);
        
        // Renderizar estad√≠sticas personales
        await renderPersonalStatsForUser(data);
        
        // Actualizar selector de usuario
        populateUserSelector().then(() => {
          const userSelect = document.getElementById('gamification-user-select');
          if (userSelect && targetUser !== getCurrentUser()) {
            userSelect.value = targetUser;
          }
        }).catch(console.error);
      }

      function renderAchievementsForUser(data) {
        const container = document.getElementById('achievements-list');
        
        container.innerHTML = ACHIEVEMENTS.map(achievement => {
          const isUnlocked = data.achievements.includes(achievement.id);
          const progress = getAchievementProgressForUser(achievement, data.stats);
          
          return `
            <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
              <div class="achievement-points">+${achievement.points}</div>
              <div class="achievement-icon">${achievement.icon}</div>
              <div class="achievement-title">${achievement.title}</div>
              <div class="achievement-description">${achievement.description}</div>
              ${!isUnlocked && progress ? `<div class="achievement-progress">${progress}</div>` : ''}
            </div>
          `;
        }).join('');
      }

      function getAchievementProgressForUser(achievement, stats) {
        const id = achievement.id;
        
        if (id === 'first_song' || id === 'music_lover' || id === 'music_addict' || id === 'music_master') {
          const targets = { first_song: 1, music_lover: 10, music_addict: 50, music_master: 100 };
          return `${stats.totalSongs}/${targets[id]} canciones`;
        }
        
        if (id === 'diverse_taste' || id === 'explorer') {
          const targets = { diverse_taste: 10, explorer: 25 };
          return `${stats.uniqueArtists}/${targets[id]} artistas`;
        }
        
        if (id === 'streak_starter' || id === 'streak_master' || id === 'streak_legend') {
          const targets = { streak_starter: 3, streak_master: 7, streak_legend: 30 };
          const bestStreak = getGamificationDataForUser().streaks.best;
          return `${bestStreak}/${targets[id]} d√≠as`;
        }
        
        if (id === 'daily_user') {
          return `${stats.activeDays}/10 d√≠as`;
        }
        
        return null;
      }

      function renderStreaksForUser(data) {
        document.getElementById('current-streak').textContent = `${data.streaks.current} d√≠as`;
        document.getElementById('best-streak').textContent = `${data.streaks.best} d√≠as`;
        
        // Renderizar calendario de actividad
        renderStreakCalendarForUser(data.streaks.calendar);
      }

      function renderStreakCalendarForUser(calendar) {
        const container = document.getElementById('streak-calendar-grid');
        const today = new Date();
        const days = [];
        
        // Generar √∫ltimos 28 d√≠as
        for (let i = 27; i >= 0; i--) {
          const date = new Date(today.getTime() - (i * 86400000));
          const dateStr = date.toISOString().split('T')[0];
          const isToday = i === 0;
          const isActive = calendar[dateStr];
          
          days.push(`
            <div class="calendar-day ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}">
              ${date.getDate()}
            </div>
          `);
        }
        
        container.innerHTML = days.join('');
      }

      async function renderPersonalStatsForUser(data) {
        const stats = data.stats;
        
        document.getElementById('personal-total-songs').textContent = stats.totalSongs;
        document.getElementById('personal-unique-artists').textContent = stats.uniqueArtists;
        document.getElementById('personal-active-days').textContent = stats.activeDays;
        
        try {
          // Calcular posici√≥n global usando datos combinados
          const allSolicitudes = await getAllCombinedSolicitudes();
          const userCounts = {};
          allSolicitudes.forEach(s => {
            userCounts[s.usuario] = (userCounts[s.usuario] || 0) + 1;
          });
          
          const sortedUsers = Object.entries(userCounts).sort((a, b) => b[1] - a[1]);
          const userRank = sortedUsers.findIndex(([user]) => user === getCurrentSelectedUser()) + 1;
          
          document.getElementById('personal-rank').textContent = userRank > 0 ? `#${userRank}` : '-';
        } catch (error) {
          console.error('Error calculando ranking:', error);
          // Fallback a localStorage
          const allUsers = JSON.parse(localStorage.getItem('solicitudes') || '[]');
          const userCounts = {};
          allUsers.forEach(s => {
            userCounts[s.usuario] = (userCounts[s.usuario] || 0) + 1;
          });
          
          const sortedUsers = Object.entries(userCounts).sort((a, b) => b[1] - a[1]);
          const userRank = sortedUsers.findIndex(([user]) => user === getCurrentSelectedUser()) + 1;
          
          document.getElementById('personal-rank').textContent = userRank > 0 ? `#${userRank}` : '-';
        }
        
        // Renderizar g√©neros favoritos (simulado)
        renderFavoriteGenresForUser();
      }

      function renderFavoriteGenresForUser() {
        const container = document.getElementById('favorite-genres-list');
        const genres = ['Pop', 'Rock', 'Reggaeton', 'Electr√≥nica', 'Indie'];
        
        container.innerHTML = genres.map(genre => 
          `<span class="genre-tag">${genre}</span>`
        ).join('');
      }

      // Event listeners para el selector de usuario
      document.getElementById('gamification-user-select')?.addEventListener('change', async (e) => {
        const userSelect = document.getElementById('gamification-user-select');
        const backBtn = document.getElementById('back-to-my-profile');
        
        await switchToUser(e.target.value);
        
        // Si se selecciona un usuario diferente al actual, ocultar selector y mostrar bot√≥n "Cambiar Usuario"
        if (e.target.value && e.target.value !== getCurrentUser()) {
          if (userSelect) {
            userSelect.style.display = 'none';
          }
          if (backBtn) {
            backBtn.style.display = 'inline-block';
          }
        } else {
          // Mostrar selector y ocultar bot√≥n si se escoge el usuario actual o se limpia la selecci√≥n
          if (userSelect) {
            userSelect.style.display = 'block';
          }
          if (backBtn) {
            backBtn.style.display = 'none';
          }
        }
      });

      document.getElementById('back-to-my-profile')?.addEventListener('click', async () => {
        const userSelect = document.getElementById('gamification-user-select');
        const backBtn = document.getElementById('back-to-my-profile');
        
        // Mostrar el selector de nuevo
        if (userSelect) {
          userSelect.style.display = 'block';
          userSelect.value = ''; // Resetear selecci√≥n
        }
        
        // Ocultar bot√≥n "Cambiar Usuario"
        if (backBtn) {
          backBtn.style.display = 'none';
        }
        
        // Volver al usuario actual
        await switchToUser('');
      });

      // Inicializar al cargar la p√°gina
      initGamification().catch(console.error);

      // Funci√≥n para forzar actualizaci√≥n de todos los usuarios
      async function forceUpdateAllUsers() {
        try {
          console.log('üöÄ INICIANDO ACTUALIZACI√ìN FORZADA DE TODOS LOS USUARIOS...');
          
          // Obtener todos los usuarios √∫nicos de Firebase
          const allSolicitudes = await getAllCombinedSolicitudes();
          const users = [...new Set(allSolicitudes
            .map(s => s.usuario)
            .filter(user => user && user.trim() !== '')
          )];
          
          console.log(`üìä Encontrados ${users.length} usuarios √∫nicos`);
          
          // Limpiar datos de gamificaci√≥n para forzar rec√°lculo
          const allData = JSON.parse(localStorage.getItem('gamificationData') || '{}');
          
          // Procesar cada usuario
          for (const username of users) {
            // Marcar como no procesado para forzar rec√°lculo
            if (allData[username.toLowerCase()]) {
              delete allData[username.toLowerCase()].autoProcessed;
            }
            
            await analyzeAndGrantPointsForUser(username);
          }
          
          console.log('‚úÖ Actualizaci√≥n completa de usuarios terminada');
          
          // Actualizar el modal si est√° abierto
          if (!gamificationModal.hidden) {
            await renderGamificationModal();
            await populateUserSelector();
          }
          
        } catch (error) {
          console.error('‚ùå Error en actualizaci√≥n forzada:', error);
        }
      }

      // An√°lisis peri√≥dico cada 5 minutos
      setInterval(() => {
        analyzeNewUsersAutomatically().catch(console.error);
      }, 5 * 60 * 1000); // 5 minutos

      [statsModal, themeModal, gamificationModal].forEach(modal => {
        modal?.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.hidden = true;
          }
        });
      });

      // Cargar tema al iniciar
      loadSavedTheme();
      
      console.log('‚úÖ Script de gamificaci√≥n cargado completamente');
    })();
  </script>
</body>
</html>
